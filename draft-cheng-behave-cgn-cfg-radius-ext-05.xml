<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC2119 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC1918 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.1918.xml">
<!ENTITY RFC2865 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2865.xml">
<!ENTITY RFC6269 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6269.xml">
<!ENTITY RFC6333 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6333.xml">
<!ENTITY RFC5176 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5176.xml">
<!ENTITY RFC6146 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6146.xml">
<!ENTITY RFC6158 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6158.xml">
<!ENTITY RFC5226 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5226.xml">
<!ENTITY I-D.ietf-behave-lsn-requirements PUBLIC "" "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-behave-lsn-requirements.xml">
<!ENTITY I-D.ietf-pcp-base PUBLIC "" "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-pcp-base.xml">
<!ENTITY I-D.miles-behave-l2nat PUBLIC "" "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.miles-behave-l2nat.xml">
<!ENTITY I-D.arkko-dual-stack-extra-lite PUBLIC "" "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.arkko-dual-stack-extra-lite.xml">
]>
<?rfc toc="yes"?>
<?rfc tocompact="yes"?>
<?rfc tocdepth="3"?>
<?rfc tocindent="yes"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes"?>
<?rfc comments="yes"?>
<?rfc inline="yes"?>
<?rfc compact="yes"?>
<?rfc subcompact="no"?>
<rfc category="std" docName="draft-cheng-behave-cgn-cfg-radius-ext-05"
     ipr="trust200902">
  <front>
    <title abbrev="Radius Extensions for CGN">RADIUS Extensions for Port Set
    Configuration and Reporting</title>

    <author fullname="Dean Cheng" initials="D." surname="Cheng">
      <organization>Huawei Technologies</organization>

      <address>
        <postal>
          <street>2330 Central Expressway</street>

          <city>Santa Clara</city>

          <region>California</region>

          <code>95050</code>

          <country>USA</country>
        </postal>

        <email>dean.cheng@huawei.com</email>
      </address>
    </author>

    <author fullname="Jouni Korhonen" initials="J." surname="Korhonen">
      <organization>Nokia Siemens Networks</organization>

      <address>
        <postal>
          <street>Linnoitustie 6</street>

          <city>Espoo</city>

          <code>FIN-02600</code>

          <country>Finland</country>
        </postal>

        <email>jouni.nospam@gmail.com</email>
      </address>
    </author>

    <author fullname="Mohamed Boucadair" initials="M." surname="Boucadair">
      <organization>France Telecom</organization>

      <address>
        <postal>
          <street></street>

          <city>Rennes</city>

          <country>France</country>
        </postal>

        <email>mohamed.boucadair@orange.com</email>
      </address>
    </author>

    <author fullname="Senthil Sivakumar" initials="S." surname="Sivakumar">
      <organization>Cisco Systems</organization>

      <address>
        <postal>
          <street>7100-8 Kit Creek Road</street>

          <city>Research Triangle Park</city>
          <region>North Carolina</region>
          <country>USA</country>
        </postal>

        <email>ssenthil@cisco.com</email>
      </address>
    </author>

    <date year="2013" />

    <abstract>
      <t>This document defines new RADIUS attributes that can be used by a
      device implementing port ranges to communicate with a RADIUS server to
      configure and/or report TCP/UDP port sets and ICMP identifiers mapping
      behavior for specific hosts. This mechanism can be used in various
      deployment scenarios such as CGN, NAT64, Provider WiFi Gateway, etc.
      </t>

      <t>This document does not make any assumption about the deployment
      context. </t>
    </abstract>

    <note title="Requirements Language">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <xref
      target="RFC2119">RFC 2119</xref>.</t>
    </note>
  </front>

  <middle>
    <section title="Introduction">
      <t>In a broadband network, customer information is usually stored on a
      RADIUS server <xref target="RFC2865"></xref> and at the time when a user
      initiates an IP connection request, the RADIUS server will populate the
      user's configuration information to the Network Access Server (NAS),
      which is usually co-located with the Border Network Gateway (BNG), after
      the connection request is granted. The Carrier Grade NAT (CGN) function
      may also implemented on the BNG, and therefore CGN TCP/UDP port (or ICMP
      identifier) mapping behavior can be configured on the RADIUS server as
      part of the user profile, and populated to the NAS in the same manner.
      In addition, during the operation, the CGN can also convey
      port/identifier mapping behavior specific to a user to the RADIUS
      server, as part of the normal RADIUS accounting process. </t>

      <t>The CGN device that communicates with a RADIUS server using RADIUS
      extensions defined in this document may perform NAT44 <xref
      target="RFC3022"></xref>, NAT64 <xref target="RFC6146"></xref>, or
      Dual-Stack Lite AFTR <xref target="RFC6333"> </xref> function.</t>

      <t>For the CGN example, when IP packets traverse a CGN, it would perform
      TCP/UDP source port mapping or ICMP identifier mapping as required. A
      TCP/ UDP source port or ICMP identifier, along with source IP address,
      destination IP address, destination port and protocol identifier if
      applicable, uniquely identify a session. Since the number space of
      TCP/UDP ports and ICMP identifiers in CGN's external realm is shared
      among multiple users assigned with the same IPv4 address, the total
      number of a user's simultaneous IP sessions is likely to subject to port
      quota. </t>

      <t>The attributes defined in this document may also be used to report
      the assigned port set in some deployment such as Provider WiFi <xref
      target="I-D.gundavelli-v6ops-community-wifi-svcs"></xref>. For example,
      a visiting host can be managed by a CPE which will need to report the
      assigned port set to the service platform. This is required for
      identification purposes (see WT-146 for example).</t>

      <t>This document proposes three new RADIUS attributes as RADIUS
      protocol's extensions, and they are used for separate purposes as
      follows: </t>

      <t><list style="symbols">
          <t>A session limit is configured on a RADIUS server based on service
          agreement with a subscriber, and this parameter imposes the limit of
          total number of TCP/UDP ports and/or ICMP identifiers that the
          subscriber can use. Alternately, a separate session limit may be
          configured to limit the number of TCP ports, UDP ports, or the sum
          of the two, and ICMP identifiers, respectively, that the user can
          use. The session limit is carried by a new RADIUS attribute
          Port-Session-Limit, which is included in a RADIUS Access-Accept
          message sent by the RADIUS server to port-based device. This new
          RADIUS attribute can also be included in a RADIUS CoA message sent
          by the RADIUS server to the port-based device in order to change the
          session limit previously configured. </t>

          <t>A port-based device may allocate or de-allocate a set of TCP/UDP
          ports or ICMP identifiers for a specific subscriber. When it does
          so, the associated session range along with the shared IPv4 address
          can be conveyed to the RADIUS server as part of the accounting
          process. These parameters are carried by a new RADIUS attribute
          Port-Session-Range, which is included in a RADIUS Accounting-
          Request message sent by the port-based device to the RADIUS server.
          </t>

          <t>A user may require the port-based device to perform port
          forwarding function, i.e., a port mapping is pre-configured on the
          port-based so that inbound IP packets sent by some applications from
          the port-based external realm can pass through that device and reach
          the user. The port mapping information includes the port-based
          device internal port, external port, and may also include the
          associated internal IPv4 or IPv6 address, and is carried by a new
          RADIUS attribute Port- Forwarding-Map, which is included in a RADIUS
          Access-Accept message sent by the RADIUS server to the port-based
          device. This new RADIUS attribute can also be included in a RADIUS
          CoA message sent by the RADIUS server to the port-based device in
          order to change the forwarding port mapping previously configured.
          </t>
        </list></t>
    </section>

    <section title="Terminology">
      <t>Some terms that are used in this document are listed as follows:
      <list style="symbols">
          <t>Session Limit - This is the maximum number of TCP ports, or UDP
          ports, or the total of the two, or ICMP identifiers, or the total of
          the three, that a device supporting port ranges can use when
          performing mapping on TCP/ UDP ports or ICMP identifiers for a
          specific user. </t>

          <t>Session Range - This specifies a set of TCP/UDP port numbers or
          ICMP identifiers, indicated by the port/identifier with the smallest
          numerical number and the port/identifier with the largest numerical
          number, inclusively.</t>

          <t>Internal IP Address - The IP address that is used as a source IP
          address in an outbound IP packet sent toward a device supporting
          port ranges in the internal realm. In IPv4 case, it is typically a
          private address <xref target="RFC1918"></xref>.</t>

          <t>External IP Address - The IP address that is used as a source IP
          address in an outbound IP packet after traversing a device
          supporting port ranges in the external realm. In IPv4 case, it is
          typically a global and routable IP address. </t>

          <t>Internal Port - The internal port is a UDP or TCP port, or an
          ICMP identifier, which is allocated by a host or application behind
          a device supporting port ranges for an outbound IP packet in the
          internal realm.</t>

          <t>External Port - The external port is a UDP or TCP port, or an
          ICMP identifier, which is allocated by a device supporting port
          ranges upon receiving an outbound IP packet in the internal realm,
          and is used to replace the internal port that is allocated by a user
          or application. </t>

          <t>External realm - The networking segment where IPv4 public
          addresses are used in respective of the device supporting port
          ranges. </t>

          <t>Internal realm - The networking segment that is behind a device
          supporting port ranges and where IPv4 private addresses are used.
          </t>

          <t>Mapping - This term in this document associates with a device
          supporting port ranges for a relationship between an internal IP
          address, internal port and the protocol, and an external IP address,
          external port, and the protocol. </t>

          
          <t>Port-based device - A device that is capable of 
             providing IP address and TCP/UDP port mapping
             services and in particular, with the granularity
             of one or more subsets within the 16-bit TCP/UDP
             port number range. A typical example of this device
             can be a CGN, CPE, Provider WiF Gateway, etc.</t>
        </list></t>

      <t>Note the terms "internal IP address", "internal port", "internal
      realm", "external IP address", "external port", "external realm", and
      "mapping" and their semantics are the same as in <xref
      target="I-D.ietf-pcp-base"> </xref>, and <xref
      target="I-D.ietf-behave-lsn-requirements"></xref>.</t>
    </section>

    <section anchor="attrs" title="RADIUS Attributes">
      <t><list>
          <t>[Discussion: should these attributes be allocated from the
          extended RADIUS attribute code space?]</t>

          <t>[Discussion: Should we define a dedicated attribute
          (port_set_policies) to configure the following policies: (1) enforce
          port randomization, (2) include/exclude the WKP in the port
          assignment, (3) preserve parity, (4) quota for explicit port
          mapping, (5) DSCP marking policy, (6) Port hold down timer, (7) port
          hold down pool, etc. Perhaps we don't need to cover all these
          parameters.]</t>
        </list></t>

      <section anchor="sessionlimit" title="Port-Session-Limit Attribute">
        <t>This attribute is of type complex <xref target="RFC6158"></xref>
        and specifies the limit of TCP ports, or UDP ports, or the sum of the
        two, or ICMP identifiers, or the sum of the three, which is configured
        on a device supporting port ranges corresponding to a specific
        subscriber.</t>

        <t>The Port-Session-Limit MAY appear in an Access-Accept packet, it
        MAY also appear in an Access-Request packet as a hint by the device
        supporting port ranges, which is co-allocated with the NAS, to the
        RADIUS server as a preference, although the server is not required to
        honor such a hint.</t>

        <t>The Port-Session-Limit MAY appear in an CoA-Request packet.</t>

        <t>The Port-Session-Limit MAY appear in an Accounting-Request
        packet.</t>

        <t>The Port-Session-Limit MUST NOT appear in any other RADIUS
        packets.</t>

        <t>The format of the Port-Session-Limit RADIUS attribute format is
        shown below. The fields are transmitted from left to right.</t>

        <figure>
          <preamble></preamble>

          <artwork><![CDATA[    
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Type     |     Length    |      ST       |    Session     
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      Limit     |  
+-+-+-+-+-+-+-+-+
      ]]></artwork>

          <postamble></postamble>
        </figure>

        <t>Type:</t>

        <t><list counter="1" hangIndent="5">
            <t>TBA1 for Port-Session-Limit.</t>
          </list>Length: <list counter="1" hangIndent="5">
            <t>5 octets. This field indicates the total length in octets of
            this attribute including the Type and the Length field.</t>
          </list></t>

        <t>ST (Session Type):<list counter="1" hangIndent="5">
            <t>This one octet field contains an enumerated value that
            indicates the applicability of the Session Limit as follows:</t>

            <t>0:<list counter="1" hangIndent="5">
                <t>The limit as specified is applied to each transport
                protocol (TCP/UDP) and ICMP Identifiers as a whole.</t>
              </list></t>

            <t>1:<list counter="1" hangIndent="5">
                <t>The limit as specified is applied to TCP and UDP ports.</t>
              </list></t>

            <t>2:<list counter="1" hangIndent="5">
                <t>The limit as specified is applied to TCP ports.</t>
              </list></t>

            <t>3:<list counter="1" hangIndent="5">
                <t>The limit as specified is applied to UDP ports.</t>
              </list></t>

            <t>4:<list counter="1" hangIndent="5">
                <t>The limit as specified is applied to ICMP Identifiers.</t>
              </list></t>

            <t>5-255:<list counter="1" hangIndent="5">
                <t>These values are undefined.</t>
              </list></t>
          </list></t>

        <t>Session Limit:<list counter="1" hangIndent="5">
            <t>This field contains the maximum number that is assigned to the
            transport sessions depending on the value in the Session Type (ST)
            field, that the specific user can use.</t>
          </list></t>
      </section>

      <section anchor="sessionrange" title="Port-Session-Range Attribute">
        <t>This attribute is of type complex <xref target="RFC6158"></xref>
        and contains a range of numbers for TCP ports or UDP ports, or both,
        or for ICMP Identifiers, which has been allocated or de-allocated by a
        device supporting port ranges for a given subscriber, along with an
        external IPv4 address that is associated with any TCP/UDP port or ICMP
        identifier in the range.</t>

        <t>In some CGN deployment scenarios as described such as L2NAT <xref
        target="I-D.miles-behave-l2nat"></xref> and DS-Extra-Lite <xref
        target="I-D.arkko-dual-stack-extra-lite"></xref>, parameters at a
        customer premise such as MAC address, interface ID, VLAN ID, PPP
        session ID, IPv6 prefix, VRF ID, etc., may also be required to pass to
        the RADIUS server as part of the accounting record.</t>

        <t>The Port-Session-Range MAY appear in an Accounting-Request
        packet.</t>

        <t>The Port-Session-Range MUST NOT appear in any other RADIUS
        packets.</t>

        <t>The port range follows the encoding specified in <xref
        target="RFC6431"></xref>; as such both contiguous and non-contiguous
        port sets are supported.</t>

        <t>The format of the Port-Session-Range RADIUS attribute format is
        shown below. The fields are transmitted from left to right.</t>

        <figure>
          <preamble></preamble>

          <artwork><![CDATA[ 
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Type     |     Length    |       ST      |A| Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Port Range Mask          |      Port Range Value         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     External IPv4 Address                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       Local Session ID ....                    
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--
]]></artwork>

          <postamble></postamble>
        </figure>

        <t>Type:</t>

        <t><list counter="1" hangIndent="5">
            <t>TBA2 for Port-Session-Range.</t>
          </list>Length: <list counter="1" hangIndent="5">
            <t>12 octets plus the length of optional field Local Session ID.
            This field indicates the total length in octets of this attribute
            including the Type and the Length field.</t>
          </list></t>

        <t>ST (Session Type):<list counter="1" hangIndent="5">
            <t>This one octet field contains an enumerated value that
            indicates the semantics of the session range. The values follow
            the Session Type encoding defined in <xref
            target="sessionlimit"></xref> except that the following values are
            not valid in scope of this attribute:</t>

            <t>0:<list counter="1" hangIndent="5">
                <t>The limit as specified is applied to the sum of TCP ports,
                UDP ports, and ICMP Identifiers as a whole.</t>
              </list></t>
          </list></t>

        <t>A-bit Flag:<list counter="1" hangIndent="5">
            <t>This field is set to 0 or 1, indicates that the session range
            has been allocated or de-allocated, respectively, by the device
            supporting port ranges.</t>
          </list></t>

        <t>Reserved:<list counter="1" hangIndent="5">
            <t>This field MUST be set to zero by the sender and ignored by the
            receiver.</t>
          </list></t>

        <t>Port Range Mask:<list counter="1" hangIndent="5">
            <t>The Port Range Mask indicates the position of the bits that are
            used to build the Port Range Value. By default, no PRM value is
            assigned. The 1 values in the Port Range Mask indicate by their
            position the significant bits of the Port Range Value. Refer to
            <xref target="RFC6431"></xref> for more details.</t>
          </list></t>

        <t>Port Range Value:<list counter="1" hangIndent="5">
            <t>The PRV indicates the value of the significant bits of the Port
            Mask. By default, no PRV is assigned. Refer to <xref
            target="RFC6431"></xref> for more details.</t>
          </list></t>

        <t>External IPv4 Address:<list counter="1" hangIndent="5">
            <t>This is an optional field. If present, this field contains the
            IPv4 address assigned to the associated subscriber to be used in
            the external realm. If set to 0/0, the allocation address policy
            is local to the device supporting port ranges.</t>
          </list></t>

        <t>Local Session ID:<list counter="1" hangIndent="5">
            <t>This is an optional field and if presents, it contains a local
            session identifier at the customer premise, such as MAC address,
            interface ID, VLAN ID, PPP sessions ID, VRF ID, IPv6
            address/prefix, etc. The length of this field equals to the total
            attribute length minus 12 octets. If this field is not present,
            the port range policies must be enforced to all subscribers using
            a local subscriber identifier.</t>
          </list></t>
      </section>

      <section anchor="portmap" title="Port-Forwarding-Map Attribute">
        <t>This attribute is type of complex <xref target="RFC6158"></xref>
        and contains a 16-bit Internal Port that identifies the source TCP/UDP
        port number of an IP packet sent by the user, or the destination port
        number of an IP packet destined to the user, and in both cases, the IP
        packet travels behind the NAT device. Also they contain a 16-bit
        Configured External Port that identifies the source TCP/UDP port
        number of an IP packet sent by the user, or the destination port
        number of an IP packet destined to the user, and in both cases, the IP
        packet travels outside of the NAT device. In addition, the attribute
        may contain a 32-bit IPv4 address or a 128-bit IPv6 address,
        respectively, as their respective NAT mappings internal IP address.
        Together, the port pair and IP address determine the port mapping rule
        for a specific IP flow that traverses a NAT device.</t>

        <t>The attribute MAY appear in an Access-Accept packet, and may also
        appear in an Accounting-Request packet. In either case, the attribute
        MUST NOT appear more than once in a single packet.</t>

        <t>The attribute MUST NOT appear in any other RADIUS packets.</t>

        <t>The format of the Port-Forwarding-Map RADIUS attribute format is
        shown below. The fields are transmitted from left to right.</t>

        <figure>
          <preamble></preamble>

          <artwork><![CDATA[         
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Type     |     Length    |      AF       |   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Internal Port         |    Configured External Port   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       Internal IP Address  .....
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>

          <postamble></postamble>
        </figure>

        <t>Type:</t>

        <t><list counter="1" hangIndent="5">
            <t>TBA3 for Port-Forwarding-Map.</t>
          </list>Length: <list counter="1" hangIndent="5">
            <t>This field indicates the total length in octets of this
            attribute including the Type and the Length field. Depending on
            the value of the AF field, the length could be 8, 12 or 24
            octets.</t>
          </list></t>

        <t>AF (Address Family):<list counter="1" hangIndent="5">
            <t>This one octet field contains a value that indicates address
            family of the internal IP address at the mapping as follows:</t>

            <t>0:<list counter="1" hangIndent="5">
                <t>There is no internal address attached.</t>
              </list></t>

            <t>1:<list counter="1" hangIndent="5">
                <t>The internal address is an IPv4 address.</t>
              </list></t>

            <t>2:<list counter="1" hangIndent="5">
                <t>The internal address is an IPv6 address.</t>
              </list></t>

            <t>3-255:<list counter="1" hangIndent="5">
                <t>Unused.</t>
              </list></t>

            <t>[Discussion: should we use IANA assigned protocol numbers
            here?]</t>
          </list></t>

        <t>Reserved:<list counter="1" hangIndent="5">
            <t>This field is set to zero by the sender and ignored by the
            receiver.</t>
          </list></t>

        <t>Internal Port:<list counter="1" hangIndent="5">
            <t>This field contains the internal port for the CGN mapping.</t>
          </list></t>

        <t>Configured External Port:<list counter="1" hangIndent="5">
            <t>This field contains the external port for the CGN mapping.</t>
          </list></t>

        <t>Internal IP Address:<list counter="1" hangIndent="5">
            <t>This field may or may not present, and when it does, contains
            the internal IPv4 or IPv6 address for the CGN mapping.</t>
          </list></t>
      </section>
    </section>

    <section title="Applications, Use Cases and Examples">

      <t>This section describes some applications and use cases to illustrate the use of the
      RADIUS port set attributes.</t>

      <section title="Managing CGN Port Behavior using RADIUS">
        <t>In a broadband network, customer information is usually stored on a
        RADIUS server, and the BNG hosts the NAS. The communication between
        the NAS and the RADIUS server is triggered by a subscriber when the
        user signs in to the Internet service, where either PPP or DHCP/DHCPv6
        is used. When a user signs in, the NAS sends a RADIUS Access-Request
        message to the RADIUS server. The RADIUS server validates the request,
        and if the validation succeeds, it in turn sends back a RADIUS
        Access-Accept message. The Access-Accept message carries configuration
        information specific to that user, back to the NAS, where some of the
        information would pass on to the requesting user via PPP or
        DHCP/DHCPv6.</t>

        <t>A CGN function in a broadband network would most likely reside on a
        BNG. In that case, parameters for CGN port/identifier mapping behavior
        for users can be configured on the RADIUS server. When a user signs in
        to the Internet service, the associated parameters can be conveyed to
        the NAS, and proper configuration is accomplished on the CGN device
        for that user.</t>

        <t>Also, CGN operation status such as CGN port/identifier allocation
        and de-allocation for a specific user on the BNG can also be
        transmitted back to the RADIUS server for accounting purpose using the
        RADIUS protocol.</t>

        <t>RADIUS protocol has already been widely deployed in broadband
        networks to manage BNG, thus the functionality described in this
        specification introduces little overhead to the existing network
        operation.</t>

        <t>In the following sub-sections, we describe how to manage CGN
        behavior using RADIUS protocol, with required RADIUS extensions
        proposed in <xref target="attrs"></xref>.</t>

        <section title="Configure CGN Session Limit">
          <t>In the face of IPv4 address shortage, there are currently
          proposals to multiplex multiple subscribers' connections over a
          smaller number of shared IPv4 addresses, such as Carrier Grade NAT
          <xref target="I-D.ietf-behave-lsn-requirements"></xref>, Dual-Stack
          Lite <xref target="RFC6333"></xref>, NAT64 <xref
          target="RFC6146"></xref>, etc. As a result, a single IPv4 public
          address may be shared by hundreds or even thousands of subscribers.
          As indicated in <xref target="RFC6269"></xref>, it is therefore
          necessary to impose limits on the total number of ports available to
          an individual subscriber to ensure that the shared resource, i.e.,
          the IPv4 address remains available in some capacity to all the
          subscribers using it, and port limiting is also documented in <xref
          target="I-D.ietf-behave-lsn-requirements"></xref> as a
          requirement.</t>

          <t>There are two practical granularities to impose such a limit. One
          is to define a session limit that is imposed to the total number of
          TCP and UDP ports, plus the number of ICMP identifiers, for a
          specific subscriber. Alternatively, a session limit can be specified
          for the sum of TCP ports and UDP ports, or a separate session limit
          for TCP ports and UDP ports, respectively, and another session limit
          for ICMP identifiers.</t>

          <t>The per-subscriber based session limit(s) is configured on a
          RADIUS server, along with other user information such as
          credentials. The value of these session limit(s) is based on service
          agreement and its specification is out of the scope of this
          document.</t>

          <t>When a subscriber signs in to the Internet service successfully,
          the session limit(s) for the subscriber is passed to the BNG based
          NAS, where CGN also locates, using a new RADIUS attribute called
          Port-Session-Limit (defined in <xref target="sessionlimit"></xref>),
          along with other configuration parameters. While some parameters are
          passed to the subscriber, the session limit(s) is recorded on the
          CGN device for imposing the usage of TCP/UDP ports and ICMP
          identifiers for that subscriber.</t>

          <t><xref target="fig1"></xref> illustrates how RADIUS protocol is
          used to configure the maximum number of TCP/UDP ports for a given
          subscriber on a NAT44 device.</t>

          <t><figure anchor="fig1" height=""
              title="RADIUS Message Flow for Configuring NAT44 Port Limit">
              <artwork><![CDATA[   
User                    NAT44/NAS                       AAA
 |                         BNG                         Server
 |                          |                             |
 |                          |                             |
 |----Service Request------>|                             |
 |                          |                             |
 |                          |-----Access-Request -------->|
 |                          |                             |
 |                          |<----Access-Accept-----------|
 |                          |     (Port-Session-Limit)    |
 |                          |     (for TCP/UDP ports)     |
 |<---Service Granted ------|                             |
 |    (other parameters)    |                             |
 |                          |                             |
 |                  (NAT44 external port                  |
 |                   allocation and                       |
 |                   IPv4 address assignment)             |
 |                          |                             |
]]></artwork>
            </figure></t>

          <t>The session limit(s) created on a CGN device for a specific user
          using RADIUS extension may be changed using RADIUS CoA message <xref
          target="RFC5176"></xref> that carries the same RADIUS attribute. The
          CoA message may be sent from the RADIUS server directly to the NAS,
          which once accepts and sends back a RADIUS CoA ACK message, the new
          session limit replaces the previous one.</t>

          <t><xref target="fig2"></xref> illustrates how RADIUS protocol is
          used to increase the TCP/UDP port limit from 1024 to 2048 on a NAT44
          device for a specific user.</t>

          <t><figure anchor="fig2" height=""
              title="RADIUS Message Flow for changing a user's NAT44 port limit">
              <artwork><![CDATA[     
  
User                     NAT/NAS                           AAA
 |                         BNG                            Server
 |                          |                               |
 |              TCP/UDP Port Limit (1024)                   |
 |                          |                               |
 |                          |<---------CoA Request----------|
 |                          |       (Port-Session-Limit)    |
 |                          |       (for TCP/UDP ports)     |
 |                          |                               |
 |              TCP/UDP Port Limit (2048)                   |
 |                          |                               |
 |                          |---------CoA Response--------->|
 |                          |                               |
]]></artwork>
            </figure></t>
        </section>

        <section title="Report CGN Session Allocation or De-allocation">
          <t>Upon obtaining the session limit(s) for a subscriber, the CGN
          device needs to allocate a TCP/UDP port or an ICMP identifiers for
          the subscriber when receiving a new IP flow sent from that
          subscriber.</t>

          <t>As one practice, a CGN may allocate a bulk of TCP/UDP ports or
          ICMP identifiers once at a time for a specific user, instead of one
          port/identifier at a time, and within each session bulk, the
          ports/identifiers may be randomly distributed or in consecutive
          fashion. When a CGN device allocates bulk of TCP/UDP ports and ICMP
          identifiers, the information can be easily conveyed to the RADIUS
          server by a new RADIUS attribute called the CGN-Session-Range
          (defined in <xref target="sessionrange"></xref>). The CGN device may
          allocate one or more TCP/UDP port ranges or ICMP identifier ranges,
          or generally called session ranges, where each range contains a set
          of numbers representing TCP/UDP ports or ICMP identifiers, and the
          total number of sessions must be less or equal to the associated
          session limit defined for that subscriber. A CGN device may choose
          to allocate a small session range, and allocate more at a later time
          as needed; such practice is good because its randomization in
          nature.</t>

          <t>At the same time, the CGN device also needs to decide the shared
          IPv4 address for that subscriber. The shared IPv4 address and the
          pre-allocated session range are both passed to the RADIUS
          server.</t>

          <t>When a subscriber initiates an IP flow, the CGN device randomly
          selects a TCP/UDP port or ICMP identifier from the associated and
          pre-allocated session range for that subscriber to replace the
          original source TCP/UDP port or ICMP identifier, along with the
          replacement of the source IP address by the shared IPv4 address.</t>

          <t>A CGN device may decide to "free" a previously assigned set of
          TCP/UDP ports or ICMP identifiers that have been allocated for a
          specific subscriber but not currently in use, and with that, the CGN
          device must send the information of the de-allocated session range
          along with the shared IPv4 address to the RADIUS server.</t>

          <t><xref target="fig3"></xref> illustrates how RADIUS protocol is
          used to report a set of ports allocated and de-allocated,
          respectively, by a NAT44 device for a specific user to the RADIUS
          server.</t>

          <t><figure anchor="fig3" height=""
              title="RADIUS Message Flow for reporting NAT44 allocation/de-allocation of a port set">
              <artwork><![CDATA[
Host                    NAT44/NAS                       AAA
 |                         BNG                         Server
 |                          |                             |
 |                          |                             |
 |----Service Request------>|                             |
 |                          |                             |
 |                          |-----Access-Request -------->|
 |                          |                             |
 |                          |<----Access-Accept-----------|                            
 |<---Service Granted ------|                             |
 |    (other parameters)    |                             |
...                        ...                           ...
 |                          |                             |
 |                          |                             |
 |                (NAT44 decides to allocate              |
 |                 a TCP/UDP port range for the user)     |
 |                          |                             |
 |                          |-----Accounting-Request----->|
 |                          |    (Port-Session-Range      |
 |                          |     for allocation)         |
...                        ...                           ...
 |                          |                             |
 |                (NAT44 decides to de-allocate           |
 |                 a TCP/UDP port range for the user)     |
 |                          |                             |      
 |                          |-----Accounting-Request----->|
 |                          |    (Port-Session-Range      |
 |                          |     for de-allocation)      |
 |                          |                             |
]]></artwork>
            </figure></t>

          <t></t>
        </section>

        <section title="Configure CGN Forwarding Port Mapping">
          <t>In most scenarios, the port mapping on a NAT device is
          dynamically created when the IP packets of an IP connection
          initiated by a user arrives. For some applications, the port mapping
          needs to be pre-defined allowing IP packets of applications from
          outside a CGN device to pass through and "port forwarded" to the
          correct user located behind the CGN device.</t>

          <t>Port Control Protocol <xref target="I-D.ietf-pcp-base"> </xref>,
          provides a mechanism to create a mapping from an external IP address
          and port to an internal IP address and port on a CGN device just to
          achieve the "port forwarding" purpose. PCP is a server-client
          protocol capable of creating or deleting a mapping along with a rich
          set of features on a CGN device in dynamic fashion. In some
          deployment, all users need is a few, typically just one
          pre-configured port mapping for applications such as web cam at
          home, and the lifetime of such a port mapping remains valid
          throughout the duration of the customer's Internet service
          connection time. In such an environment, it is possible to
          statically configure a port mapping on the RADIUS server for a user
          and let the RADIUS protocol to propagate the information to the
          associated CGN device.</t>

          <t><xref target="fig4"></xref> illustrates how RADIUS protocol is
          used to configure a forwarding port mapping on a NAT44 device by
          using RADIUS protocol.</t>

          <t><figure anchor="fig4" height=""
              title="RADIUS Message Flow for configuring a forwarding port mapping">
              <artwork><![CDATA[ 
Host                     NAT/NAS                           AAA
 |                         BNG                            Server
 |                          |                               |
 |----Service Request------>|                               |
 |                          |                               |
 |                          |---------Access-Request------->|
 |                          |                               |
 |                          |<--------Access-Accept---------|
 |                          |   (Port-Forwarding-Map)       |
 |<---Service Granted ------|                               |
 |    (other parameters)    |                               |
 |                          |                               |
 |                 (Create a port mapping                   |
 |                  for the user, and                       |
 |                  associate it with the                   |
 |                  internal IP address                     |
 |                  and external IP address)                |
 |                          |                               |
 |                          |                               |
 |                          |------Accounting-Request------>|
 |                          |    (Port-Forwarding-Map)      |
]]></artwork>
            </figure></t>

          <t>A port forwarding mapping that is created on a CGN device using
          RADIUS extension as described above may also be changed using RADIUS
          CoA message <xref target="RFC5176"></xref> that carries the same
          RADIUS associate. The CoA message may be sent from the RADIUS server
          directly to the NAS, which once accepts and sends back a RADIUS CoA
          ACK message, the new port forwarding mapping then replaces the
          previous one.</t>

          <t><xref target="fig5"></xref> illustrates how RADIUS protocol is
          used to change an existing port mapping from (a:X) to (a:Y), where
          "a" is an internal port, and "X" and "Y" are external ports,
          respectively, for a specific user with a specific IP address</t>

          <t><figure anchor="fig5" height=""
              title="RADIUS Message Flow for changing a user's forwarding     port mapping">
              <artwork><![CDATA[  
Host                     NAT/NAS                           AAA
 |                         BNG                            Server
 |                          |                               |
 |                    Internal IP Address                   |
 |                    Port Map (a:X)                        |
 |                          |                               |
 |                          |<---------CoA Request----------|
 |                          |    (Port-Forwarding-Map)      |
 |                          |                               |
 |                    Internal IP Address                   |
 |                    Port Map (a:Y)                        |
 |                          |                               |
 |                          |---------CoA Response--------->|
 |                          |    (Port-Forwarding-Map)      |
]]></artwork>
            </figure></t>
        </section>

        <section title="An Example">
          <t>An Internet Service Provider (ISP) assigns TCP/UDP 500 ports for
          the subscriber Joe. This number is the limit that can be used for
          TCP/UDP ports on a NAT44 device for Joe, and is configured on a
          RADIUS server. Also, Joe asks for a pre-defined port forwarding
          mapping on the NAT44 device for his web cam applications (external
          port 5000 maps to internal port 80).</t>

          <t>When Joe successfully connects to the Internet service, the
          RADIUS server conveys the TCP/UDP port limit (1000) and the
          forwarding port mapping (external port 5000 to internal port 80) to
          the NAT44 device, using Port-Session-Limit attribute and
          Port-Forwarding-Map attribute, respectively, carried by an
          Access-Accept message to the BNG where NAS and CGN co-located.</t>

          <t>Upon receiving the first outbound IP packet sent from Joe's
          laptop, the NAT44 device decides to allocate a small port pool that
          contains 40 consecutive ports, from 3500 to 3540, inclusively, and
          also assign a shared IPv4 address 192.0.2.15, for Joe. The NAT44
          device also randomly selects one port from the allocated range (say
          3519) and use that port to replace the original source port in
          outbound IP packets.</t>

          <t>For accounting purpose, the NAT44 device passes this port range
          (3500-3540) and the shared IPv4 address 192.0.2.15 together to the
          RADIUS server using Port-Session-Range attribute carried by an
          Accounting-Request message.</t>

          <t>When Joe works on more applications with more outbound IP
          sessions and the port pool (3500-3540) is close to exhaust, the
          NAT44 device allocates a second port pool (8500-8800) in a similar
          fashion, and also passes the new port range (8500-8800) and IPv4
          address 192.0.2.15 together to the RADIUS server using
          Port-Session-Range attribute carried by an Accounting-Request
          message. Note when the CGN allocates more ports, it needs to assure
          that the total number of ports allocated for Joe is within the
          limit.</t>

          <t>Joe decides to upgrade his service agreement with more TCP/UDP
          ports allowed (up to 1000 ports). The ISP updates the information in
          Joe's profile on the RADIUS server, which then sends a CoA-Request
          message that carries the Port-Session-Limit attribute with 1000
          ports to the NAT44 device; the NAT44 device in turn sends back a
          CoA-ACK message. With that, Joe enjoys more available TCP/UDP ports
          for his applications.</t>

          <t>When Joe travels, most of the IP sessions are closed with their
          associated TCP/UDP ports released on the NAT44 device, which then
          sends the relevant information back to the RADIUS server using
          Port-Session-Range attribute carried by Accounting-Request
          message.</t>

          <t>Throughout Joe's connection with his ISP Internet service,
          applications can communicate with his web cam at home from external
          realm directly traversing the pre-configured mapping on the CGN
          device.</t>

          <t>When Joe disconnects from his Internet service, the CGN device
          will de-allocate all TCP/UDP ports as well as the port-forwarding
          mapping, and send the relevant information to the RADIUS server.</t>
        </section>
      </section>

      <section title="Report Assigned Port Set for a Visiting UE">
        <t><xref target="wifi"></xref> illustrates an example of the flow
        exhange which occurs when a visiting UE connects to a CPE offering
        WiFi service. </t>

        <t>For identification purposes (see <xref
        target="I-D.ietf-intarea-nat-reveal-analysis"></xref>), once the CPE
        assigns a port set, it issues a RADIUS message to report the assigned
        port set.</t>

        <t><figure anchor="wifi" height=""
            title="RADIUS Message Flow for reporting CPE allocation/de-allocation of a port set to a visiting UE">
            <artwork><![CDATA[ 
UE         CPE             NAS                          AAA
 |                         BNG                         Server
 |                          |                             |
 |                          |                             |
 |----Service Request------>|                             |
 |                          |                             |
 |                          |-----Access-Request -------->|
 |                          |                             |
 |                          |<----Access-Accept-----------|                            
 |<---Service Granted ------|                             |
 |    (other parameters)    |                             |
...          |             ...                           ...
 |<---IP@----|              |                             |
 |           |              |                             |
 |   (CPE assigns a TCP/UDP port                          |
 |   range for this visiting UE)                          |
 |           |                                            |
 |           |--Accounting-Request-...------------------->|
 |           |    (Port-Session-Range                     |
 |           |     for allocation)                        |
...          |             ...                           ...
 |           |              |                             |
 |           |              |                             |
 |   (CPE withdraws a TCP/UDP port                        |
 |   range for a visiting UE)                             |
 |           |                                            |      
 |           |--Accounting-Request-...------------------->|
 |           |    (Port-Session-Range                     |
 |           |     for de-allocation)                     |
 |           |                                            |
]]></artwork>
          </figure></t>

        <t></t>
      </section>
    </section>

    <section anchor="Table" title="Table of Attributes">
      <t>The following table provides a guide as the attributes may be found
      in which kinds of RADIUS packets, and in what quantity.</t>

      <texttable style="none">
        <ttcol>Request</ttcol>

        <ttcol>Accept</ttcol>

        <ttcol>Reject</ttcol>

        <ttcol>Challenge</ttcol>

        <ttcol>Acct. Request</ttcol>

        <ttcol>#</ttcol>

        <ttcol>Attribute</ttcol>

        <c>0-1</c>

        <c>0-1</c>

        <c>0</c>

        <c>0</c>

        <c>0-1</c>

        <c>TBA1</c>

        <c>Port-Session-Limit</c>

        <c>0</c>

        <c>0</c>

        <c>0</c>

        <c>0</c>

        <c>0-1</c>

        <c>TBA2</c>

        <c>Port-Session-Range</c>

        <c>0-1</c>

        <c>0-1</c>

        <c>0</c>

        <c>0</c>

        <c>0-1</c>

        <c>TBA3</c>

        <c>Port-Forwarding-Map</c>
      </texttable>

      <t>The following table defines the meaning of the above table
      entries.</t>

      <t></t>

      <texttable style="none" suppress-title="true">
        <ttcol></ttcol>

        <ttcol></ttcol>

        <c>0</c>

        <c>This attribute MUST NOT be present in packet.</c>

        <c>0+</c>

        <c>Zero or more instances of this attribute MAY be present in
        packet.</c>

        <c>0-1</c>

        <c>Zero or one instance of this attribute MAY be present in
        packet.</c>
      </texttable>
    </section>

    <section anchor="Security" title="Security Considerations">
      <t>This document does not introduce any security issue than what has
      been identified in <xref target="RFC2865"></xref>.</t>
    </section>

    <section anchor="IANA" title="IANA Considerations">
      <section title="RADIUS Attributes">
        <t>This document requires new code point assignment for the three new
        RADIUS attributes as follows: <list style="symbols">
            <t>Port-Session-Limit</t>

            <t>Port-Session-Range</t>

            <t>Port-Forwarding-Map</t>
          </list></t>
      </section>

      <section title="Name Spaces">
        <t>This document establishes a new name space for Session Type (see
        <xref target="sessionlimit"></xref> for the initial reservation of
        values. The allocation of future values is according to RFC Required
        policy <xref target="RFC5226"></xref>.</t>
      </section>
    </section>

    <section title="Acknowledgements">
      <t>Many thanks to Dan Wing, Roberta Maglione, Daniel Derksen, and David
      Thaler for their useful comments and suggestions.</t>
    </section>
  </middle>

  <back>
    <references title="Normative References">
      &RFC2119;

      &RFC1918;

      &RFC2865;

      &RFC5176;
    </references>

    <references title="Informative References">

      <?rfc include='reference.RFC.3022'?>

      <?rfc include='reference.I-D.ietf-pcp-base'?>

      <?rfc include='reference.I-D.gundavelli-v6ops-community-wifi-svcs'?>

      <?rfc include='reference.RFC.6431'?>

      <?rfc include='reference.I-D.ietf-intarea-nat-reveal-analysis'?>

      &RFC6146;

      &RFC6158;

      &RFC5226;

      &I-D.ietf-behave-lsn-requirements;

      &RFC6269;

      &RFC6333;

      &I-D.miles-behave-l2nat;

      &I-D.arkko-dual-stack-extra-lite;
    </references>
  </back>
</rfc>

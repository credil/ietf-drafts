<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type='text/xsl' href='http://xml.resource.org/authoring/rfc2629.xslt' ?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd"[
<!ENTITY rfc2119 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY rfc5296 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5296.xml">
<!ENTITY rfc3588 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3588.xml">
<!ENTITY rfc3748 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3748.xml">
<!ENTITY rfc5836 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5836.xml">
<!ENTITY I-D.ietf-dime-local-keytran PUBLIC "" "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-dime-local-keytran.xml">
<!ENTITY I-D.ietf-hokey-erp-aak PUBLIC "" "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.draft-ietf-hokey-erp-aak-02.xml">
]>
<?rfc strict="yes"?>
<?rfc comments="no"?>
<?rfc inline="yes"?>
<?rfc editing="no"?>
<?rfc toc="yes"?>
<?rfc tocompact="yes"?>
<?rfc tocdepth="3"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes"?>
<?rfc compact="yes"?>
<?rfc subcompact="no"?>
<?rfc rfcedstyle="yes"?>
<?rfc rfcprocack="no"?>
<?rfc tocindent="yes"?>
<rfc category="std" docName="draft-hao-hokey-eep-00" ipr="trust200902">
        <front>
                <title abbrev="EEP">EAP Extensions for EAP Early Authentication Protocol (EEP)</title>

                <author fullname="Hao Wang"  initials="H" role="editor" surname="Wang">
                        <organization>Hangzhou H3C Tech. Co., Ltd.</organization>
                        <address>
                                <postal>
                                        <street>H3C, Digital Technology Plaza, Shangdi 9 Street, Haidian District</street>
                                        <city>Beijing</city>
                                        <country>China(100085)</country>
                                </postal>
                                <phone>+86 010 82774462</phone>
                                <email>hwang@h3c.com</email>
                        </address>
                </author>
                <author fullname="Yang Shi"  initials="Y" role="editor" surname="Shi">
                        <organization>Hangzhou H3C Tech. Co., Ltd.</organization>
                        <address>
                                <postal>
                                        <street>H3C, Digital Technology Plaza, Shangdi 9 Street, Haidian District</street>
                                        <city>Beijing</city>
                                        <country>China(100085)</country>
                                </postal>
                                <phone>+86 010 82775276</phone>
                                <email>young@h3c.com</email>
                        </address>
                </author>

                <author fullname="Tina Tsou"  initials="T" surname="Tsou">
                        <organization>Huawei Technologies</organization>
                        <address>
                                <postal>
                                        <street>BHuawei Technologies,</street>
                                        <street>Bantian, Longgang District</street>
                                        <city>Shenzhen</city>
                                        <country>China(518129)</country>
                                </postal>
                                <email>tena@huawei.com</email>
                        </address>
                </author>

                <date year="2010"/>

                <abstract>
                        <t>
                                The Extensible Authentication Protocol (EAP)
                                is a generic framework supporting multiple types of authentication methods.
                                <vspace blankLines="1"/>
                                Based on the EAP Early Authentication Model defined by RFC5836,
                                this document specifies the extensions of EAP to support both intra-AAA-realm
                                and inter-AAA-realm handover.
                        </t>
                </abstract>
        </front>

        <middle>
                <section title="Introduction">
                        <t>
                                The Extensible Authentication Protocol (EAP) <xref target="RFC3748"/>
                                is a generic framework supporting multiple types of authentication methods.  
                                In systems where EAP is used for authentication, the handover process often requires 
                                authentication and authorization for acquisition or modification of resources assigned 
                                to the mobile device. In most cases, these authentications and authorizations
                                require interaction with a central authority in a realm. In some cases, 
                                the central authority may be distant from the mobile device.                                 
                                The delay introduced due to such an authentication and authorization                         
                                procedure adds to the handover latency and consequently affects ongoing application sessions.  
                                <vspace blankLines="1"/>
                                In the problem statement <xref target="RFC5836"/>, it suggests that optimized solutions for
                                secure inter-authenticator handovers can be seen either as security context transfer (e.g., using the EAP
                                Extensions for EAP Re-authentication Protocol (ERP)) [RFC5296], or as EAP Early Authentication.
                                <vspace blankLines="1"/>
                                This document specifies EAP Extensions for Early Authentication Model.
                                The protocol that uses these extensions itself is referred to as the EAP Early Authentication
                                Protocol (EEP). A peer does EAP method-independent Early Authentication
                                before it attaches to a CAP. The protocol and the key hierarchy
                                required for EAP Early Authentication are described in this document.
                                <vspace blankLines="1"/>
                                Note that to support EEP, lower-layer specifications may need to be
                                revised to allow carrying EAP messages that have a code value more
                                than 4 and to accommodate the peer-initiated nature of EEP.
                                Specifically, the IEEE802.1x specification must be revised and RFC
                                4306 must be updated to carry EEP messages.
                        </t>
                </section>

                <section title="Terminology">
                        <section title="Standards Language">
                                <t>
                                        The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
                                        "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
                                        document are to be interpreted as described in <xref target="RFC2119">RFC 2119</xref>
                                </t>
                        </section>
                        <section title="Acronyms">
                                <t>
                                        The following acronyms are used in this document;
                                        see the references for more details.
                                        <list style="hanging" hangIndent="4">
                                                <t hangText="AAA">
                                                        Authentication, Authorization and Accounting <xref target="RFC3588"/>
                                                </t>
                                                <t hangText="CAP">
                                                        Candidate Attachment Point <xref target="RFC5836"/>
                                                </t>
                                                <t hangText="MH">
                                                        Mobile Host
                                                </t>
                                                <t hangText="SAP">
                                                        Serving Attachment Point <xref target="RFC5836"/>
                                                </t>
                                        </list>
                                </t>
                        </section>
                </section>

                <section anchor ="intra-interFlow" title="Message Flow of EAP Early Authentication">
                        <t>
                                Based on the functional elements of EAP Early Authentication <xref target="RFC5836"/>,
                                the following sections introduce the general message flow of Inter-AAA-Realm
                                and Intra-AAA-Realm handovers. The figures below are to give an overview of EAP Early Authentication.
                        </t>
                        <t>
                                It is assumed that the MH has previously completed full EAP
                                authentication with Home AAA.
                        </t>

                        <section anchor="intraFlow" title="Intra-AAA-Realm Handover">
                                <t>
                                        In intra-AAA-realm handover scenario, SAP and CAP belong to a same AAA realm.
                                        <vspace blankLines="1"/>
<figure anchor="intraFigure" align="center" title="Intra-AAA-Realm Handover"><artwork><![CDATA[
+------+    +-----+   +-------+    +--------+    
|  MH  |    | SAP |   |  CAP  |    |Home AAA|    
+--+---+    +--+--+   +---+---+    +----+---+    
   |           |          |             |        
   |       Early  Authentication        |        
   |<--------->|<---------|------------>|        
   |           |          |             |        
   |           |          |             |        
   |    Attach to the CAP |             |   
   |-----------|--------->|------------>|
   |           |          |             |        
   |           |          |    pMSK     |
   |           |          |<------------|
   |           |          |             | 
]]></artwork></figure>
                                        Before MH (peer) performs handover from SAP to CAP, it does early authentication with Home AAA.
                                        <vspace blankLines="1"/>
                                        Since SAP and CAP belong to the same Home AAA, the complete EAP method exchange is not 
                                        required in early authentication.
                                        The MH informs Home AAA of the NAS-id of CAPs and each CAP's sequence number.
                                        Home AAA will derive the pMSK from EMSK and sequence number.
                                        Sequence number must be unique for each CAP to derive a unique pMSK.
                                        <vspace blankLines="1"/>
                                        After handover, MH attaches to the CAP. MH request to change from early authenticated state 
                                        to fully authorized and authenticated state. Its Home AAA is not changed.
                                        And then Home AAA distribute the pMSK to CAP. 
                                </t>                      
                        </section>

                        <section anchor="interFlow" title="Inter-AAA-Realm Handovers">
                                <t>
                                  In inter-AAA-realm scenario, as the first step, 
                                  Home AAA and CAP-AAA need to establish a trust relationship.
                                </t>
                                <t>
                                  There are two cases for this step. 
                                </t>
                                <t>
                                  In first case, Home AAA and CAP-AAA belong to a same operator.
                                  In this case, a full trust relationship may be established. That means 
                                  security context transfer between AAA servers is permitted. 
                                </t>
                                <t>     
<figure anchor="interFigure1" align="center" title="Inter-AAA-Realm Handovers(Full trust relationship)"><artwork><![CDATA[
+------+    +-----+    +-------+   +--------+  +-----+  +-------+    
|  MH  |    | SAP |    |SAP-AAA|   |Home AAA|  | CAP |  |CAP-AAA|    
+--+---+    +--+--+    +---+---+   +----+---+  +--+--+  +---+---+    
   |           |           |            |         |         |        
   |           |           |Establish Trust Relationship Between AAAs
   |           |           |            |<--------|-------->|
   |           |           |            |         |         |        
   |         Early  Authentication     Early  Authentication|        
   |<--------->|<--------->|<---------->|<--------|-------->|        
   |           |           |            |         |         |        
   |           |           |            |  DSRK, EMSK Name  |      
   |           |           |            |<--------|-------->|        
   |           |           |            |         |         |        
   |           |   Attach to the CAP    |         |         |        
   |-----------|-----------|------------|-------->|-------->|
   |           |           |            |         |         |
   |           |           |            |         |   pMSK  |
   |           |           |            |         |<--------|
   |           |           |            |         |         |        
]]></artwork></figure>
                                          <vspace blankLines="1"/>
                                          Before MH (peer) performs handover from SAP to CAP, it does early authentication with CAP-AAA,
                                          and messages will be forwarded by SAP, SAP-AAA and Home AAA to CAP-AAA.
                                          <vspace blankLines="1"/>
                                          Since Home AAA and CAP-AAA belong to the same operator,
                                          the complete EAP method exchange is not required in early authentication. 
                                          The CAP-AAA will get DSRK and EMSK Name from Home AAA and derive pMSK from DSRK directly.
                                          <vspace blankLines="1"/>
                                          After handover, MH attaches to the CAP. Its Home AAA is not changed and
                                          CAP-AAA becomes the new local AAA server(SAP-AAA).
                                  </t>
                                  <t>
                                          In second case, Home AAA and CAP-AAA belong to different operators.
                                          In this case, a semi trust relationship may be established.
                                          That means two AAA servers can recognize each other based on domain name and communicate each other.
                                          But the security context transfer is not permitted. 
                                  </t>
                                  <t>
<figure  anchor="interFigure2" align="center" title="Inter-AAA-Realm Handovers(Semi trust relationship)"><artwork><![CDATA[
+------+    +-----+    +-------+   +--------+  +-----+  +-------+    
|  MH  |    | SAP |    |SAP-AAA|   |Home AAA|  | CAP |  |CAP-AAA|    
+--+---+    +--+--+    +---+---+   +----+---+  +--+--+  +---+---+    
   |           |           |            |         |         |        
   |           |           |Establish Trust Relationship Between AAAs
   |           |           |            |<--------|-------->|        
   |           |           |            |         |         |        
   |         Early  Authentication      Early Authentication|        
   |<--------->|<--------->|<---------->|<--------|-------->|
   |           |           |            |         |         |        
   |           |        EAP Method Exchange       |         |        
   |<----------|-----------|------------|---------|-------->|        
   |           |           |            |         |         |        
   |           |        Attach to the CAP         |         |        
   |-----------|-----------|------------|-------->|-------->|        
   |           |           |            |         |         |        
   |           |           |            |         |   pMSK  |        
   |           |           |            |         |<--------|        
   |           |           |            |         |         |  
]]></artwork></figure> 
                                        Since Home AAA and CAP-AAA belong to the different operators,
                                        usually, a complete EAP method exchange will be done in early authentication.
                                        MSK and EMSK will be derived in full EAP authentication.
                                        CAP-AAA will use the MSK as the pMSK.
                                        <vspace blankLines="1"/>
                                        After handover, MH attaches to the CAP,
                                        its Home AAA is changed and CAP-AAA acts as a new Home AAA.
                                </t>
                        </section>
                </section>

                <section anchor="problem" title="Problem Statement">
                        <t>
                                According to the general message flow of Intra-AAA-Realm and Inter-AAA-Realm handovers,
                                the following problems need to be resolved for Early Authentication Model.
                                <list style="hanging" hangIndent="2">
                                <t hangText="1) How to establish a trust relationship between Home AAA and CAP-AAA?">
                                <vspace blankLines="1"/> 
                                It is an important issue but the solution is out of the scope of this document.
                                </t>
                                <t hangText="2) How does MH knows whether a complete EAP method exchange is required?">
                                <vspace blankLines="1"/>
                                A method is required for MH to negotiate this issue with CAP-AAA when it request to start
                                the early authentication.
                                </t>
                                <t hangText="3) How does MH get CAP's status and capability information in advance?">
                                <vspace blankLines="1"/> 
                                CAPs are discovered through EAP Lower layer. But early authentication is done through EAP layer.
                                MH needs to know whether the discovered CAPs can be early authenticated through Home AAA or not.
                                If MH can't get such knowledge before the early authentication, it is evident that the handover 
                                experience will be inefficient.
                                </t>
                                <t hangText="4) How to forward the EEP message between MH and CAP-AAA?">
                                <vspace blankLines="1"/> 
                                Unlike normal EAP authentication, The SAP-AAA and Home AAA should forward 
                                EAP early authentication packets to CAP-AAA instead of processing them locally.
                                So the SAP-AAA and Home AAA should know the domain name of CAP-AAA and when the early authentication
                                is started.
                                </t>
                                <t hangText="5) How to handle the frequent MH handover?">
                                <vspace blankLines="1"/> 
                                AAA server needs to maintain early authentication sessions, while frequent MH handover may lead to 
                                redundant obsolete early authentication sessions on AAA servers.
                                A mechanism is required to settle this situation.
                                </t>
                                <t hangText="6) How to ensure the information consistent between MH and CAP-AAA?">
                                <vspace blankLines="1"/> 
                                It is a high possibility of information inconsistency between MH and CAP-AAA. 
                                For example, after handover, MH starts to use pMSK for EAP lower layer key derivation. 
                                But the early authentication session on CAP-AAA has just been expired without notifying MH.
                                </t>
                                </list>
                            </t>
                </section>

                <section anchor="solution" title="Solution">
                  <t>
                    Similiar to ERP protocol, a trigger message is required by SAP to infom MH of its capability
                    to support early authentication. To avoid redundant trigger message, 
                    EAP Initiate/Re-auth-Start <xref target="RFC5296"/>
                    is reused and one E flag is added to indicate whether EEP is supported.
                  </t>
                  <t>
                    EAP Codes 5(EAP Initiate) and 6(EAP Finish) defined in the protocol of 
                    ERP <xref target="RFC5296"/> is reused.
                        </t>
                        <t>
                          New EAP Initiate/Pre-early-auth and EAP Finish/Pre-early-auth messages are defined to 
                          start the early authentication and negotiate whether full EAP authentication is required.
                        </t>
                        <t>
                          New EAP Initiate/Post-early-auth and EAP Finish/Post-early-auth messages are defined to
                          confirm the early authentication information and change the state from early authenticated to
                          fully authorized and authenticated.
                        </t>
                        <t>
                          Early auth action message is defined for below functionality.
                        </t>
                        <t>
                          - Probe whether the early authentication is supported for sepecified CAP.
                        </t>
                        <t>
                          - Release the early authentication session to avoid redudant resource assumption.
                        </t>
                        <t>
                          - Request to change from fully authenticated state to early authenticated state.
                        </t>
                </section>

                <section title="Assumptions">
                        <t>
                                For the solution, it is assumed that:
                        </t>
                        <t>
                                - The trust relationship has been established between Home AAA server and CAP-AAA server.
                        </t>
                        <t>
                                - EEP server has co-located with the AAA server.
                        </t>
                        <t>
                                - The authenticator act as a pass-through entity for early authentication
                                protocol in a manner similar to that of an EAP authenticator described in RFC3748.
                        </t>
                        <t>
                                - The entity which support EEP can also support ERP <xref target="RFC5296"/>. So MH can
                                use ERP message to obtain the local domain name.
                        </t>
                        <t>
                          - MH has fully authenticated with Home AAA before handover.
                        </t>
                    </section>
        <section title="Protocol Message Flow">
                <t>
                                  Based on the  <xref target="intra-interFlow"/> and <xref target="solution"/>,
                          the below figures show the protocol message flow of EEP protocol.
                          </t>
                          <section title="Intra-AAA-Realm Handovers">
                            <t>
<figure anchor="eepIntra" align="center" title="Intra-AAA-Realm Handovers"><artwork><![CDATA[
+---+            +-----+              +-----+         +---------+
|MH |            | SAP |              | CAP |         |Home AAA |
+-+-+            +--+--+              +--+--+         +----+----+
  |                 |                    |                 |   
1.| EAP Initiate/   |                    |                 |
  | Pre-Early-auth  |    AAA(EAP Initiate/Pre-Early-auth)  |
  |---------------->|--------------------|---------------->|
  |                 |                    |                 |
  |                 |                    |                 |  
2.|   EAP Finish/   |                    |                 |
  | Pre-Early-auth  |    AAA(EAP Finish/Pre-Early-auth)    |
  |<----------------|<-------------------|-----------------|
  |                 |                    |                 |   
3.|                 |                    | AAA(EAP Init/   |
  |  EAP Initiate/Post-Early-auth        | Post-Early-auth)|
  |-----------------|------------------->|---------------->|
  |                 |                    |                 |   
  |                 |                    |          |--------------|    
  |                 |                    |          |CA Authorized |
  |                 |                    |          |      &       |
  |                 |                    |          |Authenticated;| 
  |                 |                    |          |    Keying    |
  |                 |                    |          |   material   |
  |                 |                    |          |    derived   |    
  |                 |                    |          |--------------|
  |                 |                    |                 |
  |                 |                    |    AAA(pMSK)    |
  |                 |                    |<----------------| 
  |                 |                    |                 |
4.|                 |                    | AAA(EAP Finish/ |
  |  EAP Finish/Post-Early-auth          | Post-Early-auth)|
  |<----------------|--------------------|<----------------|
  |                 |                    |                 |   

]]></artwork></figure>
                  <list style="hanging" hangIndent="2">
                                                  <t hangText="1) MH request to start the early authentication">
                                                   <vspace blankLines="1"/> 
                                                   MH starts the early authentication using EAP Initiate/Pre-Early-auth message. In Pre-Early-auth
                                                   message, the NAS-id of CAP and sequence number is included.
                                                   EAP Initiate/Pre-Early-auth is protected by pIK for middle man attack.
                                                  </t>
                                                  <t hangText="2) Home AAA respond with early authentication result">
                     <vspace blankLines="1"/> 
                     When Home AAA receive the request from MH, it verify the availability of CAP's NAS-id.
                     And check whether EEP is supported by this CAP. 
                     Home AAA respond with early authentication result using EAP Finish/Pre-Early-auth message.
                     pMSK will be derived from EMSK and sequence number and will be kept in early authentication session.
                                                  </t>
                                                  <t hangText="3) MH request to change its state">
                     <vspace blankLines="1"/> 
                     After handover, MH request to change its state from early authenticated state to fully authorized
                     and authenticated state.
                     In EAP Initiate/Post-Early-auth message, the NAS-id of CAP and EMSK name is included.
                                                  </t>
                                                  <t hangText="4) Home AAA confirm the state change">
                     <vspace blankLines="1"/> 
                     Home AAA confirm the NAS-id and key name, and then respond with state changing result 
                     using EAP Finish/Post-Early-auth message.
                     Home AAA distribute the pMSK to the CAP.
                                                  </t>
                                          </list>
                                        </t>
                          </section>
                <section title="Inter-AAA-Realm Handovers(Full trust relationship)">
                  <t>
                       It is assumed that SAP-AAA act as the Home AAA server.
<figure anchor="eepInter1" align="center" title="Intra-AAA-Realm Handovers(Full trust relationship)"><artwork><![CDATA[
+---+            +-----+           +-------+  +-----+     +-------+
|MH |            | SAP |           |SAP-AAA|  | CAP |     |CAP-AAA|
+-+-+            +--+--+           +---+---+  +--+--+     +---+---+
  |                 |                  |         |            |
1.| EAP Initiate/   | AAA(EAP Initiate/|  AAA(EAP Initiate/   |
  | Pre-Early-auth  | Pre-Early-auth)  |  Pre-Early-auth)     |
  |---------------->|----------------->|--------------------->|
  |                 |                  |         |            |
2.|                 |                  |  AAA(DSRK Request)   |
  |                 |                  |<---------------------|
  |                 |                  |         |            |
  |                 |                  |AAA(DSRK, EMSK Name)  |
  |                 |                  |--------------------->|
  |                 |                  |         |            |
3.|   EAP Finish/   |   AAA(EAP Finish/|  AAA(EAP Finish/     |
  | Pre-Early-auth  |   Pre-Early-auth)|  Pre-Early-auth)     |
  |<----------------|<-----------------|<---------------------|
  |                 |                  |         |            |
4.|                 |                  |      AAA(EAP Init/   |
  |   EAP Initiate/Post-Early-auth     |     Post-Early-auth) |
  |-----------------|------------------|-------->|----------->|
  |                 |                  |         |            |
  |                 |                  |         | |--------------|
  |                 |                  |         | |CA Authorized |
  |                 |                  |         | |      &       |
  |                 |                  |         | |Authenticated;|
  |                 |                  |         | |    Keying    |
  |                 |                  |         | |   material   |
  |                 |                  |         | |    derived   |
  |                 |                  |         | |--------------|
  |                 |                  |         |            |
  |                 |                  |         | AAA(pMSK)  |
  |                 |                  |         |<-----------|
  |                 |                  |         |            |  
5.|                 |                  |       AAA(EAP Finish/|
  |   EAP Finish/Post-Early-auth       |      Post-Early-auth)|
  |<----------------|------------------|---------|<-----------|
  |                 |                  |         |            |

]]></artwork></figure>
                  <list style="hanging" hangIndent="2">
                                                  <t hangText="1) MH request to start the early authentication">
                                                   <vspace blankLines="1"/> 
                                                   MH starts the early authentication using EAP Initiate/Pre-Early-auth message. In Pre-Early-auth
                                                   message, the NAS-id-NAI of CAP and sequence number is included.
                                                   Based on the realm part of NAS-id-NAI, the SAP-AAA will forward the Pre-Early-auth message to the 
                                                   corresponding CAP-AAA. 
                                                   if the CAP-AAA can not be found or trust relationship has not been established, 
                                                   SAP-AAA will directly reject the early authentication request.
                                                  </t>
                                                  <t hangText="2) CAP-AAA request DSRK and EMSK Name from SAP-AAA">
                     <vspace blankLines="1"/> 
                     After receiving the ealy authentication request, CAP-AAA find that the full trust relationship has
                     been established between SAP-AAA and CAP-AAA.
                     So CAP-AAA request DSRK and EMSK name from SAP-AAA(Home AAA).
                                                  </t>
                                                  <t hangText="3) CAP-AAA respond with early authentication result">
                     <vspace blankLines="1"/> 
                     Home AAA respond with early authentication result using EAP Finish/Pre-Early-auth message.
                     pMSK will be derived from DSRK and sequence number and will be kept in early authentication entry.
                                                  </t>
                                                  <t hangText="4) MH request to change its state">
                     <vspace blankLines="1"/> 
                     After handover, MH request to change its state from early authenticated state to fully authorized
                     and authenticated state.
                                                  </t>
                                                  <t hangText="5) Home AAA confirm the state change">
                     <vspace blankLines="1"/> 
                     Home AAA respond with state changing result using EAP Finish/Post-Early-auth message.
                     Home AAA distribute the pMSK to the CAP.
                                                  </t>
                                          </list>
          </t>
                          </section>

        <section title="Inter-AAA-Realm Handovers(Semi trust relationship)">
          <t>
            It is assumed that SAP-AAA act as the Home AAA server.
<figure anchor="eepInter2" align="center" title="Inter-AAA-Realm Handovers(Semi trust relationship)"><artwork><![CDATA[

+---+             +-----+              +-------+ +-----+    +-------+
|MH |             | SAP |              |SAP-AAA| | CAP |    |CAP-AAA|
+-+-+             +--+--+              +---+---+ +--+--+    +---+---+
  |                  |                     |        |           |
1.|   EAP Initiate/  |   AAA(EAP Initiate/ |  AAA(EAP Initiate/ |
  |  Pre-Early-auth  |    Pre-Early-auth)  |   Pre-Early-auth)  |
  |----------------->|-------------------->|------------------->|
  |                  |                     |        |           |
2.|   EAP Finish/    |   AAA(EAP Finish/   |   AAA(EAP Finish/  |
  |  Pre-Early-auth  |   Pre-Early-auth)   |   Pre-Early-auth)  |
  |<-----------------|<--------------------|<-------------------|
  |                  |                     |        |           |
3.|EAP Authentication|            AAA(EAP Authentication)       |
  |<---------------->|<------------------->|<------------------>|
  |                  |                     |        |           |
4.|                  |                     |    AAA(EAP Init/   |
  |   EAP Initiate/Post-Early-auth         |    Post-Early-auth)|
  |------------------|---------------------|------->|---------->|
  |                  |                     |        |           |
  |                  |                     |        | |-------------|
  |                  |                     |        | |CA Authorized|
  |                  |                     |        | |      &      |
  |                  |                     |        | |Authenticated|
  |                  |                     |        | |    Keying   |
  |                  |                     |        | |   material  |
  |                  |                     |        | |    derived  |
  |                  |                     |        | |-------------|
  |                  |                     |        |           |
  |                  |                     |        | AAA(pMSK) |
  |                  |                     |        |<----------|
  |                  |                     |        |           |
5.|                  |                     |     AAA(EAP Finish/|
  |   EAP Finish/Post-Early-auth           |    Post-Early-auth)|
  |<-----------------|---------------------|--------|<----------|
  |                  |                     |        |           |

]]></artwork></figure>
                    <list style="hanging" hangIndent="2">
                                                          <t hangText="1) MH request to start the early authentication">
                                                           <vspace blankLines="1"/> 
                                                           MH starts the early authentication using EAP Initiate/Pre-Early-auth message. In Pre-Early-auth
                                                     message, the NAS-id-NAI of CAP and sequence number is included.
                                                     Based on the realm part of NAS-id-NAI, the SAP-AAA will forward the Pre-Early-auth message to the 
                                                     corresponding CAP-AAA. 
                                                     if the CAP-AAA can not be found or trust relationship has not been established, 
                                                     SAP-AAA will directly reject the early authentication request.
                                                          </t>
                                                          <t hangText="2) CAP-AAA respond with early authentication result">
                             <vspace blankLines="1"/> 
                             After receiving the ealy authentication request, CAP-AAA find that the semi trust relationship has
                       been established between SAP-AAA and CAP-AAA.
                             Home AAA respond with early authentication result using EAP Finish/Pre-Early-auth message.
                             And in the message, Home AAA inform MH that full EAP authentication is required.
                                                          </t>
                                                          <t hangText="3) MH do full EAP authentication with CAP-AAA">
                             <vspace blankLines="1"/> 
                             MH do eap authentication with CAP-AAA with full authentication method exchange.
                             SAP-AAA will forward the EAP authentication message to CAP-AAA and reponse message to MH.
                                                          </t>
                                                          <t hangText="4) MH request to change its state">
                             <vspace blankLines="1"/> 
                             After handover, MH request to change its state from early authenticated state to fully authorized
                       and authenticated state.
                                                          </t>
                                                          <t hangText="5) Home AAA confirm the state change">
                             <vspace blankLines="1"/> 
                             Home AAA respond with state changing result using EAP Finish/Post-Early-auth message.
                       Home AAA distribute the pMSK to the CAP.
                                                          </t>
                                                  </list>
                                                </t>
            </section>
            <section title="Release authentication session">
              <t>
<figure anchor="eepRoam" align="center" title=""><artwork><![CDATA[

+---+             +-----+              +-------+ +-----+    +-------+
|MH |             | SAP |              |SAP-AAA| | CAP2|    |CAP-AAA|
+-+-+             +--+--+              +---+---+ +--+--+    +---+---+
  |                  |                     |        |           |
1.|   EAP Initiate/  |  AAA(EAP Initiate/  |  AAA(EAP Initiate/ |
  |Early-auth Action/| Early-auth Action/  | Early-auth Action/ |
  |    De-Pre-auth   |    De-Pre-auth      |     De-Pre-auth    |
  |----------------->|-------------------->|------------------->|
  |                  |                     |        |           |
2.|   EAP Initiate/  |  AAA(EAP Initiate/  |        |           |
  |Early-auth Action/| Early-auth Action/  |        |           |
  |   De-Post-auth   |    De-Post-auth     |        |           |
  |----------------->|-------------------->|        |           |
  |                  |                     |        |           |
3.|                  |                     |    AAA(EAP Init/   |
  |   EAP Initiate/Post-Early-auth         |    Post-Early-auth)|
  |------------------|---------------------|------->|---------->|
  |                  |                     |        |           |
  |                  |                     |        | |-------------|
  |                  |                     |        | |CA Authorized|
  |                  |                     |        | |      &      |
  |                  |                     |        | |Authenticated|
  |                  |                     |        | |    Keying   |
  |                  |                     |        | |   material  |
  |                  |                     |        | |    derived  |
  |                  |                     |        | |-------------|
  |                  |                     |        |           |
  |                  |                     |        | AAA(pMSK) |
  |                  |                     |        |<----------|
  |                  |                     |        |           |
4.|                  |                     |     AAA(EAP Finish/|
  |   EAP Finish/Post-Early-auth           |    Post-Early-auth)|
  |<-----------------|---------------------|--------|<----------|
  |                  |                     |        |           |

]]></artwork></figure>
                    <list style="hanging" hangIndent="2">
                                                          <t hangText="1) MH release the early authentication session with CAP1">
                                                           <vspace blankLines="1"/> 
                                                           MH sends EAP Initiate/Early-auth Action/De-Pre-auth to inform CAP-AAA release early authentication
                                                           session for CAP1.
                                                          </t>
                                                          <t hangText="2) MH release the full authentication session with SAP">
                             <vspace blankLines="1"/> 
                             MH sends EAP Initiate/Early-auth Action/De-Post-auth to inform SAP-AAA to change its state from
                             full authorized and authenticated state to early authenticated state.
                                                          </t>
                                                          <t hangText="3) MH request to change its state">
                             <vspace blankLines="1"/> 
                             After handover, MH request to change its state from early authenticated state to fully authorized
                       and authenticated state.
                                                          </t>
                                                          <t hangText="4) Home AAA confirm the state change">
                             <vspace blankLines="1"/> 
                             Home AAA respond with state changing result using EAP Finish/Post-Early-auth message.
                       Home AAA distribute the pMSK to the CAP2.
                                                          </t>
                                                  </list>
                                                </t>
            </section>
        </section>
          <section title="EEP Key Hierarchy">
                      <t>
                              EEP uses key hierarchy similar to that of ERP <xref target="RFC5296"/>.
                                                The EMSK is used to derive the EEP pre-established Root Key (pRK).
                                                Similarly, the EEP pre-established Integrity Key (pIK) and 
                                                the pre-established Master Session Key (pMSK) is derived from the pRK.
                                                The pMSK is established for the CAP(s) when the peer early authenticates to the network.
                                                The pIK is established for the peer to do post early authentication after handover.
                                                The hierarchy relationship is illustrated in <xref target="KH1"/>, below.

<figure anchor="KH1" align="center"><artwork>
 (inter-AAA-realm) (intra-AAA-realm)
        DSRK            EMSK
         |               |
 +-------+-------+-------+-------+
 |               |               |
pRK             rRK             ...
</artwork></figure>

                                                The EMSK and DSRK both can be used to derive the pRK. In general, the
                                                pRK is derived from the EMSK in case of the peer moving in the Home AAA
                                                realm and derived from the DRSK in case of the peer moving in the
                                                visited AAA realm.
                                                The DSRK is delivered from the EAP server to the EEP
                                                server as specified in  <xref target="I-D.ietf-dime-local-keytran"></xref>.
                                                if the peer has previously authenticated by means of EEP, the DSRK SHOULD be
                                                directly re-used.

<figure anchor="KH2" align="center"><artwork>
            pRK
             |
 +-----------+-----------+
 |           |           |
pIK         pMSK        ...
</artwork></figure>

                                                The pRK is used to derive the pIK and pMSK for the CAP(s). Different
                                                sequence numbers for each CAP MUST be used to derive the unique
                                                pMSK(s).
                </t>
                <section title="Key Derivation">
                        <t>
                                As specified in <xref target="I-D.ietf-hokey-erp-aak"></xref>, the key derivation method is given below.
                        </t>
                        <section title="pRK Derivation">
                                <t>
                                        pRK = KDF (K, S), where K = EMSK or DSRK and S = pRK Label | "\0" | length
                                </t>
                                <t>
                                        The pRK Label is an IANA-assigned 8-bit ASCII string:
                                </t>
                                <t>
                                        EAP Early authentication Root Key@ietf.org
                                </t>
                        </section>
                        <section title="pIK Derivation">
                                <t>
                                        pIK = KDF (K, S), where K = pRK and S = pIK Label | "\0" | cryptosuite | length
                                </t>
                                <t>
                                        The pIK Label is the 8-bit ASCII string:
                                </t>
                                <t>
                                        Early authentication Integrity Key@ietf.org
                                </t>
                        </section>
                        <section title="pMSK Derivation">
                                <t>
                                        pMSK = KDF (K, S), where K = pRK and S = pMSK label | "\0" | SEQ | length
                                </t>
                                <t>
                                        The pMSK label is the 8-bit ASCII string:
                                </t>
                                <t>
                                        Early authentication Master Session Key@ietf.org
                                </t>
                        </section>
                </section>
                </section>
                <section title="Packet and TLV Extension">
                        <t>
                                EEP reuse EAP Codes 5(EAP Initiate) and 6(EAP Finish) defined in the protocol of ERP <xref target="RFC5296"/>.
                                The packet format for these messages follows the EAP packet format defined in RFC 3748.
                        </t>
<figure anchor="eepFormat" title="EAP Packet" align="center"><artwork>
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Code     |   Identifier  |             Length            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type     |   Type-Data ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>

      <t>Code</t>
      <t>5  Initiate </t>
      <t>6  Finish</t>

      <t>
              Identifier
      </t>
      <t>
              Refer to <xref target="RFC5296"/> Section 5.3
      </t>

      <t>Type</t>

      <t>This field indicates that this is an EEP exchange. 
      Three new Type values are defined for the purpose of early
      authentication. </t>

      <t>3  Pre-Early-auth </t>
      <t>4  Post-Early-auth </t>
      <t>5  Early-auth Action </t>

      <t>Type-Data</t>
      <t>The Type-Data field varies with the Type of early authentication packet.</t>
              <section title="EAP Initiate/Re-auth-Start Packet Extension">
                      <t>
                              One E flag bit is added in EAP Initiate/Re-auth-Start message.
                      </t>

<figure anchor="eFlag" align="center" title="EAP Initiate/Re-auth-Start Packet"><artwork>   
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Code      |  Identifier   |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Type      |E| Reserved    |     1 or more TVs or TLVs     ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>
                      <t>
                              Code = 5(EAP Initiate)
                      </t>
                      <t>
                              Identifier
                      </t>
                      <t>
                              Refer to <xref target="RFC5296"/> Section 5.3
                      </t>
                      <t>
                              Type = 1(Re-auth-Start)
                      </t>
                      <t>
                              Flags
                      </t>
                      <t>
                              'E' - The E flag is used to indicate whether EEP is supported or not.
                              If E Bit is set to 1, it indicate that EEP is supported by the authenticator 
                              and the MH can start the early authentication.
                              If E Bit is set to 0, MH can not start early authentication using EEP.
                      </t>
                      <t>
                              Reserved: MUST be set to 0.
                      </t>
                      <t>
                              TVs or TLVs: refer to ERP <xref target="RFC5296"/>.
                      </t>
                      <t>
                              To avoid redundant trigger message at the beginning, 
                              No new early authentication start message is defined.
                      </t>
                </section>
                
                <section title="EAP Initiate/Pre-Early-auth">
 <figure align="center" anchor="eepInitPre" title="EAP Initiate/Pre-Early-auth Packet"><artwork>   
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Code    |   Identifier  |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Type    |R|S|A|C|Reserved|           SEQ                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    1 or more TVs or TLVs                    ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Cryptosuite |            Authentication Tag                 ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>

            <t>Code = 5(EAP Initiate)</t>
            <t>
                                     Identifier
                                  </t>
                                  <t>
                                     Refer to <xref target="RFC5296"/> Section 5.3
                                  </t>
                <t>Type = 3(Pre-Early-auth)</t>

                              <t>
                                Flags
                        </t>
                        <t>
                                'R' - The value of result flag MUST be zero and ignored on reception.
                        </t>
                        <t> 
                                'S' - The value of secure flag indicate whether cryptosuite and authentication tag is appended.
                  </t>
                        <t>
                                      0 Cryptosuite and Authentication Tag are not appended.
                                    </t>
                                    <t>
                                      1 Cryptosuite and Authentication Tag are appended at the end of message.
                              </t>
                        <t>
                                      When the EAP Initiate/Early-auth action message is transferred 
                                      between SAP-AAA and Home-AAA, S Bit = 0.
                        </t>
                        <t>
                                'A' - Authentication flag:
                  </t>
                        <t>
                                      0 MH do not request to do full EAP authentication.
                                    </t>
                        <t>
                                      1 MH request to do full EAP authentication.
                        </t>
                        <t>
                                'C' - Continue flag:
                        </t>
                        <t>
                                      0 This is a normal Pre-Early-auth message.
                                     </t>
                        <t>
                                      1 This message is used to extend the lifetime of Pre-Early-auth session.
                        </t>
                        <t>
                                SEQ
                        </t>
                        <t>
                                A 16-bit sequence number is used for replay protection.
                        </t>
                        <t>     
                                TVs and TLVs
                        </t>
                        <t>
                                      NAS-Identifier: This is a TLV payload, type is 4. 
                                      Exactly one NAS-Identifier or NAS-Identifier-NAI TLV SHOULD be included 
                                      in the EAP Initiate/Pre-Early-auth message. 
                              </t>
                              <t>
                                      NAS-Identifier-NAI: This is a TLV payload, type is TBD. 
                                      Exactly one NAS-Identifier or NAS-Identifier-NAI TLV SHOULD be included in 
                                      the EAP Initiate/Pre-Early-auth message.  
                              </t>
                              <t>
                                      List of cryptosuites: This is a TLV payload, type is 5. 
                                      Exactly one List of cryptosuites TLV SHOULD be included in 
                                      the EAP Initiate/Pre-Early-auth message.
                              </t>
                              <t>
                                      KeyName-NAI: This is a TLV payload. Type = 1. 
                                      When the S Bit is set to 1, exactly one KeyName-NAI attribute SHOULD be present 
                                      in an EAP Initiate/Pre-Early-auth packet.
                              </t>
                              <t>
                                      Sequence Number: It is carried in a TV payload.  
                                      The Type is TBD  (which is lower than 128). When the C flag is set to 1, 
                                      exactly one sequence number SHOULD be present in an EAP Initiate/Pre-Early-auth packet.
                              </t>
                              <t>
                                      Cryptosuite: This field indicates the integrity algorithm and the
                                      PRF used for EEP. Key lengths and output lengths are either
                                      indicated or obvious from the cryptosuite name.
                              </t>
                              <t>We specify some cryptosuites below:</t>

            <t>*  0 RESERVED</t>

            <t>*  1 HMAC-SHA256-64</t>

            <t>*  2 HMAC-SHA256-128</t>

            <t>*  3 HMAC-SHA256-256</t>

            <t>
              HMAC-SHA256-128 is mandatory to implement and should be enabled in
              the default configuration.
            </t>
                              <t>
                                      Authentication Tag: This field contains the integrity checksum 
                                      over the EEP packet, excluding the authentication tag field 
                                      itself.  The length of the field is indicated by the Cryptosuite.
                              </t>
                              <t>
                                      Authentication Tag is calculated using pIK derived from EMSK
                                      or DS-pIK derived from DSRK.
                              </t>
                </section>
                
                <section title="EAP Finish/Pre-Early-auth">

<figure align="center" anchor="eepFinishPre" title="EAP Finish/Pre-Early-auth Packet"><artwork>   
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Code     |   Identifier  |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type     |R|S|A|C|Reserved|           SEQ                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   1 or more TVs or TLVs                     ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Cryptosuite |            Authentication Tag                 ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>
                            <t>Code = 6(EAP Finish)</t>
                                <t>
                                   Identifier
                                </t>
                                <t>
                                   Refer to <xref target="RFC5296"/> Section 5.3
                                </t>
                                <t>Type = 3(Pre-Early-auth)</t>
                            <t>
                         Flags
                </t>
                <t>
                         'R' - Result flag, value 0 Indicate success, 1 Indicate failure.
                </t>    
                <t> 
                         'S' - The value of secure flag indicate whether cryptosuite and authentication tag is appended.
                </t>
                <t>
                                     0 Cryptosuite and Authentication Tag are not appended.
                                  </t>
                                  <t>
                                     1 Cryptosuite and Authentication Tag are appended at the end of message.
                            </t>
          <t>
                         'A' - Authentication flag, value:
                </t>
                <t>
                                     0 Full EAP authentication is not required.
                                  </t>
                                  <t>
                                     1 Full EAP authentication is required.
                            </t>
                        <t>
                                     If MH set A flag to 1 in EAP Initiate/Pre-Early-auth message, the 
                                     AAA server either rejects the early authentication or set A flag
                                     to 1 in EAP Finish/Pre-Early-auth message.
                </t>
                <t>
                         'C' - Continue flag:
                </t>
                <t>
                                     0 This is a normal Pre-Early-auth message.
                                  </t>
                                  <t>
                                     1 This message is used to extend the lifetime of Pre-Early-auth session.
                </t>
                <t>
                        SEQ
                </t>
                <t>
                        A 16-bit sequence number is used for replay protection.
                </t>
                <t>     
                        TVs and TLVs
                </t>
                <t>
                                    pMSK Lifetime: This is a TV payload.  
                                    The value field is a 32-bit field and contains the lifetime of pMSK generated in 
                                    early authentication.</t>
                                
<figure align="center" anchor="pmskLife" title="pMSK Lifetime"><artwork>

0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type     |                pMSK Lifetime                  ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>

          <t>Type = TBD</t>

                                  <t>
                                    The life time is calculated after the pMSK has been generated. 
                                    That is to say, if full authentication is require, the life 
                                    time is started after EAP authentication. If the pMSK life time expired, the MH should do 
                                    Pre-Early-auth again and Post-Early-auth will be rejected.
                            </t>
                            <t>
                                    pRK Lifetime: This is a TV payload.  
                                    The value field is a 32-bit field and contains the lifetime of pRK generated in 
                                    early authentication.
                            </t>
                        
<figure align="center" anchor="FinishPacket22" title="pRK Lifetime"><artwork>
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type     |                 pRK Lifetime                  ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>

          <t>Type = TBD</t>
                        
                            <t>
                                    Result Code: When R flag is set to 1, this TV payload MAY be included in EAP Finish/Pre-Early-auth message.
                            </t>
                            <t>
                                List of cryptosuites: This is a TLV payload, type is 5. Exactly one List of cryptosuites TLV 
                                SHOULD be included in the EAP Finish/Pre-Early-auth message. It will help MH to select proper 
                                crypto suite to do key verification in Post-Early-auth phase.
                            </t>
                            <t>
                                    KeyName-NAI: This is a TLV payload. Type = 1. 
                                    When the S flag is set to 1, exactly one KeyName-NAI attribute SHOULD be present in an 
                                EAP Finish/Pre-Early-auth packet.
                            </t>
                            <t>
                        Cryptosuite: This field indicates the integrity algorithm and the
                                    PRF used for EEP.  Key lengths and output lengths are either
                                    indicated or are obvious from the Cryptosuite name.
                            </t>
                            <t>
                                    Authentication Tag: This field contains the integrity checksum 
                                    over the EEP packet, excluding the authentication tag field 
                                    itself.  The length of the field is indicated by the Cryptosuite.
                            </t>
                            <t>
                                    Authentication Tag is calculated using pIK derived from EMSK
                                    or DS-pIK derived from DSRK.
                            </t>
                </section>
                
                <section title="EAP Initiate/Post-Early-auth">

 <figure align="center" anchor="eepInitPost" title="EAP Initiate/Post-Early-auth Packet"><artwork>   
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Code      |   Identifier  |             Length            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Type      |R|S|A|Reserved |             SEQ               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    1 or more TVs or TLVs                    ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Cryptosuite |             Authentication Tag                ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>
                            <t>Code = 5(EAP Initiate)</t>
                                <t>
                                   Identifier
                          </t>
                          <t>
                                   Refer to <xref target="RFC5296"/> Section 5.3
                                </t>
                                <t>Type = 4(Post-Early-auth)</t>
        
                      <t>
                        Flags
                </t>
                <t>
                        'R' - Result flag, Value MUST be zero and ignored on reception.
                </t>    
                <t>
                        'S' - Secure flag, value MUST be 1 and Cryptosuite and Authentication Tag must be appended at the end 
                              of message.
                </t>
                <t>
                        'A' - Authentication flag, value MUST Be 0 and full EAP authentication is not required.
                      </t>
                <t>
                        SEQ
                </t>
                <t>
                        A 16-bit sequence number is used for replay protection.
                </t>
                <t>     
                        TVs and TLVs
                </t>
                <t>
                        NAS-Identifier: This is a TLV payload, type is 4. 
                        Exactly one NAS-Identifier or NAS-Identifier-NAI TLV SHOULD be included in 
                        the EAP Initiate/Post-Early-auth message. 
                      </t>
                      <t>
                              NAS-Identifier-NAI: This is a TLV payload, type is TBD. 
                              Exactly one NAS-Identifier or NAS-Identifier-NAI TLV SHOULD be included in 
                              the EAP Initiate/Post-Early-auth message. 
                      </t>
                      <t>
                              KeyName-NAI: This is a TLV payload. Type = 1. 
                              Exactly one KeyName-NAI attribute MUST be present in an EAP Finish/Post-Early-auth packet.
                      </t>
                      <t>
                        Cryptosuite: This field indicates the integrity algorithm and the
                              PRF used for EEP. Key lengths and output lengths are either
                              indicated or are obvious from the Cryptosuite name.
                      </t>
                      <t>
                              Authentication Tag: This field contains the integrity checksum 
                              over the EEP packet, excluding the authentication tag field 
                              itself.  The length of the field is indicated by the Cryptosuite.
                      </t>
                      <t>
                              Authentication Tag is calculated using pIK derived from EMSK
                              or DS-pIK derived from DSRK.
                      </t>
                </section>
                
                <section title="EAP Finish/Post-Early-auth">

 <figure align="center" anchor="eepFinishPost" title="EAP Finish/Post-Early-auth Packet"><artwork>   
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Code      |   Identifier  |             Length            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Type      |R|S|A|Reserved |             SEQ               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    1 or more TVs or TLVs                    ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Cryptosuite |             Authentication Tag                ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>
          <t>Code = 6(EAP Finish)</t>
                      <t>
                                   Identifier
                          </t>
                          <t>
                       Refer to <xref target="RFC5296"/> Section 5.3
                                </t>
                <t>Type =       4(Post-Early-auth)</t>

                      <t>
                        Flags
                </t>
                <t>
                  'R' - Result flag, value 0 Indicate success, 1 Indicate failure.
          </t>  
          <t> 
                  'S' - The value of secure flag indicate whether cryptosuite and authentication tag is appended.
          </t>
          <t>
                              0 Cryptosuite and Authentication Tag are not appended.
                            </t>
                            <t>
                              1 Cryptosuite and Authentication Tag are appended at the end of message.
                      </t>
          <t>
                  'A' - Authentication flag, value:
          </t>
          <t>
                              0 Full EAP authentication is not required.
                            </t>
                            <t>
                              1 Full EAP authentication is required.
                      </t>
                  <t>
                              If MH set A flag to 1 in EAP Initiate/Pre-Early-auth message, the 
                              AAA server either rejects the early authentication or set A flag
                              to 1 in EAP Finish/Pre-Early-auth message.
          </t>
                <t>
                        SEQ
                </t>
                <t>
                        A 16-bit sequence number is used for replay protection.
                </t>
                <t>     
                        TVs and TLVs
                </t>
                <t>
                        Result Code: When R flag is set to 1, this TV payload MAY be included in 
                        EAP Finish/Post-Early-auth message. 
                      </t>
                      <t>
                              List of cryptosuites: This is a TLV payload, type is 5. If the Result Code is 2 
                              (crypto cipher suite is not supported). 
                              This TLV should be included in the EAP Finish/Post-Early-auth message. 
                      </t>
                      <t>
                              KeyName-NAI: This is a TLV payload. Type = 1. If the Result Code is 3 (key is not found), 
                              the TLV should not be included in the EAP Finish/Post-Early-auth message and S Bit should be set to 0.
                              When the S flag is set to 1, exactly one KeyName-NAI attribute SHOULD be present in an 
                              EAP Finish/Post-Early-auth packet.
                      </t>
                      <t>
                        Cryptosuite: This field indicates the integrity algorithm and the
                              PRF used for EEP.  Key lengths and output lengths are either
                              indicated or are obvious from the Cryptosuite name.
                      </t>
                      <t>
                              Authentication Tag: This field contains the integrity checksum 
                              over the EEP packet, excluding the authentication tag field 
                              itself.  The length of the field is indicated by the Cryptosuite.
                      </t>
                      <t>
                              Authentication Tag is calculated using pIK derived from EMSK
                              or DS-pIK derived from DSRK.
                      </t>
                    </section>
                    <section title="EAP Initiate/Early-auth Action" anchor="EIRaPE">
                        <t>
                      The functionality of message EAP Initiate/Early-auth Action message is based on its sub type.
                                  The detailed information refers to the description of sub type field. 
                        </t>

<figure anchor="resultBit" align="center" title="EAP Initiate/Early-auth Action Packet"><artwork>   
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Code    |   Identifier  |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Type    |R|S| Reserved  |            SEQ                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   SubType   |              1 or more TVs or TLVs            ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Cryptosuite |              Authentication Tag               ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>
            <t>
                                       Code = 5(EAP Initiate).
                                    </t>
                                  <t>
                                     Identifier
                                  </t>
                                  <t>
                                     Refer to <xref target="RFC5296"/> Section 5.3
                                  </t>
                                  <t>
                                     Type = 5(Early-auth Action).
                                  </t>
                        <t>
                                Flags
                        </t>
                        <t>
                                'R' - The value of result flag MUST be zero and ignored on reception.
                        </t>
                        <t> 
                                'S' - The value of secure flag indicate whether cryptosuite and authentication tag is appended.
                  </t>
                        <t>
                                      0 Cryptosuite and Authentication Tag are not appended.
                                    </t>
                                    <t>
                                      1 Cryptosuite and Authentication Tag are appended at the end of message.
                              </t>
                        <t>
                                      When the EAP Initiate/Early-auth action message is transferred 
                                      between SAP-AAA and Home-AAA, S Bit = 0.
                        </t>
                        <t>
                                SEQ
                        </t>
                        <t>
                                A 16-bit sequence number is used for replay protection.
                        </t>
                              <t>
                                Sub Type
                        </t>
                        <t>
                                      1 Early authentication Probe message. The message is sent by MH to SAP to probe 
                                      whether the early authentication for specified CAP is supported.
                                    </t>
                                    <t>
                                      2 De-Pre-Early-auth message. The message is sent by MH to SAP to release the early authentication
                                      with specified CAP.
                                    </t>
                                    <t>
                                      To avoid obsolete early authentication session, MH may release its established early authentication
                                      session before it disconnecting from the network.
                                    </t>
                                    <t>
                                      3 De-Post-Early-auth message. The message is sent by MH to SAP to change the current fully authenticated
                                      state to early authenticated state.
                                    </t>
                                    <t>
                                      This message is used to adapt to the situation where MH keep moving between 2 AAA realms.
                        </t>
                        <t>
                                TVs and TLVs
                        </t>
                        <t>
                                      NAS-Identifier: As defined in <xref target="RFC5296"/>, it is carried in a TLV payload.  
                                      It is used to indicate the identifier of a CAP. One or more NAS-identifier MAY be included
                                      in EAP Initiate/Early-auth Action message sent by MH. The Local Domain is considered as 
                                      the AAA realm for this CAP.
                              </t>                              
<figure anchor="nasId" align="center" title="NAS-Identifier"><artwork>
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type     |     Length    |       NAS-Identifier          ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>

             <t>Type = 4 </t>
             <t>Length >= 1 </t>
              
                                     <t>NAS-Identifier-NAI:  </t>       
                                     <t>
                                       The NAI is variable in length, not exceeding 253 octets.  
                                       The NAS-identifier is in the username part of the NAI.  
                                       The realm part of the NAI is the visited domain name. 
                                       One or more NAS-identifier-NAI MAY be included in EAP Initiate/Early-auth Action message sent by MH.
             </t>                               
                                
<figure anchor="nasId-nai" align="center" title="NAS-Identifier-NAI"><artwork>
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type     |     Length    |      NAS-Identifier-NAI       ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>

            <t>Type = TBD</t>   
            <t>Length >= 1</t>  

             
                                    <t>KeyName-NAI: This is a TLV payload.  
                                       The NAI is variable in length, not exceeding 253 octets.  
                                       The EMSK name is in the username part of the NAI and is encoded in hexadecimal values.  
                                       The EMSK name is 64 bits in length and so the username portion takes up 128 octets. 
                                       The realm part of the NAI is the visited domain name. When the S Bit is set to 1, 
                                       exactly one KeyName-NAI attribute SHOULD be present in an EAP Initiate/Early-auth Action packet.
                              </t>      
<figure anchor="keyName" align="center" title="KeyName-NAI"><artwork>
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type     |     Length    |         KeyName-NAI           ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>

            <t>Type = 1</t>     
            <t>Length >= 1</t>  
                        <t>     
                                      The authenticator uses the realm in the KeyName-NAI field to 
                                      send the message to the appropriate EEP server.
                              </t>
                        <t>
                          Cryptosuite: This field indicates the integrity algorithm and the
                                      PRF used for EEP.  Key lengths and output lengths are either
                                      indicated or are obvious from the Cryptosuite name.
                              </t>
                              <t>
                                      Authentication Tag: This field contains the integrity checksum 
                                      over the EEP packet, excluding the authentication tag field 
                                      itself.  The length of the field is indicated by the Cryptosuite.
                              </t>                              
                              <t>
                                      Authentication Tag is calculated using pIK derived from EMSK
                                      or DS-pIK derived from DSRK.
                              </t>
                </section>
        
                <section title="EAP Finish/Early-auth Action">
                        <t>
                                      EAP Finish/Early-auth Action is sent by SAP-AAA through SAP to inform MH the action results.
                                      For De-Pre-Early-auth and De-Post-Early-auth, reply message is not required. 
                                      So corresponding sub type is not defined. 
                                    </t>

<figure align="center" anchor="eepEarly" title="EAP Finish/Early-auth Action Packet"><artwork>
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Code    |   Identifier  |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Type    |R|S| Reserved  |            SEQ                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Sub Type   |          1 or more TVs or TLVs                ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Cryptosuite |            Authentication Tag                 ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>
            <t>Code = 5(EAP Initiate)</t>
            <t>
                                     Identifier
                                  </t>
                                  <t>
                                     Refer to <xref target="RFC5296"/> Section 5.3
                                  </t>
            <t>Type = 5(Early-auth Action)</t>                          
                        <t>
                                Flags
                        </t>
                        <t>
                                'R' - Result flag, value 0 Indicate success, 1 Indicate failure.
                        </t>    
                        <t> 
                                'S' - The value of secure flag indicate whether cryptosuite and authentication tag is appended.
                  </t>
                        <t>
                                      0 Cryptosuite and Authentication Tag are not appended.
                                    </t>
                                    <t>
                                      1 Cryptosuite and Authentication Tag are appended at the end of message.
                              </t>
                        <t>
                                SEQ
                        </t>
                        <t>
                                A 16-bit sequence number is used for replay protection.
                        </t>
                        <t>
                                Sub Type
                        </t>
                        <t>
                                1 Early authentication Probe message.
                        </t>
                        <t>     
                                TVs and TLVs
                        </t>
                        <t>
                                      Result Code: When R Bit is set to 1, this TV payload MAY be 
                                      included in EAP Finish/Early-auth Action message.</t>
                                
<figure align="center" anchor="resultCode" title="Result Code"><artwork> 

0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type     |                 Result code                   ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>

            <t>Type = TBD</t>
            <t>Result code</t>
            <t>0        Success</t>
            <t>1        Unspecified failure</t>
            <t>2        Cryptosuite is not supported</t>
            <t>3        Key is not found</t>
            <t>4  Fail to verify the authentication tag</t>
            <t>5~9      Reserved</t>
            <t>10       Early authentication is not supported</t>
            <t>11~20    Reserved</t>
            <t>21       Early authentication session is not found for this CAP</t>


                                    <t>
                                       Probe Result: This is TLV payload.  
                                       If the Result Code is 0 (success), The number of Probe Results in EAP Finish/Early-
                                       auth action message should be identical to the number of NAS-ids and NAS-id-NAIs in 
                                       EAP Initiate/Early-auth Action message.
                                    </t>
                                
<figure align="center" anchor="statusCode" title="Probe Result"><artwork>
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type     |     Length    |      NAS-Id or NAS-Id-NAI     ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Status Code |
+-+-+-+-+-+-+-+
</artwork></figure>

            <t>Type = TBD</t>
            <t>Length >= 2</t>

            <t>Status Code:</t>
            <t>0  EEP is supported for this CAP</t>
            <t>1  EEP is not supported for this CAP</t>

                        
                  <t>
                     List of cryptosuites: This is a TLV payload. If the Result Code is 2, crypto cipher suite is not supported.
                     This TLV MAY be included in the EAP Finish/Early-auth Action message.
                  </t>

                                    <t>
                                       The value field contains a list of crypto suites, each of size 1 octet. The SAP-AAA include this attribute in the EAP 
                                       Finish/Early-auth Action message to signal to the MH about its cryptographic algorithm capabilities. 
                                       The Cryptosuite values are as specified:
                              </t>
                                
<figure align="center" anchor="cryptSuite" title="List of cryptosuites"><artwork>
0                 1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Type    |     Length    | crypto suite1 | crypto suite2 ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork></figure>
            <t>Type = 5</t>
            <t>Length >= 1</t>
            <t>Crypto suite</t>
            <t>0  RESERVED</t>
            <t>1  HMAC-SHA256-64</t>
            <t>2  HMAC-SHA256-128 (Mandatory to implement and should be enabled in the default configuration)</t>
            <t>3  HMAC-SHA256-256 </t>
        
                        <t>
                                      KeyName-NAI: This is a TLV payload.  Type = 1.  
                                      If the S flag is set to 1, exactly one KeyName-NAI TLV should be included in EAP Finish/Early-auth Action message.
                                      If R flag is set to 1 and the Result Code is 3 (key is not found), 
                                      the TLV should not be included in the EAP Finish/Early-auth Action message and S flag should be set to 0.
                              </t>
                              <t>
                                Cryptosuite: This field indicates the integrity algorithm and the
                                      PRF used for EEP. Key lengths and output lengths are either
                                      indicated or are obvious from the Cryptosuite name.
                              </t>
                              <t>
                                      Authentication Tag: This field contains the integrity checksum 
                                      over the EEP packet, excluding the authentication tag field 
                                      itself.  The length of the field is indicated by the Cryptosuite.
                              </t>
                              <t>
                                      Authentication Tag is calculated using pIK derived from EMSK
                                      or DS-pIK derived from DSRK.
                              </t>
                   </section>
                </section>
                <section title="Lower Layer Considerations">
                        <t>
                                Similar to ERP, some lower layer specifications may need to be revised
                                to support EEP; refer to section 6 of <xref target="RFC5296"></xref>
                                for additional guidance.
                        </t>
                </section>

                <section anchor="AAA" title="AAA Transport Considerations">
                        <t>
                                AAA transport of EEP messages is the same as AAA transport of the ERP
                                message <xref target="RFC5296"></xref>. In addition, the document requires 
                                AAA transport of the EEP keying materials delivered by the EEP server to the CAP.
                                Hence, a new Diameter EEP application message should be specified to transport 
                                the keying materials.
                        </t>
                </section>

                <section title="Security Considerations">
                        <t>
                                TBD.
                        </t>
                </section>

                <section title="IANA Considerations">
                <t>
                        New TLV types:
                        <list>
                        <t>
                                NAS-Identifier
                        </t>
                        <t>
                                Sequence number
                        </t>
                        <t>
                                NAS-Identifier-NAI
                        </t>
                        <t>
                                pMSK lifetime
                        </t>
                        <t>
                                pRK lifetime
                        </t>
                        <t>
                                Result code
                        </t>
                        <t>
                                Probe result
                        </t>
                </list>
        </t>
          </section>

                <section title="Acknowledgements">
                        <t>
                                Thanks to Qin Wu for guiding some technique solution and helpful comments on this document.
                        </t>
                </section>
        </middle>

        <back>
                <references title="Normative References">
                        &rfc2119;
                        &rfc5296;
                </references>
                <references title="Informative References">
                        &rfc5836;
                        &I-D.ietf-dime-local-keytran;
                        &rfc3588;
                        &rfc3748;
                        &I-D.ietf-hokey-erp-aak;
                </references>
        </back>
</rfc>


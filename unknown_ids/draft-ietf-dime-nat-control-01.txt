

Internet Engineering Task Force                             F. Brockners
Internet-Draft                                               S. Bhandari
Intended status: Standards Track                                   Cisco
Expires: April 26, 2010                                         V. Singh
                                                         Mavenir Systems
                                                              V. Fajardo
                                                  Telcordia Technologies
                                                        October 23, 2009


                    Diameter NAT Control Application
                     draft-ietf-dime-nat-control-01

Status of this Memo

   This Internet-Draft is submitted to IETF in full conformance with the
   provisions of BCP 78 and BCP 79.

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF), its areas, and its working groups.  Note that
   other groups may also distribute working documents as Internet-
   Drafts.

   Internet-Drafts are draft documents valid for a maximum of six months
   and may be updated, replaced, or obsoleted by other documents at any
   time.  It is inappropriate to use Internet-Drafts as reference
   material or to cite them other than as "work in progress."

   The list of current Internet-Drafts can be accessed at
   http://www.ietf.org/ietf/1id-abstracts.txt.

   The list of Internet-Draft Shadow Directories can be accessed at
   http://www.ietf.org/shadow.html.

   This Internet-Draft will expire on April 26, 2010.

Copyright Notice

   Copyright (c) 2009 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to BCP 78 and the IETF Trust's Legal
   Provisions Relating to IETF Documents in effect on the date of
   publication of this document (http://trustee.ietf.org/license-info).
   Please review these documents carefully, as they describe your rights
   and restrictions with respect to this document.





Brockners, et al.        Expires April 26, 2010                 [Page 1]

Internet-Draft      Diameter NAT Control Application        October 2009


Abstract

   This document describes the framework, messages, and procedures for
   the Diameter NAT Control Application (DNCA), allowing for per-
   endpoint control of large scale NAT devices, which are put in place
   to cope with IPv4-address space completion.  The Diameter NAT Control
   Application allows external devices to configure and manage a Large
   Scale NAT (LSN) device - expanding the existing Diameter-based AAA
   and policy control capabilities with a NAT control component.  These
   external devices can be network elements in the data plane such as a
   Network Access Server (NAS), or can be more centralized control plane
   devices such as AAA-servers.  DNCA establishes a context to commonly
   identify and manage endpoints on a gateway or server, and a large
   scale NAT device.  This includes, for example, the control of the
   total number of NAT-bindings allowed or the allocation of a specific
   NAT-binding for a particular endpoint.  In addition, it allows large
   scale NAT devices to provide information relevant to accounting
   purposes.

































Brockners, et al.        Expires April 26, 2010                 [Page 2]

Internet-Draft      Diameter NAT Control Application        October 2009


Table of Contents

   1.  Introduction . . . . . . . . . . . . . . . . . . . . . . . . .  5
   2.  Conventions  . . . . . . . . . . . . . . . . . . . . . . . . .  6
   3.  Deployment framework and DNCA capabilities . . . . . . . . . .  6
     3.1.  Diameter NAT Control Application capabilities  . . . . . .  6
     3.2.  LSN Control Deployment Framework . . . . . . . . . . . . .  7
       3.2.1.  LSN Deployment scenario  . . . . . . . . . . . . . . .  8
       3.2.2.  Diameter NAT Control Application overview  . . . . . .  9
       3.2.3.  Deployment scenarios for the Diameter NAT Control
               Application  . . . . . . . . . . . . . . . . . . . . .  9
   4.  Diameter NAT Control Application Session Establishment and
       Management . . . . . . . . . . . . . . . . . . . . . . . . . . 12
     4.1.  Parties involved . . . . . . . . . . . . . . . . . . . . . 12
     4.2.  Session Establishment  . . . . . . . . . . . . . . . . . . 12
     4.3.  Session Re-Authorization . . . . . . . . . . . . . . . . . 14
     4.4.  Session and Binding Query  . . . . . . . . . . . . . . . . 16
     4.5.  Session Termination  . . . . . . . . . . . . . . . . . . . 18
     4.6.  DNCA Manager/Agent failures  . . . . . . . . . . . . . . . 19
   5.  Use of the DIAMETER base protocol  . . . . . . . . . . . . . . 20
     5.1.  Securing DIAMETER messages . . . . . . . . . . . . . . . . 20
     5.2.  Accounting functionality . . . . . . . . . . . . . . . . . 21
     5.3.  Use of sessions  . . . . . . . . . . . . . . . . . . . . . 21
     5.4.  Routing considerations . . . . . . . . . . . . . . . . . . 21
     5.5.  Advertising Application support  . . . . . . . . . . . . . 21
   6.  Diameter NAT Control Application Commands  . . . . . . . . . . 22
     6.1.  NAT-Control Request (NCR) Command  . . . . . . . . . . . . 22
     6.2.  NAT-Control Answer (NCA) Command . . . . . . . . . . . . . 22
   7.  Diameter NAT Control Application AVPs  . . . . . . . . . . . . 23
     7.1.  Reused Base Protocol AVPs  . . . . . . . . . . . . . . . . 23
     7.2.  Additional Result-Code AVP values  . . . . . . . . . . . . 24
       7.2.1.  Success  . . . . . . . . . . . . . . . . . . . . . . . 24
       7.2.2.  Transient failures . . . . . . . . . . . . . . . . . . 25
       7.2.3.  Permanent failures . . . . . . . . . . . . . . . . . . 25
     7.3.  Reused NASREQ Diameter application AVPs  . . . . . . . . . 26
     7.4.  Reused from RFC 4675 . . . . . . . . . . . . . . . . . . . 26
     7.5.  Reused from Diameter QoS Application . . . . . . . . . . . 27
     7.6.  Reused from ETSI ES 283 034, e4 Diameter application . . . 27
     7.7.  Diameter NAT Control Application Defined AVPs  . . . . . . 28
       7.7.1.  NC-Request-Type AVP  . . . . . . . . . . . . . . . . . 28
       7.7.2.  NAT-Control-Install AVP  . . . . . . . . . . . . . . . 29
       7.7.3.  NAT-Control-Remove AVP . . . . . . . . . . . . . . . . 29
       7.7.4.  NAT-Control-Definition AVP . . . . . . . . . . . . . . 30
       7.7.5.  NAT-Internal-Address AVP . . . . . . . . . . . . . . . 30
       7.7.6.  NAT-External-Address AVP . . . . . . . . . . . . . . . 31
       7.7.7.  Max-NAT-Bindings . . . . . . . . . . . . . . . . . . . 31
       7.7.8.  NAT-Control-Binding-Rule AVP . . . . . . . . . . . . . 31
       7.7.9.  Duplicate-Session-Id AVP . . . . . . . . . . . . . . . 31



Brockners, et al.        Expires April 26, 2010                 [Page 3]

Internet-Draft      Diameter NAT Control Application        October 2009


   8.  Accounting Commands  . . . . . . . . . . . . . . . . . . . . . 31
     8.1.  NAT Control Accounting Messages  . . . . . . . . . . . . . 32
     8.2.  NAT Control Accounting AVPs  . . . . . . . . . . . . . . . 32
       8.2.1.  NAT-Control-Record . . . . . . . . . . . . . . . . . . 32
       8.2.2.  NAT-Control-Binding-Status . . . . . . . . . . . . . . 32
       8.2.3.  Current-NAT-Bindings . . . . . . . . . . . . . . . . . 33
   9.  AVP Occurrence Table . . . . . . . . . . . . . . . . . . . . . 33
     9.1.  DNCA AVP Table for NAT control initial and update
           requests . . . . . . . . . . . . . . . . . . . . . . . . . 34
     9.2.  DNCA AVP Table for Session Query request . . . . . . . . . 34
     9.3.  DNCA AVP Table for NAT Control Terminate requests  . . . . 34
     9.4.  DNCA AVP Table for accounting message  . . . . . . . . . . 35
   10. IANA Considerations  . . . . . . . . . . . . . . . . . . . . . 35
     10.1. Command Codes  . . . . . . . . . . . . . . . . . . . . . . 35
     10.2. AVP Codes  . . . . . . . . . . . . . . . . . . . . . . . . 36
     10.3. AVP Values . . . . . . . . . . . . . . . . . . . . . . . . 36
       10.3.1. Result-Code AVP Values . . . . . . . . . . . . . . . . 36
     10.4. Application IDs  . . . . . . . . . . . . . . . . . . . . . 37
   11. Security Considerations  . . . . . . . . . . . . . . . . . . . 37
   12. Change history (to be removed prior to publication as an
       RFC) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 38
   13. References . . . . . . . . . . . . . . . . . . . . . . . . . . 38
     13.1. Normative References . . . . . . . . . . . . . . . . . . . 38
     13.2. Informative References . . . . . . . . . . . . . . . . . . 39
   Authors' Addresses . . . . . . . . . . . . . . . . . . . . . . . . 39


























Brockners, et al.        Expires April 26, 2010                 [Page 4]

Internet-Draft      Diameter NAT Control Application        October 2009


1.  Introduction

   With the foreseeable depletion of available IPv4 addresses from the
   IANA pool, service providers are starting to consider network designs
   which no longer assign unique global IPv4 addresses to their
   subscribers.  One of the approaches considered, is the deployment of
   a provider-operated large scale NAT device between the end-users and
   the Internet.  Nishitani et al.  [I-D.nishitani-cgn] call this NAT
   device a "Large Scale NAT (LSN)".

   LSNs will be inserted into the existing subscriber access and
   aggregation networks which typically provide for per-endpoint service
   management and control as well as per-endpoint accounting.  Per-
   endpoint rules include those which relate to service offerings of the
   SP (e.g. access bandwidth, time or volume based access restrictions)
   as well as rules which follow legal regulations of the "National
   Regulation Authorities (NRA)".  The introduction of a LSN impacts the
   per-endpoint service offerings as well as the regulatory requirements
   and gives rise to new control requirements within the service
   provider network: Service providers need to manage the behavior of
   the LSN on a per-endpoint basis.

   The per-endpoint management capabilities of a LSN comprise, for
   example the control of the number of NAT-address-port pairs (often
   called "NAT-bindings" or simply "bindings") allocated to a single
   endpoint.  Given that global IPv4 address-port pairs are becoming a
   scarce resource, several service providers intend to restrict the
   number of NAT-bindings on a per endpoint basis and thus increase
   address utilization efficiency.  The number of bindings an endpoint
   can consume becomes another parameter within a tiered-service
   offering.  In addition, the service provider might offer static
   bindings to endpoints or pre-allocate external IP-address/port-ranges
   to certain endpoints.  One of the NRA requirements is that a service
   provider needs to provide the identity of a user (which e.g.
   translates to the public IP address and ports leveraged by the user
   at a given point in time) upon request.

   Dynamic per-endpoint management at the LSN requires an associated
   interface that has to be tightly integrated with the existing per-
   endpoint authentication, authorization, and accounting (AAA)
   environment of the service provider.

   This document describes the framework, messages and procedures for
   the Diameter carrier-grade NAT Control Application (DNCA).  The DNCA
   interacts with the LSN to coordinate per-endpoint configuration and
   management of subscriber traffic traversing the LSN.  Use of a
   Diameter application allows for simple integration into the existing
   AAA environment of a service provider.



Brockners, et al.        Expires April 26, 2010                 [Page 5]

Internet-Draft      Diameter NAT Control Application        October 2009


2.  Conventions

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [RFC2119].

   Abbreviations are used in this document:

      AAA: Authentication, Authorization, Accounting

      DNCA: Diameter NAT Control Application

      LSN: Large Scale NAT device

      NAT: Network Address Translation

      NAS: Network Access Server

      NAT-Binding or Binding: Association of two IP-address/port pairs
      (with one IP-address typically being private and the other one
      public) to facilitate NAT

      NRA: National Regulatory Authority


3.  Deployment framework and DNCA capabilities

3.1.  Diameter NAT Control Application capabilities

   The Diameter NAT control application offers the following
   capabilities:

   1.  Limit the number of NAT-bindings per endpoint: Define/restrict
       the maximum number of NAT-bindings on a per-endpoint basis.  This
       enables service providers to offer differentiated services based
       on the number of bindings and hence optimize the consumption of
       IP-address/port-ranges.

   2.  Request the allocation of specific NAT-bindings: Under normal
       operation the LSN would allocate NAT-bindings based on rules and
       algorithms local to the LSN.  Fixed or pre-defined bindings would
       be the exception rather than the rule but are essential for
       certain deployment scenarios.  Requests for NAT-binding
       allocation could happen either at or after initial session
       establishment.  Two cases could be distinguished:

       *  Request the allocation of a pre-defined NAT-binding.  Both the
          internal as well as the external IP-address/port pair are



Brockners, et al.        Expires April 26, 2010                 [Page 6]

Internet-Draft      Diameter NAT Control Application        October 2009


          specified within the request.  Some deployment cases, such as
          access to a web-server within a user's home network with IP-
          address and port, benefit from statically configured bindings.

       *  Request the allocation of an external IP-address for a given
          internal IP-address and report the allocated external IP-
          address back to the requestor.  In some deployment scenarios,
          the application requires immediate knowledge of the allocated
          binding for a given internal IP-address but does not control
          the allocation of the external IP-address (e.g.  SIP-proxy
          server deployments).

   3.  Define the external address-pool(s) to be used for allocating an
       external IP-address.  External address-pools can either be pre-
       defined on the LSN, or specified within a request.  If pre-
       defined address-pools are used, a request would just include a
       reference (e.g. name) to an already defined address pool on LSN.
       Otherwise, the request will contain a description of the IP-
       address pool(s) to be used (e.g. list of IP-subnets).

   4.  Accounting/Reporting: Report established bindings for a
       particular user.  Apart from statistical and charging purposes,
       binding reporting is also required for legal reasons.  Most
       National Regulatory Authorities (NRA) require that service
       providers provide the identity of a user upon request.  The
       service provider needs to be able to correlate a tuple (public
       IP-address, port, time) to a particular user or endpoint.

   5.  Flexible Information Query: Report details and statistics of
       bindings for a single endpoint or a set of endpoints through an
       external interface which integrates with the overall per-endpoint
       management suite.  Hence this information query capability of the
       DNCA potentially complements alternative information query
       mechanisms such as SNMP-based mechanisms.

   6.  Global Endpoint ID: The global endpoint ID will allow for common
       identification of an endpoint on a LSN as well as other endpoint-
       or subscriber-aware devices such as a Network Access Server (NAS)
       or an AAA system.  Endpoints are identified through a single or a
       set of classifiers such as IP address, VLAN identifier, or
       interface identifier which uniquely identify the traffic
       associated with a particular global endpoint.

3.2.  LSN Control Deployment Framework







Brockners, et al.        Expires April 26, 2010                 [Page 7]

Internet-Draft      Diameter NAT Control Application        October 2009


3.2.1.  LSN Deployment scenario

   Figure 1 shows a typical network deployment for internet access.  A
   user's IPv4-host gains access to the internet though a Network Access
   Server (NAS) which facilitates the authentication of the endpoint and
   configures the user's connection according to the authorization and
   configuration data received from the AAA-server upon successful
   authentication.  Public IPv4 addresses are used throughout the
   network.

                             +---------+
                             |         |
                             |   AAA   |
                             |         |
                             +---------+
                                  |
                                  |
                                  |
                                  |
          +---------+          +---------+             +----------+
          |  IPv4   |          |         |             |  IPv4    |
          |  Host   |----------|   NAS   |-------------| Internet |
          |         |          |         |             |          |
          +---------+          +---------+             +----------+

          <-------------------- Public IPv4 ---------------------->

         Figure 1: Typical network deployment for internet access

   Figure 2 depicts the deployment scenario when a service provider
   introduces a LSN to increase the efficiency of the global IPv4
   address pool utilization.  The objective is to provide the customer
   with connectivity to the public IPv4 Internet.  The LSN performs
   network address translation between private IPv4 addresses and public
   IPv4 addresses.  If the LSN would be put in place without any
   endpoint awareness, the service offerings of the service provider
   would be hampered.  Provisioning static NAT-bindings for particular
   endpoints, using different public IP-address pools for different set
   of endpoints (e.g. residential or business customers), as well as
   reporting on the allocated bindings on a per-endpoint basis would be
   burdensome for a service provider if the LSN would not be aware of
   endpoints and allow for per-endpoint control and management which
   easily integrates with the already existing per-endpoint management
   infrastructure of the service provider.







Brockners, et al.        Expires April 26, 2010                 [Page 8]

Internet-Draft      Diameter NAT Control Application        October 2009


                         +---------+
                         |         |
                         |   AAA   |
                         |         |
                         +---------+
                              |
                              |
                              |
                              |
           +--------+    +---------+    +---------+    +----------+
           |  IPv4  |    |         |    |         |    |  IPv4    |
           |  Host  |----|   NAS   |----|   LSN   |----| Internet |
           |        |    |         |    |         |    |          |
           +--------+    +---------+    +---------+    +----------+

           <-------- Private IPv4 -----------><--- Public IPv4 --->

               Figure 2: Access network deployment with LSN

3.2.2.  Diameter NAT Control Application overview

   The Diameter NAT Control Application runs between a Diameter NAT
   Control Application Agent on the LSN and the Diameter NAT Control
   Application Manager.  DNCA allows for per-endpoint control and
   management of a LSN.  Being based on Diameter, DNCA integrates well
   with the suite of Diameter applications deployed for per-endpoint
   authentication, authorization, accounting, and policy control in
   service provider networks.

   DNCA offers request and answer commands to control the allowed number
   of NAT-bindings per endpoint, to request the allocation of specific
   bindings for an endpoint, to define the address pool to be used for
   an endpoint, to provide per endpoint reporting on the allocated NAT-
   bindings, as well as to provide for unique identification of an
   endpoint on both LSN, AAA-server and NAS, thus simplifying the
   correlation of accounting data streams.

   DNCA allows for controlling the behavior of a LSN on a per-endpoint
   basis during initial session establishment as well as at later stages
   by providing an update procedure for already established sessions.
   Using DNCA, per-endpoint NAT-binding information can be retrieved
   either using accounting mechanisms or through an explicit session
   query to the LSN.

3.2.3.  Deployment scenarios for the Diameter NAT Control Application

   Deployment dependent, the role of the Diameter NAT Control Manager
   can be fulfilled by either the NAS or by an external server such as



Brockners, et al.        Expires April 26, 2010                 [Page 9]

Internet-Draft      Diameter NAT Control Application        October 2009


   an AAA-server.  The two deployment scenarios are outlined in Figure 3
   ("integrated deployment") and Figure 4 ("autonomous deployment").

   Within the figures (M) denotes the network element which takes on the
   DNCA manager role.  Similarly, (A) identifies the network element
   which performs the DNCA agent role.

   The integrated deployment approach hides the existence of the LSN
   from external servers such as the AAA-server as much as possible.  It
   is suited for environments where minimal changes to the existing AAA
   deployment are desired.  The NAS, taking the role of the DNCA
   manager, is in charge of initiating and managing the session to the
   LSN, exchanging LSN specific configuration information as well as
   handling reporting and accounting information.  The NAS receives
   reporting and accounting information from LSN.  This way the NAS can
   provide for a single accounting record for the user, offloading
   external accounting systems from correlating accounting information
   received from multiple sources.

   An example network attachment for an integrated LSN deployment could
   be described as follows: An endpoint connects to the network, with
   the NAS being the point of attachment.  After successful
   authentication, NAS receives endpoint related authorization data from
   the AAA-server.  A portion of the authorization data applies to per-
   endpoint configuration on the NAS itself, another portion describes
   authorization and configuration information for NAT control aimed at
   the LSN.  NAS will initiate a DNCA session to the LSN and send the
   relevant authorization and configuration information for the
   particular endpoint to the LSN.  This could comprise e.g.  NAT-
   bindings which have to be pre-established for the endpoint, or
   management related configuration, such as the maximum number of NAT-
   bindings allowed for the endpoint or accounting requirements.  The
   LSN will send its per-endpoint accounting information to the NAS
   which aggregates the accounting information received from the LSN
   with its local accounting information for the endpoint into a single
   accounting stream towards the AAA-server.















Brockners, et al.        Expires April 26, 2010                [Page 10]

Internet-Draft      Diameter NAT Control Application        October 2009


                         +---------+
                         |         |
                         |   AAA   |
                         |         |
                         +---------+
                              |
                              |
                              |
           +--------+    +---------+    +---------+    +----------+
           |  IPv4  |    |   (M)   |    |   (A)   |    |  IPv4    |
           |  Host  |----|   NAS   |----|   LSN   |----| Internet |
           |        |    |         |    |         |    |          |
           +--------+    +---------+    +---------+    +----------+

           <-------- Private IPv4 ----------><--- Public IPv4 ---->


          Figure 3: LSN Control deployment: Integrated deployment

   The autonomous deployment approach decouples user management on NAS
   and LSN.  The AAA system performing the role of the DNCA manager
   manages the connection to the LSN, controls the per-endpoint
   configuration, and also receives accounting and reporting information
   from LSN.  Different from the integrated deployment scenario, the
   autonomous deployment scenario does not "hide" the existence of the
   LSN from the AAA infrastructure.  Here two accounting streams are
   received by the AAA-server for one particular endpoint, one from the
   NAS, and one from the LSN.

                          +---------+
                          |   (M)   |
                          |   AAA   |
                          |         |
                          +---------+
                               |
                               |
                               |
            +--------+    +---------+    +---------+    +----------+
            |  IPv4  |    |         |    |   (A)   |    |  IPv4    |
            |  Host  |----|   NAS   |----|   LSN   |----| Internet |
            |        |    |         |    |         |    |          |
            +--------+    +---------+    +---------+    +----------+

            <-------- Private IPv4 ----------><---- Public IPv4 --->

          Figure 4: LSN Control deployment: Autonomous deployment





Brockners, et al.        Expires April 26, 2010                [Page 11]

Internet-Draft      Diameter NAT Control Application        October 2009


4.  Diameter NAT Control Application Session Establishment and
    Management

   Note that this section forward references some of the commands and
   AVPs defined for the DNCA.  Please refer to Section 6 and Section 7
   for details.

4.1.  Parties involved

   Authorization and control models supported by this application
   include the following parties:

   o  Diameter NAT Control Application (DNCA) agent: The DNCA agent is
      part of the Large scale NAT (LSN) device

   o  Diameter NAT Control Application (DNCA) manager

   The current version of the draft assumes that the NAT control
   requesting entity is always the DNCA manager.  Sessions will always
   be initiated, updated, or terminated by the DNCA manager.  This mode
   of operation is sometimes also referred to as "push mode".  Session
   initiation by the DNCA agent (sometimes referred to as "pull mode")
   will be covered in a future version of this draft.

4.2.  Session Establishment

   The DNCA manager establishes a session to the DNCA agent to control
   the behavior of the NAT device.  During session establishment, the
   DNCA manager will pass along configuration information to the DNCA
   agent.  Session configuration information could for example comprise
   the maximum number of bindings allowed for the endpoint associated
   with this session, a set of pre-defined NAT-bindings to be
   established for this endpoint, or a description of the address pool,
   external addresses should be allocated from.

   The DNCA manager initiates the Diameter NAT Control session to the
   DNCA agent.  The DNCA manager generates a NAT-Control Request (NCR)
   message to the DNCA agent with NC-Request-Type AVP set to
   INITIAL_REQUEST.  On receipt of the NCR the DNCA agent will setup a
   new session for the endpoint associated with the endpoint
   classifier(s) contained in the NCR.  The DNCA agent notifies the DNCA
   manager about successful session setup using a NAT-Control Answer
   (NCA) message with Result-Code set to DIAMETER_SUCCESS.  Figure 5
   shows the protocol interaction between the DNCA manager and the DNCA
   agent.

   The initial NAT-Control-Request can contain configuration information
   for the session which specifies the behavior of the LSN for the



Brockners, et al.        Expires April 26, 2010                [Page 12]

Internet-Draft      Diameter NAT Control Application        October 2009


   session.  Configuration information which can be included comprises:

   o  A list of NAT-bindings which should be pre-allocated for the
      session (e.g. in case a subscriber requires a fixed external IP-
      address/port pair for one of his applications).

   o  The maximum number of NAT bindings allowed for an endpoint.

   o  A description of the external address pool(s) to be used for the
      session.

   o  A reference to a predefined binding rule on DNCA agent that will
      be applied to the session.  Such a predefined binding rule on DNCA
      agent may contain, for example, the name of the IP-address pool
      that the external IP-addresses should be allocated from, the
      maximum number of bindings permitted for the endpoint etc.

   In certain cases, the DNCA agent may not be able to perform the tasks
   requested within the NCR.  These include the following:

   o  If a DNCA agent receives a NCR from a DNCA manager with NC-
      Request-Type AVP set to INITIAL_REQUEST that identifies an already
      existing session (i.e.  DNCA manager and endpoint identifier match
      an already existing session), the DNCA agent will return NCA with
      Result-Code set to SESSION_EXISTS, and provides Session-Id of the
      existing session in Duplicate-Session-Id AVP.

   o  If a DNCA agent receives an NCR from a DNCA manager with NC-
      Request-Type AVP set to INITIAL_REQUEST that matches more than one
      of the already existing sessions (i.e.  DNCA manager and endpoint
      identifier match already existing sessions), the DNCA agent will
      return a NCA with Result-Code set to Insufficient- Classifiers.
      In case a DNCA manager receives a NCA that reports Insufficient-
      Classifiers, it may choose to retry establishing a new session
      using additional/more specific classifiers.

   o  If the NCR contains a binding rule not defined on the LSN, the
      DNCA agent will return a NCA with Result-Code AVP set to
      UNKNOWN_BINDING_RULE.

   o  In case the DNCA agent is unable to establish all of the bindings
      requested in the NCR, it will return a NCA with Result-Code set to
      BINDING_FAILURE.  The DNCA agent (i.e.  LSN) treats a NCR as an
      atomic operation; hence none of the requested bindings will be
      established by LSN.  Either all requested actions within a NCR are
      completed successfully, or the entire request fails.





Brockners, et al.        Expires April 26, 2010                [Page 13]

Internet-Draft      Diameter NAT Control Application        October 2009


   o  If DNCA agent does not have sufficient resources to process a
      request, it will return NCA with Result-Code set to
      RESOURCE_FAILURE.

   o  In case Max-NAT-Binding and Nat-Control-Definition are included in
      the NCR along with a reference to a binding rule (i.e. a
      predefined template on LSN) and the values in Max-NAT-Binding and
      NAT-Control-Definition contradict those specified in the pre-
      defined binding rule, Max-NAT-Binding and NAT-Control-Definition
      override the values specified in the binding rule.


            DNCA Manager                             DNCA Agent
               |                                           |
               |                                           |
               |                                           |
            Trigger                                        |
               |                                           |
               |                   NCR                     |
               |------------------------------------------>|
               | (INITIAL_REQUEST, endpoint classifier,    |
               |     session id, NAT control config data)  |
               |                                           |
               |                                           |
               |                                  Create session state
               |                                           |
               |                                           |
               |                     NCA                   |
               |<------------------------------------------|
               |                 (result code)             |
               |                                           |
               |                                           |

      Figure 5: Initial NAT Control request and session establishment

4.3.  Session Re-Authorization

   Session re-authorization is performed if the DNCA manager desires to
   change the behavior of the LSN for an existing session.  Re-
   authorization could be used, for example, to change the number of
   allowed bindings for a particular session, or establish or remove a
   pre-defined binding.

   The DNCA manager generates a NAT-Control Request (NCR) message to the
   DNCA agent with NC-Request-Type AVP set to UPDATE_REQUEST upon
   receiving a trigger signal.  In case the session is updated
   successfully, the DNCA agent notifies the DNCA manager about
   successful session update using a NAT-Control Answer (NCA) message



Brockners, et al.        Expires April 26, 2010                [Page 14]

Internet-Draft      Diameter NAT Control Application        October 2009


   with Result-Code set to DIAMETER_SUCCESS.  Figure 6 shows the
   protocol interaction between the DNCA manager and the DNCA agent.

   In certain cases, the DNCA agent may not be able to perform the tasks
   requested within the NCR.  These include the following:

   o  If DNCA agent receives a NCR update/query request for non-existent
      session it will set error code in answer, to
      DIAMETER_UNKNOWN_SESSION_ID.

   o  If the NCR contains a binding rule not defined on the LSN, the
      DNCA agent will return a NCA with Result-Code AVP set to
      UNKNOWN_BINDING_RULE.

   o  If the DNCA agent cannot establish the requested binding because
      the maximum number of allowed bindings has been reached for the
      Endpoint Classifier, it will return NCA with Result-Code AVP set
      to MAXIMUM_BINDINGS_REACHED_FOR_ENDPOINT.

   o  In case the DNCA agent cannot establish some or all of the
      bindings requested in a NCR, but has not yet reached the maximum
      number of allowed bindings for the subscriber, it will return a
      NCA with Result-Code set to BINDING_FAILURE.  The DNCA agent (i.e.
      LSN) treats a NCR as an atomic operation; hence none of the
      requested bindings will be established by LSN.  Either all
      requested actions within a NCR are completed successfully, or the
      entire request fails.

   o  If DNCA agent does not have sufficient resources to process a
      request, it will return a NCA with Result-Code set to
      RESOURCE_FAILURE.

   o  If a NCR redefines the maximum number of NAT bindings allowed for
      the endpoint, the new value will override any previously defined
      limit on NAT-bindings.  It depends on the implementation of the
      LSN how LSN would cope with a case where the new value is lower
      than the actual number of allocated bindings.  Typically the LSN
      would refrain from enforcing the new limit immediately (i.e.
      actively remove bindings) but rather disallow the establishment of
      new bindings until the current number of bindings is lower than
      the newly established maximum number of allowed bindings.

   o  If a NCR specifies a new binding rule, predefined on the DNCA
      agent, the binding rule will override any previously defined rules
      for the session.

   o  In case Max-NAT-Binding and Nat-Control-Definition are included in
      the NCR along with a reference to a binding rule (i.e. a



Brockners, et al.        Expires April 26, 2010                [Page 15]

Internet-Draft      Diameter NAT Control Application        October 2009


      predefined template on LSN) and the values in Max-NAT-Binding and
      Nat-Control-Definition contradict those specified in the pre-
      defined binding rule, Max-NAT-Binding and NAT-Control-Definition
      override the values specified in the binding rule.


            DNCA Manager                             DNCA Agent
               |                                           |
               |                                           |
               |                                           |
        Change of session                                  |
           attributes                                      |
               |                                           |
               |                   NCR                     |
               |------------------------------------------>|
               |       (UPDATE_REQUEST session id,         |
               |         NAT control config data)          |
               |                                           |
               |                                           |
               |                                  Update session state
               |                                           |
               |                                           |
               |                     NCA                   |
               |<------------------------------------------|
               |                 (result code)             |
               |                                           |
               |                                           |

             Figure 6: NAT Control request for session update

4.4.  Session and Binding Query

   Session query can be used by the DNCA manager to either retrieve
   information on the current bindings for a particular session at the
   LSN or discover the session identifier for a particular external IP-
   address/port pair.

   The DNCA manager initiates a session query by sending a NAT-Control
   Request (NCR) message to the DNCA agent with NC-Request-Type AVP set
   to QUERY_REQUEST.  Figure 7 shows the protocol interaction between
   the DNCA manager and the DNCA agent.

   Two types of query requests exist.  The first type of query request
   uses the session ID as input parameter to the query.  It is to allow
   the DNCA manager retrieve the current set of bindings for a specific
   session.  The second type of query request is used in to retrieve the
   session identifiers, along with the associated bindings, matching a
   criteria.  This enables the DNCA manager to find out which sessions



Brockners, et al.        Expires April 26, 2010                [Page 16]

Internet-Draft      Diameter NAT Control Application        October 2009


   utilize a specific external IP address.

   1.  Request a list of currently allocated NAT-bindings for a
       particular session: The DNCA agent will, on receipt of the NCR,
       lookup the session information for the session id contained in
       the NCR, and will report all currently active NAT-bindings for
       the session using a NAT-Control Answer (NCA) message with Result-
       Code set to DIAMETER_SUCCESS.  In this case the NCR MUST NOT
       contain a NAT-Control-Definition AVP.  Each NAT-Binding will be
       reported in a NAT-Control-Definition AVP.  In case the session id
       is unknown to the DNCA agent a DIAMETER_UNKNOWN_SESSION_ID error
       is returned.

   2.  Retrieve session ids and internal IP-address/port pairs for one
       or multiple external IP-address/port pairs: If the DNCA manager
       wishes to retrieve the session id(s) for one or multiple external
       IP-address/port pairs, it MUST include the external IP-address/
       port pair(s) as part of the NAT-Control-Definition AVP of the
       NCR.  The session id used within the NCR is not meaningful for
       this type of a query.  The DNCA agent will report the NAT-
       bindings and associated session ids corresponding to the external
       IP-address/port pairs in a NAT-Control Answer (NCA) message with
       Result-Code set to DIAMETER_SUCCESS and the same session id as
       the one used in the NCR.  In case an external IP-address/port
       pair has no associated existing NAT-binding, the NAT-Control-
       Definition AVP contained in the reply just contains the NAT-
       External-Address AVP.
























Brockners, et al.        Expires April 26, 2010                [Page 17]

Internet-Draft      Diameter NAT Control Application        October 2009


            DNCA Manager                             DNCA Agent
               |                                           |
               |                                           |
               |                                           |
     DNCA Session Established                              |
               |                                           |
               |                   NCR                     |
               |------------------------------------------>|
               |              (QUERY_REQUEST)              |
               |                                           |
               |                                           |
               |                                           |
               |                          Look up corresponding session
               |                            and associated NAT Bindings
               |                                           |
               |                     NCA                   |
               |<------------------------------------------|
               |                 (result code)             |
               |                                           |
               |                                           |

                          Figure 7: Session Query

4.5.  Session Termination

   The DNCA manager generates a NAT-Control Request (NCR) message to the
   DNCA agent with NC-Request-Type AVP set to TERMINATE REQUEST upon
   receiving a trigger signal.  The DNCA agent sends accounting stop
   record reporting all the bindings and notifies the DNCA manager about
   successful session termination using a NAT-Control Answer (NCA)
   message with Result-Code set to DIAMETER_SUCCESS.  Figure 8 shows the
   protocol interaction between the DNCA manager and the DNCA agent.

   If a DNCA agent receives a NCR from a DNCA manager with NC-Request-
   Type AVP set to Terminate REQUEST and fails to find a matching
   session, the DNCA agent returns DIAMETER_UNKNOWN_SESSION_ID error.















Brockners, et al.        Expires April 26, 2010                [Page 18]

Internet-Draft      Diameter NAT Control Application        October 2009


            DNCA Manager                             DNCA Agent
               |                                            |
               |                                            |
            Trigger                                         |
               |                                            |
               |                   NCR                      |
               |------------------------------------------->|
               |       (TERMINATE_REQUEST, session id)      |
               |                                            |
               |                                            |
               |                                  Remove NAT bindings
               |                                       of session
               |                                            |
               |                                            |
               |           Send accounting stop             |
               |<-------------------------------------------|
               |           for all session bindings         |
               |                                            |
               |                                  Terminate Session /
               |                                 Remove session state
               |                                            |
               |                                            |
               |                                            |
               |                     NCA                    |
               |<-------------------------------------------|
               |                 (result code)              |
               |                                            |

                  Figure 8: Terminate NAT Control session

4.6.  DNCA Manager/Agent failures

   Disclaimer: This version of the draft does not cover details in case
   DNCA manager and DNCA agent go out of sync, which could happen for
   example due to DNCA manager or DNCA agent restart, (temporary) loss
   of network connectivity etc.  Future versions of this draft will
   cover failure cases and corresponding behavior of DNCA manager and
   DNCA agent in detail.

   Example failure cases include the following:

   o  The DNCA manager loses session state (e.g. due to a restart).  In
      this case,

      *  the DNCA agent may receive a NCR with NC-Request-Type AVP set
         to INITIAL_REQUEST that matches an existing session of DNCA
         agent.  The DNCA agent will return an error that contains
         Duplicate-Session-Id AVP to report Session-Id of existing



Brockners, et al.        Expires April 26, 2010                [Page 19]

Internet-Draft      Diameter NAT Control Application        October 2009


         session.  The DNCA manager may then send an explicit
         TERMINATE_REQUEST for the older session that was lost.

      *  the DNCA manager may receive accounting records for a session
         that does not exist.  The DNCA manager will send an accounting
         answer with error-code set to DIAMETER_UNKNOWN_SESSION_ID.  On
         receipt of which the DNCA agent clears the session and removes
         the associated session state.

   o  The DNCA agent loses session state.  In such a case, the DNCA
      agent could receive a NCR with NC-Request-Type AVP set to
      UPDATE_REQUEST for a non-existent session.  The DNCA agent will
      return NCA with error code set to DIAMETER_UNKNOWN_SESSION_ID.
      State recovery procedures of the DNCA agent will be covered in a
      future version of this document.

   o  The DNCA manager is unreachable (as e.g. detected by Diameter
      watchdog) or down and accounting requests from the DNCA agent fail
      to get a response.  The current version of the draft does not
      specify procedures for DNCA agent session state clean up or
      recovery.  The mechanism to ensure that a DNCA manager no longer
      has associated state for a session being cleared at the DNCA agent
      is beyond the scope of this document.

   o  The DNCA agent is unreachable or down and NCR requests fail to get
      a response.  Handling of this case depends on the actual service
      offering of the service provider.  The service provider could, for
      example, choose to terminate the access session to the endpoint.


5.  Use of the DIAMETER base protocol

   The DIAMETER Base Protocol defined by [RFC3588] shall apply, with the
   clarifications listed in the present specification.

5.1.  Securing DIAMETER messages

   For secure transport of DIAMETER messages, IPSec may be used.

   The DNCA agent may verify the identity of the DNCA Manager during the
   Capabilities Exchange Request procedure.

   The DNCA agent may verify if the DNCA Manager that issues a NCR
   command is allowed to do so, based on:

   o  The Identity of the DNCA Manager





Brockners, et al.        Expires April 26, 2010                [Page 20]

Internet-Draft      Diameter NAT Control Application        October 2009


   o  The Type of NCR Command

   o  The content of the NCR Command

   o  Any combination of the above

5.2.  Accounting functionality

   Accounting functionality (Accounting Session State Machine, related
   command codes and AVPs) is defined in Section 8 below.

5.3.  Use of sessions

   Each DNCA session MUST have a globally unique Session-Id as defined
   in [RFC3588], which MUST NOT be changed during the lifetime of a DNCA
   session.  The Diameter Session-Id serves as the global endpoint
   identifier (see also capabilities Section 3.1).  The DNCA agent and
   DNCA manager maintain state associated with the Session-Id.  This
   globally unique Session-Id is used for updating, accounting for and
   terminating the session.  DNCA session MUST NOT have more than one
   outstanding request at any given instant.  The DNCA agent sends an
   Abort-Session-Request as defined in [RFC3588] if it is unable to
   maintain sessions due to resource limitation.

5.4.  Routing considerations

   It is assumed that the DNCA manager knows the address/name of the
   DNCA agent for a given endpoint.  Both the Destination-Realm and
   Destination-Host AVPs are present in the Request from the DNCA
   manager to the DNCA agent.

5.5.  Advertising Application support

   Diameter applications conforming to this specification MUST advertise
   support by including the value of TBD in:

   o  Auth-Application-Id and Acct-Application-Id of Capabilities-
      Exchange-Request (CER)

   o  Auth-Application-Id of NC-request (NCR), NC-Answer (NCA), Abort-
      Session-Request(ASR), Abort-Session-Answer (AAA) messages

   o  Acct-Application-Id in Accounting-Request (ACR) and Accounting-
      Answer (AAA) messages.







Brockners, et al.        Expires April 26, 2010                [Page 21]

Internet-Draft      Diameter NAT Control Application        October 2009


6.  Diameter NAT Control Application Commands

   The following commands are used to establish, maintain and clear LSN
   bindings.

6.1.  NAT-Control Request (NCR) Command

   The NAT-Control Request (NCR) command, indicated by the command field
   set to TBD and the "R" bit set in the Command Flags field, is sent
   from the DNCA manager to the DNCA agent in order to install NAT
   bindings.

   Message Format:

      < NC-Request > ::= < Diameter Header: TBD, REQ, PXY>

                       < Session-Id >
                       { Auth-Application-Id }
                       { Origin-Host }
                       { Origin-Realm }
                       { Destination-Realm }
                       { Destination-Host }
                       { NC-Request-Type }
                       [ Origin-State-Id ]
                       [ Auth-Session-State ]
                     * [ NAT-Control-Remove ]
                     * [ NAT-Control-Install ]
                       [ User-Name ]
                       [ Logical-Access-Id ]
                       [ Physical-Access-ID ]
                       [ Framed-IP-Address ]
                       [ Framed-Interface-Id ]
                       [ EGRESS-VLANID]
                       [ NAS-Port-ID]
                       [ Address-Realm ]
                       [ Called-Station-ID ]
                     * [ Proxy-Info ]
                     * [ Route-Record ]
                     * [ AVP ]

6.2.  NAT-Control Answer (NCA) Command

   The NAT-Control-Answer (NCA) command, indicated by the Command-Code
   field set to TBD and the "R" bit cleared in the Command Flags field,
   is sent by the DNCA agent in response to NAT-Control-Request command.

   Message Format:




Brockners, et al.        Expires April 26, 2010                [Page 22]

Internet-Draft      Diameter NAT Control Application        October 2009


      <NC-Answer> ::= < Diameter Header: TBD, PXY >
                      < Session-Id >
                      { Origin-Host }
                      { Origin-Realm }
                      { NC-Request-Type }
                      [ Result-Code ]
                    * [ NAT-Control-Definition ]
                      [ Current-NAT-Bindings   ]
                      [ Origin-State-Id ]
                      [ Error-Message ]
                      [ Error-Reporting-Host ]
                    * [ Failed-AVP ]
                    * [ Proxy-Info ]
                      [ Duplicate-Session-ID ]
                    * [ AVP ]



7.  Diameter NAT Control Application AVPs

7.1.  Reused Base Protocol AVPs

   AVPs reused from Diameter Base Protocol [RFC3588] are listed below.




























Brockners, et al.        Expires April 26, 2010                [Page 23]

Internet-Draft      Diameter NAT Control Application        October 2009


                                                   +-------------------+
                                                   |  AVP Flag rules   |
   +-----------------------------------------------|-----+---+---------+
   |                           AVP                 |     |   |   May   |
   | Attribute Name            Code     Data Type  |MUST |MAY| encrypt |
   +-----------------------------------------------+-----+---+---------+
   |Acct-Interim-Interval      85       Unsigned32 | M   | P |    Y    |
   |Auth-Application-Id        258      Unsigned32 | M   | P |    N    |
   |Auth-Session-State         277      Enumerated | M   | P |    N    |
   |Destination-Host           293      DiamIdent  | M   | P |    N    |
   |Destination-Realm          283      DiamIdent  | M   | P |    N    |
   |Error-Message              281      UTF8String | M   | P |    N    |
   |Error-Reporting-Host       294      DiamIdent  | M   | P |    N    |
   |Failed-AVP                 279      Grouped    | M   | P |    N    |
   |Origin-Host                264      DiamIdent  | M   | P |    N    |
   |Origin-Realm               296      DiamIdent  | M   | P |    N    |
   |Origin-State-Id            278      Unsigned32 | M   | P |    N    |
   |Proxy-Info                 284      Grouped    | M   | P |    N    |
   |Result-Code                268      Unsigned32 | M   | P |    N    |
   |Route-Record               282      DiamIdent  | M   |   |    N    |
   |Session-Id                 263      UTF8String | M   | P |    Y    |
   |User-Name                  1        UTF8String | M   | P |    Y    |
   +-----------------------------------------------+-----+---+---------+
   |M - Mandatory bit. An AVP with "M" bit set and its value MUST be   |
   |    supported and recognized by a Diameter entity in order the     |
   |    message, which carries this AVP, to be accepted.               |
   |P - Indicates the need for encryption for end-to-end security.     |
   +-------------------------------------------------------------------+

              Figure 9: DIAMETER AVPs used from Diameter base

   The Auth-Application-Id AVP (AVP Code 258) is assigned by IANA to
   Diameter applications.  The value of the Auth-Application-Id for the
   Diameter NAT Control Application is TBD.

7.2.  Additional Result-Code AVP values

   This section defines new values for the Result-Code AVP which SHALL
   be supported by all DIAMETER implementations that conform to the
   present document.

7.2.1.  Success

   No new Result-Code AVP value is defined within this category.







Brockners, et al.        Expires April 26, 2010                [Page 24]

Internet-Draft      Diameter NAT Control Application        October 2009


7.2.2.  Transient failures

   Result-Code AVP values that fall within the transient failures
   category are those used to inform a peer that the request could not
   be satisfied at the time that it was received.  The request may be
   able to be satisfied in the future.

   The following new values of the Result-Code AVP are defined:

      RESOURCE_FAILURE (TBD)

         The DNCA agent indicates that the binding could not be
         installed or a new session could not be created due to resource
         shortage.

7.2.3.  Permanent failures

   Result-Code AVP values that fall within the permanent failures
   category are used to inform the peer that the request failed, and
   should not be attempted again.  The request may be able to be
   satisfied in the future.

   The following new values of the Result-Code AVP are defined:

      UNKNOWN_BINDING_RULE_NAME (TBD)

         The DNCA agent indicates that the binding could not be
         installed or a new session could not be created due to resource
         shortage.

      BINDING_FAILURE (TBD)

         The DNCA indicates that the requested binding(s) could not be
         installed.

      MAXIMUM_BINDINGS_REACHED_FOR_ENDPOINT (TBD)

         The DNCA agent denies the request because the maximum number of
         allowed bindings has been reached for the specified Endpoint
         Classifier.

      SESSION_EXISTS (TBD)

         The DNCA agent denies request to initialize a new session, if
         it already has a DNCA session that uses the same set of
         classifiers as indicated by DNCA manager in the new session
         init request.




Brockners, et al.        Expires April 26, 2010                [Page 25]

Internet-Draft      Diameter NAT Control Application        October 2009


      INSUFFICIENT_CLASSIFIERS (TBD)

         The DNCA agent defines request to initialize a new session, if
         the classifiers in the request match more than one of the
         existing sessions on DNCA agent.

7.3.  Reused NASREQ Diameter application AVPs

   The following AVPs are reused from Diameter Network Access Server
   Application [RFC4005].

                                          +---------------------+
                                          |    AVP Flag rules   |
   +------------------+------+------------|----+-----+----+-----|----+
   |                  | AVP  |            |    |     |SHLD| MUST|    |
   | Attribute Name   | Code |  Value Type|MUST| MAY | NOT|  NOT|Encr|
   |------------------|------|------------|----+-----+----+-----|----|
   | NAS-Port         |   5  | Unsigned32 | M  |  P  |    |  V  | Y  |
   | NAS-Port-Id      |  87  | UTF8String | M  |  P  |    |  V  | Y  |
   | Called-Station-Id|  30  | UTF8String | M  |  P  |    |  V  | Y  |
   | Calling-Station- |  31  | UTF8String | M  |  P  |    |  V  | Y  |
   |   Id             |      |            |    |     |    |     |    |
   | Framed-IP-Address|   8  | OctetString| M  |  P  |    |  V  | Y  |
   | Framed-Interface-|  96  | Unsigned64 | M  |  P  |    |  V  | Y  |
   |   ID             |      |            |    |     |    |     |    |
   +------------------+------+------------|----+-----+----+-----|----+

            Figure 10: Reused NASREQ Diameter application AVPs

7.4.  Reused from RFC 4675

   The following AVPs are reused from "RADIUS Attributes for Virtual LAN
   and Priority Support" specification [RFC4675].

                                          +---------------------+
                                          |    AVP Flag rules   |
   +------------------+------+------------|----+-----+----+-----|----+
   |                  | AVP  |            |    |     |SHLD| MUST|    |
   | Attribute Name   | Code |  Value Type|MUST| MAY | NOT|  NOT|Encr|
   |------------------|------|------------|----+-----+----+-----|----|
   | Egress-VLANID    |  56  | OctetString| M  |  P  |    |  V  | Y  |
   +------------------+------+------------|----+-----+----+-----|----+

                Figure 11: Reused attributes from RFC 4675







Brockners, et al.        Expires April 26, 2010                [Page 26]

Internet-Draft      Diameter NAT Control Application        October 2009


7.5.  Reused from Diameter QoS Application

   The following AVPs are reused from the Diameter QoS Application
   [I-D.ietf-dime-diameter-qos].
                                                   +-------------------+
                                                   |  AVP Flag rules   |
   +-----------------------------------------------|-----+---+---------+
   |                           AVP                 |     |   |   May   |
   | Attribute Name            Code     Data Type  |MUST |MAY| encrypt |
   +-----------------------------------------------+-----+---+---------+
   |Port                       TBD     Integer32   |  M  | P |    Y    |
   |IP-Address-Mask            TBD     Grouped     |  M  | P |    Y    |
   |Protocol                   TBD     Enumerated  |  M  | P |    Y    |
   |Direction                  TBD     Enumerated  |  M  | P |    Y    |
   +-----------------------------------------------+-----+---+---------+
   |M - Mandatory bit. An AVP with "M" bit set and its value MUST be   |
   |    supported and recognized by a Diameter entity in order the     |
   |    message, which carries this AVP, to be accepted.               |
   |P - Indicates the need for encryption for end-to-end security.     |
   +-------------------------------------------------------------------+

                     Figure 12: Reused QoS-attributes

7.6.  Reused from ETSI ES 283 034, e4 Diameter application

   The following AVPs are reused from the Diameter e4 Application
   [ETSIES283034].

                                                   +-------------------+
                                                   |  AVP Flag rules   |
   +-----------------------------------------------|-----+---+---------+
   |                           AVP                 |     |   |   May   |
   | Attribute Name            Code     Data Type  |MUST |MAY| encrypt |
   +-----------------------------------------------+-----+---+---------+
   |Address-Realm              301     OctetString | M,V |   |    Y    |
   |Logical-Access-Id          302     OctetString |   V | M |    Y    |
   |Physical-Access-ID         313     UTF8String  |   V | M |    Y    |
   +-----------------------------------------------+-----+---+---------+
   |M - Mandatory bit. An AVP with "M" bit set and its value MUST be   |
   |    supported and recognized by a Diameter entity in order the     |
   |    message, which carries this AVP, to be accepted.               |
   |P - Indicates the need for encryption for end-to-end security.     |
   |V - Indicates whether the optional Vendor-ID field is present      |
   |    in the AVP header. Vendor-Id header of all AVPs in             |
   |    this table will be set to ETSI (13019)                         |
   +-------------------------------------------------------------------+

            Figure 13: Reused AVPs from Diameter e4 application



Brockners, et al.        Expires April 26, 2010                [Page 27]

Internet-Draft      Diameter NAT Control Application        October 2009


7.7.  Diameter NAT Control Application Defined AVPs

   The following table describes the new Diameter AVPs used in the
   present document, their AVP Code values, types, possible flag values
   and whether the AVP may or not be encrypted.
                                                   +-------------------+
                                                   |  AVP Flag rules   |
   +-----------------------------------------------|-----+---+---------+
   |                       AVP  Section            |     |   |   May   |
   | Attribute Name        Code Defined Data Type  |MUST |MAY| encrypt |
   +-----------------------------------------------+-----+---+---------+
   |NC-Request-Type        TBD  7.7.1   Enumerated | M   | P |    Y    |
   |NAT-Control-Install    TBD  7.7.2   Grouped    | M   | P |    Y    |
   |NAT-Control-Remove     TBD  7.7.3   Grouped    | M   | P |    Y    |
   |NAT-Control-Definition TBD  7.7.4   Grouped    | M   | P |    Y    |
   |NAT-Internal-Address   TBD  7.7.5   Grouped    | M   | P |    Y    |
   |NAT-External-Address   TBD  7.7.6   Grouped    | M   | P |    Y    |
   |Max-NAT-Bindings       TBD  7.7.7   Unsigned32 | M   | P |    Y    |
   |NAT-Control-           TBD  7.7.8   OctetString| M   | P |    Y    |
   | Binding-Rule                                  |     |   |         |
   |Duplicate-             TBD  7.7.9   UTF8String | M   | P |    Y    |
   | Session-ID                                    |     |   |         |
   |NAT-Control-Record     TBD  8.2.1   Grouped    | M   | P |    Y    |
   |NAT-Control-           TBD  8.2.2   Enumerated | M   | P |    Y    |
   | Binding-Status                                |     |   |         |
   |Current-NAT-Bindings   TBD  8.2.3   Unsigned32 | M   | P |    Y    |
   +-----------------------------------------------+-----+---+---------+
   |M - Mandatory bit. An AVP with "M" bit set and its value MUST be   |
   |    supported and recognized by a Diameter entity in order the     |
   |    message, which carries this AVP, to be accepted.               |
   |P - Indicates the need for encryption for end-to-end security.     |
   |V - Vendor specific bit that indicates whether the optional        |
   |    Vendor-ID field is present in the AVP header                   |
   +-------------------------------------------------------------------+

                       Figure 14: New Diameter AVPs

7.7.1.  NC-Request-Type AVP

   The NC-Request-Type AVP (AVP Code TBD) is of type Enumerated and
   contains the reason for sending the NAT-Control-Request command.  It
   shall be present in all NAT-Control-Request messages.

   The following values are defined:

      INITIAL_REQUEST (1)





Brockners, et al.        Expires April 26, 2010                [Page 28]

Internet-Draft      Diameter NAT Control Application        October 2009


         An Initial Request is used to install binding at the DNCA agent
         on a successful access session setup.

      UPDATE_REQUEST (2)

         An Update Request is used to update bindings previously
         installed on a given access session, to add new binding on a
         given access session, or to remove one or several binding(s)
         activated on a given access session.

      TERMINATION_REQUEST (3)

         Termination Request is used to deactivate and remove all
         bindings previously activated on a given access session.

      QUERY_REQUEST (4)

         Query Request is used to query the DNCA agent about the
         currently installed bindings for an endpoint classifier.

7.7.2.  NAT-Control-Install AVP

   The NAT-Control AVP (AVP code TBD) is of type Grouped, and it is used
   to activate or install NAT bindings.  It also contains Max-NAT-
   Bindings that defines maximum number of NAT bindings to be allowed
   for a subscriber and NAT-Control-Binding-Rule that references
   predefined policy template on DNCA agent that may contain static
   bindings, maximum number of bindings to be allowed, address pool from
   which external binding address should be allocated.

   AVP format:

     NAT-Control-Install ::= < AVP Header: TBD >
                              * [ NAT-Control-Definition ]
                                [ NAT-Control-Binding-Rule ]
                                [ Max-NAT-Bindings]
                              * [ AVP ]

7.7.3.  NAT-Control-Remove AVP

   The NAT-Control-Remove AVP (AVP code TBD) is of type Grouped, and it
   is used to deactivate or remove NAT bindings.

   AVP format:

     NAT-Control-Remove ::= < AVP Header: TBD >
                             * [ NAT-Control-Definition ]
                               [ NAT-Control-Binding-Rule ]



Brockners, et al.        Expires April 26, 2010                [Page 29]

Internet-Draft      Diameter NAT Control Application        October 2009


                             * [ AVP ]

7.7.4.  NAT-Control-Definition AVP

   The NAT-Control-Definition AVP (AVP code TBD) is of type Grouped, and
   it describes a binding.

   The NAT-Control-Definition AVP uniquely identifies the binding
   between the DNCA agent and the DNCA manager.

   If both the NAT-Internal-Address and NAT-External-Address AVP(s) are
   supplied, it is a pre-defined binding.

   The Protocol AVP describes the transport protocol for which the
   binding is created.  Exactly zero or one Protocol AVP may be
   contained within NAT-Control-Definition AVP.  If the Protocol AVP is
   omitted and if both internal and external address are specified then
   the binding reserves the addresses for all transport protocols.

   The Direction AVP is of type Enumerated and specifies in which
   direction to apply the binding.  The values of the enumeration
   applicable in this context are: "IN","OUT".  If Direction AVP is OUT
   or absent NAT-Internal-Address refers to the address of the
   subscriber device that needs to be translated.  If Direction AVP is
   "IN" NAT-Internal-Address is the destination address that has to be
   translated.

   AVP format:

     NAT-Control-Definition ::= < AVP Header: TBD >
                                 { NAT-Internal-Address }
                                 [ Protocol ]
                                 [ Direction ]
                                 [ NAT-External-Address ]
                                 [ Session-Id ]
                               * [ AVP ]

7.7.5.  NAT-Internal-Address AVP

   The NAT-Internal-Address AVP (AVP code TBD) is of type Grouped, and
   it describes the internal IP address and port for a binding.

   AVP format:

     NAT-Internal-Address ::= < AVP Header: TBD >
                               [ Framed-IP-Address ]
                               [ Port]
                               [ AVP ]



Brockners, et al.        Expires April 26, 2010                [Page 30]

Internet-Draft      Diameter NAT Control Application        October 2009


7.7.6.  NAT-External-Address AVP

   The NAT-External-Address AVP (AVP code TBD) is of type Grouped, and
   it describes the external IP address and port for a binding.  IP-
   Address-Mask AVP can only be specified when Framed-IP-Address AVP is
   present.

   AVP format:

     NAT-External-Address ::= < AVP Header: TBD >
                               [ Framed-IP-Address ]
                               [ IP-Address-Mask ]
                               [ Port ]
                               [ AVP ]

7.7.7.  Max-NAT-Bindings

   The Max-NAT-Bindings AVP (AVP code TBD) is of type Unsigned32, and it
   indicates the maximum number of NAT bindings allowed.

7.7.8.  NAT-Control-Binding-Rule AVP

   The NAT-Control-Binding-Rule AVP (AVP code TBD) is of type is of type
   OctetString, and it defines a name for a policy template that will be
   predefined at LSN.  Details on the contents and structure of the
   template as well as how it would be configured are outside the scope
   of this document.  The policy to which this AVP refers to may contain
   NAT Bindings, address pool for external address allocation of NAT
   binding, maximum allowed NAT bindings etc.

7.7.9.  Duplicate-Session-Id AVP

   The Duplicate-Session-Id AVP (AVP Code TBD) is of is of type
   UTF8String.  It is used to report error and contains the Session-Id
   of an existing session.


8.  Accounting Commands

   The Diameter NAT Control Application reuses session based accounting
   as defined in Diameter Base Protocol [RFC3588] to report the bindings
   used per endpoint.  This reporting is achieved by sending Diameter
   Accounting Requests (ACR) [Start, Interim and Stop] from the DNCA
   agent to DNCA manager.

   The DNCA agent sends an ACR Start on receiving an NCR with NC-
   Request-Type AVP set to INITIAL_REQUEST received for a session, or on
   creation of the first binding for a session requested in an earlier



Brockners, et al.        Expires April 26, 2010                [Page 31]

Internet-Draft      Diameter NAT Control Application        October 2009


   NCR.  The DNCA may send ACR Interim updates, if required, either due
   to a change in bindings resulting from an NCR with NC-Request-Type
   AVP set to UPDATE_REQUEST, or periodically as specified in Acct-
   Interim-Interval by DNCA Manager or when it creates/tears down
   bindings.  An ACR Stop is sent by the DNCA agent on receiving an NCR
   with NC-Request-Type AVP set to TERMINATION_REQUEST.

   The function of correlating the multiple bindings used by an endpoint
   at any given time is relegated to the post processor.

   The DNCA agent may trigger an interim accounting record when maximum
   number of bindings, if received in NCR, is reached.

8.1.  NAT Control Accounting Messages

   The ACR and ACA messages are reused as defined in Diameter Base
   Protocol [RFC3588] for exchanging endpoint NAT binding details
   between the DNCA agent and the CDF.  ACR will contain one or more
   optional NAT-Control-Record AVP to report the bindings.  The DNCA
   agent indicates the number of the currently allocated NAT bindings to
   the DNCA manager using the Current-NAT-Bindings AVP.  This number
   needs to match the number of bindings identified as active within the
   NAT-Control-Record AVP.

8.2.  NAT Control Accounting AVPs

   In addition to AVPs for ACR specified in [RFC3588], the DNCA agent
   must add the NAT-Control-Record AVP.

8.2.1.  NAT-Control-Record

   The NAT-Control-Record AVP (AVP code TBD) is of type Grouped, and it
   describes a binding and its status.  Event-Timestamp indicates the
   time at which binding was created if NAT-Control-Binding-Status is
   set to Created, or time at which the binding was removed if NAT-
   Control-Binding-Status is set to removed.  If the NAT-Control-
   Binding-Status is active Event-Timestamp need not be present, if
   present it indicates that binding is active at the mentioned time.

     NAT-Control-Record ::= < AVP Header: TBD >
                            { NAT-Control-Definition }
                            { NAT-Control-Binding-Status }
                            [ Event-Timestamp ]

8.2.2.  NAT-Control-Binding-Status

   The NAT-Control-Binding-Status AVP (AVP code TBD) is of type
   enumerated and it describes whether the binding being reported was



Brockners, et al.        Expires April 26, 2010                [Page 32]

Internet-Draft      Diameter NAT Control Application        October 2009


   created or removed or simply indicates that it is active.

   The following values are defined:

      Created (1)

         Indicates that NAT binding is created.

      Active (2)

         Indicates that NAT binding is active.

      Removed (3)

         Indicates that the NAT binding was removed.

8.2.3.  Current-NAT-Bindings

   The Current-NAT-Bindings AVP (AVP code TBD) is of type Unsigned32,
   and it indicates number of NAT bindings active on LSN.


9.  AVP Occurrence Table

   The following sections presents the AVPs defined in this document and
   specifies in which Diameter messages they MAY be present.  Note that
   AVPs that can only be present within a Grouped AVP are not
   represented in this table.

   The table uses the following symbols:



      0         The AVP MUST NOT be present in the message.

      0+        Zero or more instances of the AVP MAY be present in the
                message.

      0-1       Zero or one instance of the AVP MAY be present in the
                message.  It is considered an error if there is more
                than one instance of the AVP.

      1         One instance of the AVP MUST be present in the message.

      1+        At least one instance of the AVP MUST be present in the
                message.





Brockners, et al.        Expires April 26, 2010                [Page 33]

Internet-Draft      Diameter NAT Control Application        October 2009


9.1.  DNCA AVP Table for NAT control initial and update requests

   The following table presents which NAT control application specific
   AVPs are to be present in NCR/NCA with NC-Request-Type set to
   INITIAL_REQUEST or UPDATE_REQUEST.

                                       +-------------------+
                                       |  Command Code     |
   +-----------------------------------+-------------------+
   | Attribute Name                        NCR    NCA      |
   +-------------------------------------------------------+
   |NC-Request-Type                         1      1       |
   |NAT-Control-Install                     0-1    0       |
   |NAT-Control-Remove                      0-1    0       |
   |NAT-Control-Definition                  0      0       |
   |NAT-Control-Record                      0      0       |
   |Current-NAT-Bindings                    0      0       |
   |Duplicate-Session-Id                    0      0-1     |
   +-------------------------------------------------------+

9.2.  DNCA AVP Table for Session Query request

   The following table presents which NAT control application specific
   AVPs are to be present in NCR/NCA with NC-Request-Type set to
   QUERY_REQUEST.

                                       +-------------------+
                                       |  Command Code     |
   +-----------------------------------+-------------------+
   | Attribute Name                        NCR    NCA      |
   +-------------------------------------------------------+
   |NC-Request-Type                         1      1       |
   |NAT-Control-Install                     0      0       |
   |NAT-Control-Remove                      0      0       |
   |NAT-Control-Definition                  0      0+      |
   |NAT-Control-Record                      0      0       |
   |Current-NAT-Bindings                    0      1       |
   |Duplicate-Session-Id                    0      0       |
   +-------------------------------------------------------+

9.3.  DNCA AVP Table for NAT Control Terminate requests

   The following table presents which NAT control application specific
   AVPs are to be present in NCR/NCA with NC-Request-Type set to
   TERMINATION_REQUEST.






Brockners, et al.        Expires April 26, 2010                [Page 34]

Internet-Draft      Diameter NAT Control Application        October 2009


                                       +-------------------+
                                       |  Command Code     |
   +-----------------------------------+-------------------+
   | Attribute Name                        NCR    NCA      |
   +-------------------------------------------------------+
   |NC-Request-Type                         1      1       |
   |NAT-Control-Install                     0      0       |
   |NAT-Control-Remove                      0      0       |
   |NAT-Control-Definition                  0      0       |
   |NAT-Control-Record                      0      0       |
   |Current-NAT-Bindings                    0      0       |
   |Duplicate-Session-Id                    0      0       |
   +-------------------------------------------------------+

9.4.  DNCA AVP Table for accounting message

   Following table presents which NAT control application specific AVPs
   May or May Not be present in ACR/ACA messages.

                                       +-------------------+
                                       |  Command Code     |
   +-----------------------------------+-------------------+
   | Attribute Name                        ACR    ACA      |
   +-------------------------------------------------------+
   |NC-Request-Type                         0      0       |
   |NAT-Control-Install                     0      0       |
   |NAT-Control-Remove                      0      0       |
   |NAT-Control-Definition                  0      0       |
   |NAT-Control-Record                      0+     0       |
   |Current-NAT-Bindings                    1      0       |
   |Duplicate-Session-Id                    0      0       |
   +-------------------------------------------------------+


10.  IANA Considerations

   This section contains the namespaces that have either been created in
   this specification or had their values assigned to existing
   namespaces managed by IANA.

10.1.  Command Codes

   IANA is requested to allocate command code values for the following.

   Registry:






Brockners, et al.        Expires April 26, 2010                [Page 35]

Internet-Draft      Diameter NAT Control Application        October 2009


            +----------------+---------------------------+-------------+
            | Code Value     | Name                      | Reference   |
            +----------------+---------------------------+-------------+
            | to be assigned | NAT-Control-Request (NCR) | Section 6.1 |
            | to be assigned | NAT-Control-Answer (NCA)  | Section 6.2 |
            +----------------+---------------------------+-------------+

                          Table 1: Command codes

10.2.  AVP Codes

   IANA is requested to allocate AVP codes for the following AVPs that
   are defined in this document.

   Registry:

         +----------------+----------------------------+---------------+
         | Code Value     | Name                       | Reference     |
         +----------------+----------------------------+---------------+
         | to be assigned | NC-Request-Type            | Section 7.7.1 |
         | to be assigned | NAT-Control-Install        | Section 7.7.2 |
         | to be assigned | NAT-Control-Remove         | Section 7.7.3 |
         | to be assigned | NAT-Control-Definition     | Section 7.7.4 |
         | to be assigned | NAT-Internal-Address       | Section 7.7.5 |
         | to be assigned | NAT-External-Address       | Section 7.7.6 |
         | to be assigned | Max-NAT-Bindings           | Section 7.7.7 |
         | to be assigned | NAT-Control-Binding-Rule   | Section 7.7.8 |
         | to be assigned | Duplicate-Session-Id       | Section 7.7.9 |
         | to be assigned | NAT-Control-Record         | Section 8.2.1 |
         | to be assigned | NAT-Control-Binding-Status | Section 8.2.2 |
         | to be assigned | Current-NAT-Bindings       | Section 8.2.3 |
         +----------------+----------------------------+---------------+

                            Table 2: AVP codes

10.3.  AVP Values

10.3.1.  Result-Code AVP Values

   Section 7.2 defines several new values for the Result-Code AVP for
   transient failures and permanent failures.  IANA is requested to
   allocate the corresponding values from the ranges for transient
   (4xxx) and permanent (5xxx) failures.








Brockners, et al.        Expires April 26, 2010                [Page 36]

Internet-Draft      Diameter NAT Control Application        October 2009


   +-----------+---------------------------------------+---------------+
   | Code      | Name                                  | Reference     |
   | Value     |                                       |               |
   +-----------+---------------------------------------+---------------+
   | to be     | RESOURCE_FAILURE                      | Section 7.2.2 |
   | assigned  |                                       |               |
   | to be     | UNKNOWN_BINDING_RULE_NAME             | Section 7.2.3 |
   | assigned  |                                       |               |
   | to be     | BINDING_FAILURE                       | Section 7.2.3 |
   | assigned  |                                       |               |
   | to be     | MAXIMUM_BINDINGS_REACHED_FOR_ENDPOINT | Section 7.2.3 |
   | assigned  |                                       |               |
   | to be     | SESSION_EXISTS                        | Section 7.2.3 |
   | assigned  |                                       |               |
   | to be     | INSUFFICIENT_CLASSIFIERS              | Section 7.2.3 |
   | assigned  |                                       |               |
   +-----------+---------------------------------------+---------------+

                      Table 3: Result Code AVP Values

10.4.  Application IDs

   IANA is requested to allocate the following application ID using the
   next value from the 7-16777215 range.

   Registry:

       +----------------+----------------------------------+-----------+
       | ID Value       | Name                             | Reference |
       +----------------+----------------------------------+-----------+
       | to be assigned | Diameter NAT Control Application | Section 4 |
       +----------------+----------------------------------+-----------+

                 Table 4:  Diameter Application ID values


11.  Security Considerations

   Similar to what the Diameter QoS application (see
   [I-D.ietf-dime-diameter-qos]) does for authorization of QoS
   reservations, this document describes procedures for authorizing
   network address translation related attributes and parameters by an
   entity which is non-local to the device performing network address
   translation.  The security considerations for the Diameter QoS
   application (see [I-D.ietf-dime-diameter-qos] section 11) apply in a
   similar way to the DNCA.  Securing the information exchange between
   the authorizing entity (the DNCA manager) as well as the NAT device
   requires bilateral authentication of the involved parties,



Brockners, et al.        Expires April 26, 2010                [Page 37]

Internet-Draft      Diameter NAT Control Application        October 2009


   authorization of the involved parties to perform the required
   procedures and functions, as well as procedures to ensure integrity
   and confidentiality of the information exchange.  DNCA makes use of
   the capabilities offered by Diameter as well as the underlying
   transport protocols to deliver on these requirements (see
   Section 5.1).

   It is assumed that the DNCA agent and DNCA manager are in the same
   domain and have a mutual trust set up.  Authorization between the
   DNCA agent and DNCA manager is beyond the scope of this document.


12.  Change history (to be removed prior to publication as an RFC)

   Changes from -00 to -01

   a.  new values for Result-Code AVP used - instead of Experimental-
       Result AVP

   b.  added support for transport specific binding (UDP/TCP)

   c.  added support for twice-NAT

   d.  clarified the use of the two different types of query-requests


13.  References

13.1.  Normative References

   [ETSIES283034]
              ETSI, "Telecommunications and Internet Converged Services
              and Protocols for Advanced Networks (TISPAN),Network
              Attachment Sub-System (NASS),e4 interface based on the
              Diameter protocol.", September 2008.

   [I-D.ietf-dime-qos-attributes]
              Korhonen, J., Tschofenig, H., Arumaithurai, M., Jones, M.,
              and A. Lior, "Quality of Service Attributes for Diameter",
              draft-ietf-dime-qos-attributes-13 (work in progress),
              July 2009.

   [RFC2119]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", BCP 14, RFC 2119, March 1997.

   [RFC3588]  Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J.
              Arkko, "Diameter Base Protocol", RFC 3588, September 2003.




Brockners, et al.        Expires April 26, 2010                [Page 38]

Internet-Draft      Diameter NAT Control Application        October 2009


   [RFC4675]  Congdon, P., Sanchez, M., and B. Aboba, "RADIUS Attributes
              for Virtual LAN and Priority Support", RFC 4675,
              September 2006.

13.2.  Informative References

   [I-D.ietf-dime-diameter-qos]
              Sun, D., McCann, P., Tschofenig, H., ZOU), T., Doria, A.,
              and G. Zorn, "Diameter Quality of Service Application",
              draft-ietf-dime-diameter-qos-11 (work in progress),
              August 2009.

   [I-D.ietf-dime-qos-parameters]
              Korhonen, J., Tschofenig, H., and E. Davies, "Quality of
              Service Parameters for Usage with Diameter",
              draft-ietf-dime-qos-parameters-11 (work in progress),
              May 2009.

   [I-D.nishitani-cgn]
              Nishitani, T., Miyakawa, S., Nakagawa, A., and H. Ashida,
              "Common Functions of Large Scale NAT (LSN)",
              draft-nishitani-cgn-02 (work in progress), June 2009.

   [RFC4005]  Calhoun, P., Zorn, G., Spence, D., and D. Mitton,
              "Diameter Network Access Server Application", RFC 4005,
              August 2005.

   [TS32299]  "3rd Generation Partnership Project; Technical
              Specification Group Service and System Aspects;
              Telecommunication management; Charging management;
              "Diameter charging applications", 3GPP TS 32.299 Version
              6.3.0.2", 2008.


Authors' Addresses

   Frank Brockners
   Cisco
   Hansaallee 249, 3rd Floor
   DUESSELDORF, NORDRHEIN-WESTFALEN  40549
   Germany

   Email: fbrockne@cisco.com








Brockners, et al.        Expires April 26, 2010                [Page 39]

Internet-Draft      Diameter NAT Control Application        October 2009


   Shwetha Bhandari
   Cisco
   Cessna Business Park, Sarjapura Marathalli Outer Ring Road
   Bangalore, KARNATAKA 560 087
   India

   Email: shwethab@cisco.com


   Vaneeta Singh
   Mavenir Systems
   Sharda Towers, 56/13 Nandidurga Road
   Bangalore 560046
   India

   Email: vaneeta@mavenir.com


   Victor Fajardo
   Telcordia Technologies
   1 Telcordia Drive #1S-222
   Piscataway, NJ 08854
   USA

   Email: vfajardo@research.telcordia.com


























Brockners, et al.        Expires April 26, 2010                [Page 40]



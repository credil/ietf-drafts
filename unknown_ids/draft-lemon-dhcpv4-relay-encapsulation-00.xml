<?xml version="1.0" encoding="US-ASCII"?>
<!-- This template is for creating an Internet Draft using xml2rfc,
     which is available here: http://xml.resource.org. -->
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!-- One method to get references from the online citation libraries.
     There has to be one entity for each item to be referenced. 
     An alternate method (rfc include) is described in the references. -->
<!ENTITY RFC2119 SYSTEM "reference.RFC.2119.xml">
<!ENTITY RFC2131 SYSTEM "reference.RFC.2131.xml">
<!ENTITY RFC2132 SYSTEM "reference.RFC.2132.xml">
<!ENTITY RFC3046 SYSTEM "reference.RFC.3046.xml">
<!ENTITY RFC3118 SYSTEM "reference.RFC.3118.xml">
<!ENTITY RFC3315 SYSTEM "reference.RFC.3315.xml">
<!ENTITY RFC3396 SYSTEM "reference.RFC.3396.xml">
<!ENTITY RFC3527 SYSTEM "reference.RFC.3527.xml">
<!ENTITY RFC4030 SYSTEM "reference.RFC.4030.xml">
<!ENTITY RFC1542 SYSTEM "reference.RFC.1542.xml">
<!ENTITY I-D.ietf-dhc-relay-id-suboption SYSTEM
  "reference.I-D.draft-ietf-dhc-relay-id-suboption-07.xml">
<!ENTITY I-D.ietf-dhc-l2ra SYSTEM
  "reference.I-D.draft-ietf-dhc-l2ra-04.xml"> ]>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<!-- used by XSLT processors -->
<!-- For a complete list and description of processing instructions (PIs), 
     please see http://xml.resource.org/authoring/README.html. -->
<!-- Below are generally applicable Processing Instructions (PIs) that most I-Ds might want to use.
     (Here they are set differently than their defaults in xml2rfc v1.32) -->
<?rfc strict="yes" ?>
<!-- give errors regarding ID-nits and DTD validation -->
<!-- control the table of contents (ToC) -->
<?rfc toc="yes"?>
<!-- generate a ToC -->
<?rfc tocdepth="4"?>
<!-- the number of levels of subsections in ToC. default: 3 -->
<!-- control references -->
<?rfc symrefs="yes"?>
<!-- use symbolic references tags, i.e, [RFC2119] instead of [1] -->
<?rfc sortrefs="yes" ?>
<!-- sort the reference entries alphabetically -->
<!-- control vertical white space 
     (using these PIs as follows is recommended by the RFC Editor) -->
<?rfc compact="yes" ?>
<!-- do not start each main section on a new page -->
<?rfc subcompact="no" ?>
<!-- keep one blank line between list items -->
<!-- end of list of popular I-D processing instructions -->
<rfc category="std"
     docName="draft-lemon-dhcpv4-relay-encapsulation-00"
     ipr="trust200902">
  
  <front>
    <!-- The abbreviated title is used in the page header - it is only
	 necessary if the full title is longer than 39 characters -->

    <title>
      Relay Agent Encapsulation for DHCPv4
    </title>

    <author fullname="Ted Lemon" initials="T.L." surname="Lemon">
      <organization>Nominum, Inc.</organization>
      
      <address>
        <postal>
          <street>2000 Seaport Blvd</street>
	  
          <!-- Reorder these if your country does things differently-->
	  
          <city>Redwood City</city>
	  
          <region>CA</region>

          <code>94063</code>

          <country>USA</country>
        </postal>

        <phone>+1 650 381 6000</phone>

        <email>mellon@nominum.com</email>
      </address>
    </author>

    <date day="8" month="August" year="2010" />

    <area>Internet</area>

    <workgroup>dhc</workgroup>

    <keyword>DHCPv4 Relay</keyword>

    <abstract>
      <t>This document describes a general mechanism whereby DHCP
      relay agents can encapsulate DHCP packets that they are
      forwarding in the direction of DHCP servers, and decapsulate
      packets that they they are forwarding toward DHCP clients, so
      that more than one relay agent can insert relay agent suboptions
      into the forwarding chain.</t>
    </abstract>
  </front>
  
  <middle>
    <section title="Introduction">
      <t>In some networking environments, it is useful to be able to
      configure relay agents in a hierarchy, so that information from
      a relay agent close to the client can be combined with information
      from one or more relay agents closer to the server, particularly
      in cases where the relay agents may be in separate administrative
      domains.</t>
      <t>The current <xref target="RFC3046">Relay Agent Information
      Option specification</xref> specifies that when a relay agent
      receives a packet containing an RAIO, it must not add an RAIO.
      This prevents chaining of RAIOs, and hence prohibits
      the hierarchical use case.</t>
      <t><xref target="RFC3315">DHCP version 6</xref> provides a much
      cleaner technique for providing relay agent information
      suboptions to the DHCP server.  Rather than appending an option
      to the DHCP client's message, the relay agent encapsulates the
      DHCP client message in a new DHCP message which it sends to the
      DHCP server along with any options it chooses to add to provide
      information to the DHCP server.</t>
      <t>This document specifies a mechanism for providing the same
      functionality in DHCPv4.</t>
      
      <section title="Requirements Language">
	<t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
	"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
	document are to be interpreted as described in <xref
	target="RFC2119">RFC 2119</xref>.</t>
      </section>
      
      <section title="Terminology">
	<t>The following terms and acronyms are used in this document:
	<list style="hanging">
          <t hangText="DHCP">- Dynamic Host Configuration Protocol Version 4
	  <xref target="RFC2131"></xref></t>
          <t hangText="RAIO"> - <xref target="RFC3046">Relay Agent Information
	  Option</xref>.   Also commonly referred to as "Option 82."</t>
          <t hangText="RAIO suboption"> - An DHCP suboption that has been
	  defined for encapsulation in the Relay Agent Information Option</t>
          <t hangText="agent encapsulation"> - Encapsulating DHCP
          packets that are being relayed from DHCP clients or relay agents
	  toward DHCP servers, according to the method described
          in this specification.</t>
          <t hangText="decapsulate"> - The act of de-encapsulating
          DHCP packets being relayed from DHCP servers or relay agents in
	  the direction of DHCP clients, according to this specification.</t>
          <t hangText="relay message"> - A RELAYFORWARD or RELAYREPLY
	  message.</t>
	  <t hangText="option buffer"> - the portion of the DHCP
	  packet following the magic cookie in the 'vend' field of the
	  DHCP Packet.</t>
	  <t hangText="silently discard"> - in many places in this
	  specification, the implementation is required to silently
	  discard erroneous messages.  What is meant by 'silently
	  discard' is that the implementation MUST NOT send any ICMP
	  message indicating that the delivery was in error.  It may
	  be desirable for the implementation to keep a count of
	  messages that have been discarded, either by message type or
	  by reason for discarding, or some combination.  Nothing in
	  this specification should be construed to forbid such data
	  collection.</t></list></t>
      </section>
    </section>
    
    <section title="Protocol Summary">
      <t>This document specifies two new DHCP message types: the RELAYFORWARD
      message, and the RELAYREPLY message.   These messages are analogous
      to the Relay Forward and Relay Reply messages in <xref target="RFC3315">
      DHCPv6</xref>.</t>
      <section title="RELAYFORWARD Message">
	<t>Conforming relay agents encapsulate messages being sent toward
	DHCP servers in RELAYFORWARD messages.</t>
      </section>
      <section title="RELAYREPLY Message">
	<t>Conforming DHCP servers encapsulate messages being sent toward
	DHCP clients in RELAYREPLY messages.</t>
	<t>Conforming Relay agents, when receiving RELAYREPLY messages,
	decapsulate the message contained in the RELAYREPLY message and
	send it to the next relay.</t>
      </section>	
    </section>

    <section title="Encoding">
      <t>Both RELAYFORWARD and RELAYREPLY messages have the same
      format, which is similar to the format of other DHCP messages.
      The BOOTP/DHCP header has the same format, because it must
      be possible for non-conforming relay agents to parse it.  The
      option buffer, however, contains two segments - the relay
      segment, and the encapsulation segment.</t>
      <section title="Relay Segment">
	<t>The relay segment consists of a DHCP Message Type suboption
	specifying either a RELAYFORWARD or RELAYREPLY message, an
	Encapsulation Information suboption, and any RAIO
	suboptions. These options, including the first two mentioned,
	may appear in any order within the relay segment.</t>
	<t>Option codes in the Relay Segment are RAIO option codes,
	not DHCP option codes.  Relay segments never contain pad
	options.  The length of the relay segment, excluding the magic
	cookie, is specified in the Encapsulation Information
	suboption.  End and Pad options MUST NOT appear within the
	relay segment.</t>
      </section>
      <section title="Encapsulation Segment">
	<t>The encapsulation segment contains either an encapsulated
	relay message, or an encapsulated non-relay message.</t>
	<section title="Encapsulated relay message">
	  <t>An encapsulated relay message option buffer has the same
	  format as the option buffer of a relay message option buffer
	  that is not encapsulated&mdash;a relay segment, followed by
	  an encapsulation segment.  An arbitrary number of encapsulations
	  can be done in this way, as long as there is room in the
	  packet.</t>
	</section>
	<section title="Encapsulated non-relay messages">
	  <t>An encapsulated non-relay message option buffer contains
	  all the options in the message that was encapsulated, with
	  the following exceptions:
	  <list style="symbols">
	    <t>Any options following the first End option
	    are omitted (these options are assumed to be garbage; any
	    signature is assumed not to apply to them.</t>
	    <t>Any Pad options present either at the end
	    of the option buffer, or prior to the first End packet,
	    that are followed only by other Pad options or a single
	    End option are omitted, and the number of Pad options
	    omitted is recorded in the Relay Encapsulation Information
	    suboption.</t>
	    <t>If an End option is present at the end of the option
	    buffer being encapsulated, it is omitted, and the ep field
	    is set to 1.  If no End option is present, the ep field is
	    set to 0.  If more than one End option is present, only the
	    final End option is omitted.</t></list></t>
	</section>
      </section>
      <section title="Encapsulation Information suboption">
	<t>The Encapsulation Information suboption is used by the relay
	to report the total length of the data being encapsulated, the
	amount of stripped padding, and whether or not an end option
	was stripped.  This is necessary in order to ensure that the
	original packet contents can be reconstructed when
	decapsulating, which in turn allows the server to check any
	<xref target="RFC3118">signature</xref> that may be present.</t>
	<figure>
	  <artwork>
+----+----+----+----+----+----+----+----+----+
|code| len|  rslen  |  caplen |  padlen | ep |
+----+----+----+----+----+----+----+----+----+
	  </artwork>
	</figure>
	<t>The Encapsulation Information Suboption consists of six parts:
	<list style="hanging">
	  <t hangText="code">The suboption code: a single byte with a
	  value value of TBD</t>
	  <t hangText="len">The suboption length: a single byte with a
	  value of 7.</t>
	  <t hangText="rslen">The length of the relay
	  segment: two byte in network byte order.</t>
	  <t hangText="caplen">The length of the encapsulation
	  segment: two byte in network byte order.</t>
	  <t hangText="padlen">The length of any padding that was
	  removed from the option buffer prior to encapsulation: two
	  bytes in network byte order.</t>
	  <t hangText="ep">If an End option was present in the option
	  buffer prior to encapsulation, this field is set to 1;
	  otherwise, it is set to 0.  This field is a single byte.</t>
	</list>
	</t>
      </section>
      <section title="Encapsulating Agent Address suboption">
	<t>The Encapsulating Agent Address suboption indicates to the
	DHCP server or intermediate relay the IP address of the relay agent
	which did the encapsulation.</t>
	<figure>
	  <artwork>
+----+----+----+----+----+----+
|code| len|   relay ip addr   |
+----+----+----+----+----+----+
	  </artwork>
	</figure>
	<t>The Encapsulating Agent Address suboption consists of
	the following fields:
	<list style="hanging">
	  <t hangText="code">The suboption code: a single byte with a
	  value value of TBD</t>
	  <t hangText="len">The suboption length: a single byte with a
	  value of 4.</t>
	  <t hangText="relay ip addr">The IP address of the relay agent.</t>
	</list></t>
      </section>
      <section title="Gateway IP Address suboption">
	<t>The Gateway IP address suboption is used to specify an IP address
	to store in the giaddr of a decapsulated packet.</t>
	<figure>
	  <artwork>
+----+----+----+----+----+----+
|code| len|  gateway ip addr  |
+----+----+----+----+----+----+
	  </artwork>
	</figure>
	<t>The Gateway IP Address suboption consists of the following
	fields:
	<list style="hanging">
	  <t hangText="code">The suboption code: a single byte with a
	  value value of TBD</t>
	  <t hangText="len">The suboption length: a single byte with a
	  value of 4.</t>
	  <t hangText="relay ip addr">The IP address to store in giaddr.</t>
	</list></t>
      </section>
      <section title="Message Type Suboption">
	<t>Because options in the relay segment are encoded using
	<xref target="RFC3046">RAIO suboption codes</xref>, not <xref
	target="RFC2132">DHCP option codes</xref>, and because the
	Message Type option must appear in the relay segment, we
	define an RAIO suboption that is exactly the same as the DHCP
	Message Type option specified in <xref
	target="RFC2132">section 9.6 of DHCP Options and BOOTP Vendor
	Extensions</xref>.   This suboption has an option code of 53.</t>
      </section>
      <section title="Relay Agent Information Suboption">
	<t>As with the Message Type suboption, it is possible that a
	non-conforming relay agent will append an RAIO to a
	RELAYFORWARD message.  In order for that to be parsed
	correctly, we must define an analog to the RAIO.  The Relay
	Agent Information suboption is treated as if it were an RAIO
	when unpacking a RELAYFORWARD message.  When constructing a
	RELAYREPLY message that will be handled by a non-conforming
	relay agent that included an RAIO, a Relay Agent Information
	suboption will be used exactly as if it were an RAIO.</t>
	<figure>
	  <artwork>
+----+----+----+----+----+...--+
|code| len|  suboptions...     |
+----+----+----+----+----+...--+
	  </artwork>
	</figure>
	<t>The Relay Agent Information suboption consists of the
	following fields:
	<list style="hanging">
	  <t hangText="code">The suboption code: a single byte with a
	  value value of TBD</t>
	  <t hangText="len">The suboption length: a single byte
	  containing the length of the suboptions field.</t>
	  <t hangText="suboptions...">Zero or more Relay Agent
	  Information suboptions.</t>
	</list></t>
      </section>
    </section>

    <section title="DHCP Relay Agent Behavior">
      <t>DHCP Relay agents implementing this specification MUST have a
      configuration parameter controlling relay encapsulation.  By
      default, relay encapsulation MUST be disabled.</t>
      <t>Relay agents with encapsulation disabled MUST NOT
      encapsulate.  Relay agents with encapsulation disabled MUST NOT
      decapsulate.  Relay agents that encapsulate MUST NOT encapsulate
      BOOTP messages (that is, messages that do not contain the DHCP
      Message Type option).</t>
      <t>In any case where a relay agent implementing this specification
      does not encapsulate or decapsulate, it MUST behave exactly as
      a relay agent would that did not implement this specification at
      all.</t>
      <t>DHCP relay agents that are configured with encapsulation
      enabled, but which have no agent-specific options to send to the
      DHCP server, MUST encapsulate.  Relay agents that are configured
      with encapsulation enabled MUST decapsulate.</t>
      <section title="Packet processing">
	<t>Relay agents implementing this specification may receive
	packets directed toward DHCP servers with a source port of 67
	(BOOTPS).  Therefore, the source port cannot be used to
	determine whether the packet is traveling toward a DHCP server
	or toward a DHCP client.</t>

	<t>In order to determine whether a message is traveling toward
	a DHCP client or toward a DHCP server, the relay agent must
	check the 'op' field of the DHCP message.  If the 'op' field
	is set to 1, the message is traveling toward a DHCP server.
	If the 'op' field is set to zero, the message is traveling
	toward a DHCP client.  At the time of the writing of this
	specification, no other value is meaningful in the 'op' field.
	Relay agents implementing this specification MUST NOT
	encapsulate or decapsulate messages with other values in the
	'op' field.  It is assumed that if meanings are defined for
	additional values, the document that specifies the meaning of
	those values will update this document; in the absence of such
	an update, the behavior specified here will remain in effect.</t>

	<section title="Packets traveling toward DHCP servers">
	  <t>When a DHCP relay agent receives a RELAYREPLY message
	  that is traveling toward the DHCP server, the relay agent
	  MUST silently discard the message.</t>
	  <t>When a DHCP relay agent that is configured to encapsulate
	  receives a DHCP message that is traveling toward the DHCP
	  server that is not a RELAYREPLY message, the relay agent
	  MUST encapsulate that packet into a RELAYFORWARD message and
	  sends it to the address or addresses to which it is
	  configured to forward messages intended for DHCP
	  servers.</t>
	</section>
	<section title="Packets traveling toward DHCP clients">
	  <t>When a DHCP relay agent receives a RELAYFORWARD message
	  that is traveling toward the DHCP client, the relay agent
	  MUST discard the message.</t>
	  <t>When a DHCP relay agent that is configured to encapsulate
	  receives a RELAYREPLY message that is traveling toward the
	  DHCP client, the relay agent MUST decapsulate that message
	  and forward the decapsulated message toward the client.</t>
	  <t>When a DHCP relay agent configured to encapsulate
	  receives any other message moving toward a DHCP client, it
	  MUST silently discard the message.</t>
	</section>
      </section>
      <section title="Constructing RELAYFORWARD messages">
	<t>The relay agent constructs the RELAYFORWARD message by
	copying the source message up to the end of the magic cookie
	in the option buffer of the message.  Following that, the
	relay agent constructs the relay segment, as described below.
	Following that, the relay agent copies 'caplen' octets from
	the option buffer of the source message, starting at the
	beginning of the first option that follows the magic cookie.</t>
	<t>The relay agent MUST NOT modify the 'giaddr' field, or any
	other field, of the constructed RELAYFORWARD message.</t>
	<section title="Encapsulating RELAYFORWARD messages">
	  <t>When encapsulating RELAYFORWARD messages, the length of
	  the encapsulation segment is the sum of the 'rslen' and
	  'caplen' fields in the encapsulation segment of the
	  RELAYFOWARD message.  This will be the value stored in the
	  'caplen' field in the new encapsulation segment.  The
	  'padlen' and 'ep' fields are always set to zero when
	  encapsulating RELAYFORWARD messages.</t>
	</section>
	<section title="Encapsulating other messages">
	  <t>When encapsulating other messages, the length of the
	  encapsulation segment is determined by scanning forward
	  across the option buffer of the source message, beginning
	  with the first option in the option buffer, until an End
	  option is reached, or there are no more options in the
	  option buffer.  Any data following the End option is
	  discarded.</t>
	  <t>While scanning, the relay agent maintains a flag which
	  indicates whether or not a pad option has been encountered.
	  The flag is initialized to false.  When a Pad option is
	  encountered, if the flag is false, it is set to true, and
	  the location of that Pad option is recorded.  If an option
	  that is neither a Pad option nor an End option is
	  encountered, the flag is set to false.  In any other case,
	  no action is taken with respect to either the flag or the
	  Pad location.</t>
	  <t>When the end of the option buffer is reached, the value
	  of 'padlen' is computed as the difference, in octets,
	  between the location of the end of the option
	  segment&mdash;either the location of the first End option
	  encountered, or the first location after the
	  buffer&mdash;and the last location recorded for a Pad
	  option; if the pad flag is false, then 'padlen' is always
	  zero.</t>
	  <t>If the pad flag is true, then 'caplen' is the difference
	  in octets between the last location recorded for a Pad
	  option and the location of the first option in the option
	  buffer.  If it is false, then 'caplen' is the difference in
	  octets between the location of the first End option
	  encountered in the option buffer and the first option in the
	  buffer.  If flag is false and no End option is present in
	  the option buffer, then 'caplen' is the length of the option
	  buffer, less four octets for the magic cookie.</t>
	  <t>The 'ep' field is set to zero if no End option was
	  present in the option buffer; it is set to one if an End
	  option was present.</t>
	  <t>Note that the <xref target="RFC3046">RAIO
	  specification</xref> requires that if an End option is
	  present in the DHCP message to which the RAIO is to be
	  appended, the RAIO will instead be inserted immediately
	  prior to the End option.  This means that if a conforming
	  implementation encapsulates a packet containing an RAIO, it
	  will simply appear as an option in the encapsulation
	  segment.  When encapsulating, relay agents MUST NOT include
	  an RAIO if it follows an End option.</t>
	</section>
	<section title="Constructing the relay segment">
	  <t>The relay agent constructs the relay segment by including
	  any RAIO options it is configured to send.  The relay agent
	  MUST include a DHCP Message Type suboption, with the message
	  type set to 'RELAYFORWARD' (TBD).</t>
	  <t>The relay agent SHOULD include a <xref
	  target="I-D.ietf-dhc-relay-id-suboption">Relay Agent ID
	  suboption</xref> to identify itself.</t>
	  <t>If the relay agent is not a <xref
	  target="I-D.ietf-dhc-l2ra">layer two relay agent</xref>, it
	  MUST include an Encapsulation Forwarding Address suboption
	  containing a valid IP address that is reachable by the next
	  hop relay(s) or DHCP server(s) to which the relay agent is
	  configured to forward.</t>
	  <t>The relay agent MUST include an Encapsulation Information
	  suboption.  The 'caplen' and 'padlen' fields of this
	  suboption are set to the values determined in the previous
	  section.  The 'rslen' field is set to the total length of
	  the options in the relay segment, including the
	  Encapsulation Information suboption.</t>
	</section>
      </section>
      <section title="Decapsulating RELAYREPLY messages">
	<t>There are five parts to the decapsulation process:
	<list style="symbols">
	  <t>identifying the Encapsulation Information subption,</t>
	  <t>using it to extract relay agent suboptions from the relay
	  segment of the RELAYREPLY message,</t>
	  <t>processing those suboptionsm</t>
	  <t>constructing the decapsulated message,</t>
	  <t>forwarding the decapsulated message toward the DHCP client.</t>
	</list></t>
	<section title="Extracting and processing relay agent suboptions">
	  <t>The relay agent first locates the Encapsulation
	  Information suboption in the option buffer of the RELAYREPLY
	  message.  Although this option always appears in the relay
	  segment of the RELAYREPLY message, the relay agent has no
	  way to differentiate the encapsulation segment and the relay
	  segment until it has located this option, so it simply scans
	  forward, option by option, in the option buffer until it
	  finds this option.</t>
	  <t>If the relay agent fails to locate an Encapsulation
	  Information suboption, it MUST silently discard the
	  RELAYREPLY message.</t>
	  <t>Once the relay agent has located the Encapsulation
	  Information suboption, it parses the portion of the
	  'options' field of the DHCP packet starting with the first
	  option following the magic cookie, up to the number of bytes
	  specified by the 'rslen' field of the Encapsulation
	  Information suboption.</t>
	  <t>The suboptions parsed from the relay segment are
	  processed by the relay agent as specified in <xref
	  target="RFC3046">the Relay Agent Information Option
	  specification</xref>, as well as in any documents that
	  define suboptions to the Relay Agent Information Option.  A
	  current list of DHCP Relay Agent suboptions and the
	  documents that define them can be located in the IANA
	  protocol registry for BOOTP and DHCP parameters, in the
	  section titled "DHCP Relay Agent Sub-Option Codes."</t>
	</section>
	<section title="Constructing the decapsulated message">
	  <t>In order to decapsulate the RELAYREPLY message, the relay
	  agent constructs a new, decapsulated message by copying the
	  portion of the RELAYREPLY message up to and including the
	  magic cookie in the 'options' field of the message.   The
	  relay agent then copies the portion of the 'options' field
	  of the source message beginning after the relay segment, up to
	  'caplen' bytes, into the new message.   If the 'padlen' field
	  is nonzero, the relay agent appends that many Pad options to the
	  new message.   If the 'ep' field is nonzero, the relay agent
	  appends an 'End' option to the new message.</t>
	  <t>If a Gateway IP Address suboption is present in the relay
	  segment, the relay agent MUST store the IP address contained
	  in that option in the 'giaddr' field of the new message.</t>
	</section>
	<section title="Transmitting the decapsulated message">
	  <t>The decapsulated message is forwarded to the IP address
	  specified in the Encapsulating Agent Address suboption, if
	  that suboption is present.  If that suboption is not
	  present, the message is forwarded to the DHCP client as if
	  it were on the local subnet, as specified in <xref
	  target="RFC2131">the DHCP protocol specification</xref>.
	  This suboption will not be present if the next hop is the
	  DHCP client, or if all remaining relay agents in the relay
	  chain are layer two relay agents.</t>
	</section>
      </section>
    </section>

    <section title="DHCP Server Behavior">
      <t>A DHCP server which receives a RELAYREPLY message MUST
      silently discard that message.</t>
      <section title="Receiving RELAYFORWARD messages">
	<t>DHCP servers that implement this specification MUST decapsulate
	RELAYFORWARD messages.</t>
	<section title="Decapsulation">
	  <t>By design, this specification supports multiple layers of
	  encapsulation.  The DHCP server implementation therefore
	  MUST decapsulate each layer and retain the information in
	  that layer, organized so that the ordering of the
	  encapsulation is available both during packet processing,
	  and when constructing the reply.</t>
	  <t>In addition, this specification allows for the
	  provisioning of a single non-conforming relay agent anywhere
	  in the forwarding chain, through the use of the Gateway IP
	  Address suboption.  DHCP servers implementing this
	  specification MUST record the Relay Agent Information option
	  contents as if they were a layer of encapsulation, in the
	  correct order, marked for special handling when constructing
	  the response.</t>
	  <t>Aside from the necessity of handling an RAIO differently
	  than an encapsulation when constructing a RELAYREPLY
	  message, DHCP servers MUST NOT, by default, treat relay
	  suboptions received in an RAIO any differently than relay
	  suboptions received in an encapsulation.</t>
	  <t>It is not the goal of this specification to define a
	  particular implementation strategy or data structure for
	  representing the encapsulation, so long as the ability to
	  process the options and suboptions as required below is
	  preserved.  Implementations MAY provide means for addressing
	  the contents of relay segments and of the inner
	  encapsulation segment in any convenient form, as long as it
	  conforms generally to the requirements of this document.</t>
	</section>
	<section title="Processing of decapsulated suboptions">
	  <t>This section specifies requirements for the processing of
	  decapsulated relay suboptions in the default case, where no
	  custom processing has been specified.  This should not be
	  construed to forbid implementations for providing mechanisms
	  for customizing the processing of these suboptions.</t>
	  <t>This document does not specify special handling for DHCP
	  options.  Only the inner encapsulation&mdash;the
	  encapsulation of the original message sent from the client,
	  which is done by the first encapsulating relay&mdash;can
	  ever contain DHCP Options; hence, whatever normal mechanisms
	  a DHCP server provides for processing these options should
	  suffice.</t>
	  <t>Some relay agent suboptions, such as the <xref
	  target="RFC3527">Relay Agent Subnet Selection
	  suboption</xref>, are intended to be processed by DHCP
	  servers.  Others, like the <xref target="RFC3046">Circuit ID
	  and Remote ID</xref> suboptions, were not intended to be
	  processed by the DHCP server, but are often used by the DHCP
	  server for identification purposes.</t>
	  <t>In cases where more than one relay agent sends the same
	  suboption, the DHCP server must either factor all such
	  suboptions into its processing, or choose one such suboption
	  and use that exclusively for processing.</t>
	  <t>By default, DHCP servers MUST use the innermost suboption
	  (the one added by the relay agent closest to the DHCP
	  client) for every suboption that was sent by more than one
	  relay agent.</t>
	</section>
      </section>
      <section title="Sending RELAYREPLY messages">
	<t>When a DHCP server constructs a response to a DHCP client
	message that arrived encapsulated in a RELAYFORWARD message,
	the DHCP server MUST encapsulate the response in a RELAYREPLY
	message.  When multiple layers of RELAYFORWARD messages were
	received, the server MUST respond with an equivalently
	layering of RELAYREPLY messages.  When an RAIO was found, the
	DHCP server MUST return an RAIO at the same position in the
	encapsulation, if any.</t>
	<t>When a DHCP server constructs a response to a DHCP client
	message that did not arrive encapsulated in a RELAYFORWARD
	message, the DHCP server MUST NOT encapsulate the response in
	a RELAYREPLY message.</t>
	<t>In general, RELAYREPLY messages are constructed in the same
	way that RELAYFORWARD messages are constructed.  However,
	there are two key differences to consider in the construction
	of the relay segment of RELAYREPLY messages:
	<list style="symbols">
	  <t>the use of the Encapsulating Agent Address
	  suboption</t>
	  <t>the use of the Gateway IP Address suboption</t>
	</list></t>
	<section title="Directing responses along the reply chain">
	  <t>Relay agents indicate their IP addresses to the DHCP
	  server using the Encapsulating Agent Address suboption.
	  DHCP servers indicate the IP address of the agent to which
	  to forward the response using the Encapsulating Agent
	  Address option.</t>
	  <t>This means that in a RELAYFORWARD message, the
	  Encapsulating Agent Address option contains the address of
	  the relay agent that constructed the message.  In the
	  RELAYREPLY message, it contains a different address: the
	  address to which the message encapsulated in the RELAYREPLY
	  message should be sent.</t>
	  <t>This is complicated by the fact that a layer two relay
	  agent or a non-conforming relay agent can appear at any
	  position in the relay chain.  In the case of a
	  non-conforming relay agent, we use giaddr instead of the
	  Encapsulating Agent Address suboption to indicate the IP
	  address to which the relay agent should forward the
	  response.</t>
	  <t>In the case of a layer two relay agent, some
	  encapsulation layer inside of the layer two agent's layer
	  may contain the IP address of the next hop in the chain that
	  has an IP address.  If all the relay agents between the
	  layer two relay agent and the client are also layer two
	  relay agents, there will be no IP address to which to
	  forward the response.</t>
	  <t>In either case, it is assumed that if there is no
	  downstream device with an IP address prior to the DHCP
	  client, normal packet transmission rules for reaching the
	  DHCP client are used, as specified in <xref
	  target="RFC2131">the DHCP protocol</xref>.</t>
	</section>
	<section title="Inner message">
	  <t>When a DHCP server is constructing a response to a
	  RELAYFORWARD message, it starts with the DHCP message that
	  is to be delivered to a client&mdash;for example, a DHCPACK
	  message.  This message is constructed in the usual way,
	  except that giaddr is not set, even if it was set in the
	  RELAYFORWARD message.  This message becomes the outgoing
	  message.</t>
	  <t>The DHCP server MUST NOT insert any Pad or End options
	  into the initial outgoing message.</t>
	</section>
	<section title="Iterating across the encapsulation layers">
	  <t>As it iterates across the layers of encapsulation, The
	  DHCP server tracks two values: a next-hop destination
	  address, and a next-hop gateway address.  Initially both
	  values are 0.0.0.0.  It also tracks a flag called
	  "appended RAIO" which starts out false.</t>
	  <t>The DHCP server iterates across the recorded information
	  from the encapsulations it unpacked when it received the
	  RELAYFORWARD message, starting with the innermost
	  encapsulation, and proceeding toward the outermost, in
	  order.</t>
	</section>
	<section title="Per-iteration processing">
	  <section title="Processing for non-conforming relay agents">
	    <t>If a particular layer was created by parsing an RAIO,
	    rather than by unpacking an encapsulation, then the server
	    packs an RAIO onto the end of the outgoing message.
	    Otherwise, the server encapsulates the outgoing message in
	    a RELAYREPLY message.</t>
	    <t>If the server is packing an RAIO, the suboptions in the
	    RAIO are constructed as specified in <xref
	    target="RFC3046">the RAIO specification</xref> and any
	    suboption-specific documents that apply.  When the server
	    packs an RAIO, it MUST set the next-hop gateway IP address
	    value to the value of the next-hop destination IP address,
	    and set the value of the next-hop destination IP address
	    to the value of giaddr from the incoming RELAYFORWARD
	    message.</t>
	    <t>When the server packs an RAIO, it appends it to the end
	    of the outgoing message, and sets the "appended RAIO" flag
	    to true.  If there are any further layers of
	    encapsulation, this outgoing message is used as the input
	    for the next layer of encapsulation.</t>
	  </section>
	  <section title="Processing for conforming relay agents">
	    <t>To encapsulate a layer, the server creates a new
	    message based on the outgoing message by first copying the
	    outgoing message, up to the magic number in the option
	    buffer, then inserting a relay segment, and then copying
	    the remainder of the option buffer into the encapsulation
	    segment.  The implementation is of course not required to
	    copy multiple times; it is specified this way here solely
	    for clarity.</t>
	    <t>The server MUST NOT insert any Pad or End options
	    either in the relay segment or the encapsulation segment
	    of the new message.</t>
	    <t>The server MUST copy every suboption that appeared in
	    the incoming relay segment into the outgoing relay
	    segment, except for the Message Type, Encapsulation
	    Information and Encapsulating Agent Address suboptions,
	    and except for relay agent suboptions whose specifications
	    require or permit other behavior for the server.  The
	    server SHOULD NOT preserve the order of options from the
	    incoming relay segment to the outgoing relay segment.</t>
	    <t>The server MUST insert a Message Type suboption with a
	    message type of RELAYREPLY (TBD).</t>
	    <t>If the "appended RAIO" flag is true, and the current
	    next-hop gateway address value is not 0.0.0.0, the server
	    MUST insert a Gateway IP Address suboption into the relay
	    segment.  The 'gateway ip addr' field MUST be set to the
	    current next-hop gateway address value.  The DHCP server
	    MUST then set the next-hop gateway address value to
	    0.0.0.0.</t>
	    <t>If there was an Encapsulating Agent IP Address
	    suboption in the incoming relay segment for the current
	    layer, and the next-hop destination IP address value is
	    not 0.0.0.0, the DHCP server MUST insert an Encapsulating
	    Agent IP Address suboption into the relay segment, and it
	    MUST set the 'relay ip addr' field to the current next-hop
	    destination address.  The server MUST then set the value
	    of the next-hop destination address to 0.0.0.0.</t>
	    <t>The DHCP server MUST insert an Encapsulation
	    Information suboption.  The 'rslen' field MUST be set to
	    the length of the relay segment.  The 'caplen' field MUST
	    be set to the length of the encapsulation segment.  The
	    'padlen' and 'ep' fields must be zero.</t>
	    <t>Having completed an encapsulation layer, the new
	    message becomes the outgoing message.  The server sets the
	    "appended RAIO" flag to false.  If an additional layer of
	    encapsulation remains to be processed, the new outgoing
	    message will be used as input for the next iteration.</t>
	  </section>
	</section>
	<section title="Transmission of RELAYREPLY messages">
	  <t>This needs work.  I am not sure that all the giaddr
	  intricacies are accounted for.</t>
	  <t>During iteration across the incoming encapsulations, the
	  DHCP server tracked two values: the next-hop IP address, and
	  the next-hop gateway address.  If the next-hop gateway
	  address value is not 0.0.0.0, and the "appended RAIO" flag
	  is true, the DHCP server MUST set the 'giaddr' field of the
	  outgoing message to that value.</t>
	  <t>If the next-hop destination address is not 0.0.0.0, the
	  DHCP server MUST send the outgoing message to that address,
	  with a destination port of 67.  If the next-hop destination
	  address is 0.0.0.0, the DHCP server MUST transmit the packet
	  as specified in <xref target="RFC2131">the DHCP
	  protocol"</xref> for the case where the client is on the
	  local subnet.</t>
	</section>
      </section>
    </section>

    <section title="DHCP Client Behavior">
      <t>A DHCP client that receives either a RELAYFORWARD message or
      a RELAYREPLY message MUST silently discard that message.</t>
    </section>

    <section title="Security Considerations">
      <t>Need to specify how encapsulations are signed.</t>
    </section>

    <section title="IANA Considerations">
      <t>We request that IANA assign three new suboption codes from
      the registry of DHCP Agent Sub-Option Codes maintained in
      http://www.iana.org/assignments/bootp-dhcp-parameters.  One each
      of these suboption codes will be assigned to the Encapsulation
      Information suboption, the Encapsulating Agent Address
      suboption, and the Gateway IP Address suboption.</t>
      <t>We request that IANA assign a new suboption code from the
      registry of DHCP Agent Sub-Option Codes maintained in
      http://www.iana.org/assignments/bootp-dhcp-parameters.  The
      value of this suboption code MUST be 53, so as to be compatible
      with the DHCP Message Type option.  This suboption code will be
      assigned to the DHCP Message Type suboption.</t>
      <t>We request that IANA assign a new suboption code from the
      registry of DHCP Agent Sub-Option Codes maintained in
      http://www.iana.org/assignments/bootp-dhcp-parameters.  The
      value of this suboption code MUST be 82, so as to be compatible
      with the Relay Agent Information option.  This suboption code will be
      assigned to the Relay Agent Information suboption.</t>
      <t>We request that IANA assign two new message type codes from
      the registry of DHCP Message Type 53 values maintained in
      http://www.iana.org/assignments/bootp-dhcp-parameters.  These
      two codes will be assigned to the RELAYFORWARD and
      RELAYREPLY message types.</t>
    </section>
  </middle>

  <back>
    <references title="Normative References">
      &RFC2119;
      &RFC2131;
      &RFC2132;
      &RFC3046;
      &RFC3118;
      &RFC3527;
      &I-D.ietf-dhc-relay-id-suboption;
    </references>

    <references title="Informative References">
      &RFC3315;
      &I-D.ietf-dhc-l2ra;
    </references>
  </back>
</rfc>

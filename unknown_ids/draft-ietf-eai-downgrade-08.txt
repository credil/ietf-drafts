


Email Address Internationalization                      K. Fujiwara, Ed.
(EAI)                                                     Y. YONEYA, Ed.
Internet-Draft                                                      JPRS
Intended status: Experimental                              July 14, 2008
Expires: January 15, 2009


      Downgrading mechanism for Email Address Internationalization
                    draft-ietf-eai-downgrade-08.txt

Status of this Memo

   By submitting this Internet-Draft, each author represents that any
   applicable patent or other IPR claims of which he or she is aware
   have been or will be disclosed, and any of which he or she becomes
   aware will be disclosed, in accordance with Section 6 of BCP 79.

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF), its areas, and its working groups.  Note that
   other groups may also distribute working documents as Internet-
   Drafts.

   Internet-Drafts are draft documents valid for a maximum of six months
   and may be updated, replaced, or obsoleted by other documents at any
   time.  It is inappropriate to use Internet-Drafts as reference
   material or to cite them other than as "work in progress."

   The list of current Internet-Drafts can be accessed at
   http://www.ietf.org/ietf/1id-abstracts.txt.

   The list of Internet-Draft Shadow Directories can be accessed at
   http://www.ietf.org/shadow.html.

   This Internet-Draft will expire on January 15, 2009.

Abstract

   Traditional mail systems handle only ASCII characters in SMTP
   envelope and mail header fields.  The Email Address
   Internationalization (UTF8SMTP) extension allows UTF-8 characters in
   SMTP envelope and mail header fields.  To avoid rejecting
   internationalized Email messages when a server in the delivery path
   does not support the UTF8SMTP extension, some sort of converting
   mechanism is required.  This document describes a downgrading
   mechanism for Email Address Internationalization.  Note that this is
   a way to downgrade, not tunnel.  There is no associated up-conversion
   mechanism, although internationalized email clients might use
   original internationalized addresses or other data when displaying or



Fujiwara & YONEYA       Expires January 15, 2009                [Page 1]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   replying to downgraded messages.


Table of Contents

   1.  Introduction . . . . . . . . . . . . . . . . . . . . . . . . .  3
   2.  Terminology  . . . . . . . . . . . . . . . . . . . . . . . . .  4
   3.  New header fields definition . . . . . . . . . . . . . . . . .  5
     3.1.   Envelope information preservation headers . . . . . . . .  5
     3.2.   Address header field preservation headers . . . . . . . .  5
     3.3.   Unknown header fields preservation headers  . . . . . . .  6
   4.  SMTP Downgrading . . . . . . . . . . . . . . . . . . . . . . .  7
     4.1.   Path element downgrading  . . . . . . . . . . . . . . . .  7
     4.2.   ORCPT downgrading . . . . . . . . . . . . . . . . . . . .  8
   5.  Email header fields downgrading  . . . . . . . . . . . . . . .  8
     5.1.   Downgrading method for each header field  . . . . . . . .  9
   6.  MIME body part headers downgrading . . . . . . . . . . . . . . 11
   7.  Security considerations  . . . . . . . . . . . . . . . . . . . 12
   8.  Implementation notes . . . . . . . . . . . . . . . . . . . . . 13
     8.1.   Trivial downgrading . . . . . . . . . . . . . . . . . . . 13
     8.2.   7bit transport consideration  . . . . . . . . . . . . . . 13
   9.  IANA Considerations  . . . . . . . . . . . . . . . . . . . . . 13
   10. Acknowledgements . . . . . . . . . . . . . . . . . . . . . . . 16
   11. Change History . . . . . . . . . . . . . . . . . . . . . . . . 16
     11.1.  draft-yoneya-ima-downgrade: Version 00  . . . . . . . . . 16
     11.2.  draft-yoneya-ima-downgrade: Version 01  . . . . . . . . . 16
     11.3.  draft-ietf-eai-downgrade: Version 00  . . . . . . . . . . 16
     11.4.  draft-ietf-eai-downgrade: Version 01  . . . . . . . . . . 16
     11.5.  draft-ietf-eai-downgrade: Version 02  . . . . . . . . . . 16
     11.6.  draft-ietf-eai-downgrade: Version 03  . . . . . . . . . . 17
     11.7.  draft-ietf-eai-downgrade: Version 04  . . . . . . . . . . 17
     11.8.  draft-ietf-eai-downgrade: Version 05  . . . . . . . . . . 17
     11.9.  draft-ietf-eai-downgrade: Version 06  . . . . . . . . . . 17
     11.10. draft-ietf-eai-downgrade: Version 07  . . . . . . . . . . 18
     11.11. draft-ietf-eai-downgrade: Version 08  . . . . . . . . . . 18
   12. Normative References . . . . . . . . . . . . . . . . . . . . . 18
   Appendix A.  Examples  . . . . . . . . . . . . . . . . . . . . . . 19
     A.1.   Downgrading example 1 . . . . . . . . . . . . . . . . . . 19
     A.2.   Downgrading example 2 . . . . . . . . . . . . . . . . . . 22
   Authors' Addresses . . . . . . . . . . . . . . . . . . . . . . . . 24
   Intellectual Property and Copyright Statements . . . . . . . . . . 25










Fujiwara & YONEYA       Expires January 15, 2009                [Page 2]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


1.  Introduction

   Traditional mail systems which are defined by [RFC2821] and [RFC2822]
   allow ASCII characters in SMTP envelope and mail header field values.
   The UTF8SMTP extension [RFC4952], [I-D.ietf-eai-utf8headers] and
   [I-D.ietf-eai-smtpext] allows UTF-8 characters in SMTP envelope and
   mail header field values.

   If an envelope address or header field contains non-ASCII characters,
   the message cannot be delivered unless every system in the delivery
   path supports UTF8SMTP.  This document describes a downgrading
   mechanism to avoid rejection of such messages when a server which
   does not support the UTF8SMTP extension is encountered.  Downgrading
   mechanism converts envelope and header fields to an all-ASCII
   representation.

   [I-D.ietf-eai-utf8headers] allows UTF-8 characters to be used in mail
   header fields and MIME header fields.  The downgrading mechanism
   specified here converts mail header fields and MIME header fields to
   ASCII.

   This document does not change any protocols except by defining new
   header fields.  It describes the conversion method from the
   internationalized email envelopes/messages which are defined in
   [RFC4952] [I-D.ietf-eai-utf8headers] [I-D.ietf-eai-smtpext] to the
   traditional email envelopes/messages which are defined in [RFC2821]
   [RFC2822].

   [I-D.ietf-eai-smtpext] section 2.2 defines when downgrading occurs.
   If the SMTP client has an UTF8SMTP envelope or an internationalized
   message and the SMTP server doesn't support the UTF8SMTP SMTP
   extension, then the SMTP client MUST NOT send a UTF8SMTP envelope or
   an internationalized message to the SMTP server.  The section shows 4
   choices.  The fourth choice is downgrading, as described here.

   Downgrading may be implemented in MUAs, MSAs, MTAs which act as the
   SMTP client, or in MDAs, POP servers, IMAP servers which store or
   offer UTF8SMTP envelopes or internationalized messages to non-
   UTF8SMTP compliant systems which include message stores.

   This document tries to define the downgrading process clearly and it
   preserves the original information as much as possible.

   Downgrading in UTF8SMTP consists of the following four parts:
   o  New header fields definition
   o  SMTP downgrading





Fujiwara & YONEYA       Expires January 15, 2009                [Page 3]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   o  Email header fields downgrading
   o  MIME header fields downgrading


   In Section 3, many header fields starting with "Downgraded-" are
   introduced.  They preserve the original envelope information and the
   original header fields.

   The SMTP downgrading is described in Section 4.  It generates ASCII
   only envelope information from an UTF8SMTP envelope.

   The Email header fields downgrading is described in Section 5.  It
   generates ASCII only header fields.

   The MIME header fields are expanded in [I-D.ietf-eai-utf8headers].
   The MIME header fields downgrading is described in Section 6.  It
   generates ASCII only MIME header fields.


2.  Terminology

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in RFC 2119 [RFC2119].

   All specialized terms used in this specification are defined in the
   EAI overview [RFC4952] or in [RFC2821][RFC2822], MIME documents
   [RFC2045] [RFC2047] [RFC2183] [RFC2231].  The terms "ASCII address",
   "internationalized email address", "non-ASCII address", "i18mail
   address", "UTF8SMTP", "message" and "mailing list" are used with the
   definitions from [RFC4952] document.

   This document depends on [I-D.ietf-eai-smtpext],
   [I-D.ietf-eai-utf8headers], and [I-D.ietf-eai-dsn].  Key words used
   in these document are used in this document, too.

   The term "non-ASCII" is an UTF-8 string which contains at least one
   non-ASCII character.

   An "UTF8SMTP envelope" has Email originator/recipient addresses
   expanded by [I-D.ietf-eai-smtpext] and [I-D.ietf-eai-dsn].

   An "UTF8SMTP message" is Email messages expanded by
   [I-D.ietf-eai-utf8headers].







Fujiwara & YONEYA       Expires January 15, 2009                [Page 4]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


3.  New header fields definition

   New header fields starting with "Downgraded-" are defined here to
   preserve those original envelope and header values which contain
   UTF-8 characters.  During downgrading, one new "Downgraded-" header
   field is added for each original envelope or header field which
   cannot be passed as-is to a server which does not support UTF8SMTP.
   The original envelope or header field is removed or rewritten.  Only
   those envelope and header fields which contain non-ASCII characters
   are affected.  The result of this process is a message which is
   compliant with existing email specifications [RFC2821] and [RFC2822].
   The original internationalized information can be retrieved by
   examining the "Downgraded-" header fields which were added.  Even
   though the information is not lost, the original message cannot be
   perfectly reconstructed.  Hence, downgrading is a one-way process.
   However, an internationalized client might use the information in the
   "Downgraded-" header fields when processing a downgraded message, for
   example, such as displaying or composing a reply.

3.1.  Envelope information preservation headers

   Two headers "Downgraded-Mail-From:" and "Downgraded-Rcpt-To:" are
   defined to preserve SMTP envelope downgraded information.  SMTP
   envelope downgraded information consists of the original non-ASCII
   address and the downgraded all-ASCII address.  The header field
   syntax is specified as follows:

fields      =/ downgradedmailfrom / downgradedrcptto
downgradedmailfrom = "Downgraded-Mail-From:" [FWS] "<" uPath ">" 1*[FWS]
                                     "<" Mailbox ">" [FWS] CRLF
downgradedrcptto = "Downgraded-Rcpt-To:" [FWS] "<" uPath ">" 1*[FWS]
                                     "<" Mailbox ">" [FWS] CRLF

   Original non-ASCII address <uPath> is defined in
   [I-D.ietf-eai-smtpext]; it is treated as unstructured in this header
   and it is encoded according to [RFC2047]. <Mailbox> is defined in
   [RFC2821], section 4.1.2.

3.2.  Address header field preservation headers

   The address header fields preservation headers are defined to
   preserve the original header field.  Their value field holds the
   original header field value.  Any original header field value is
   treated as an <unstructured> and it MUST be encoded according to
   [RFC2047] with charset='UTF-8'.  The header field syntax is specified
   as follows:





Fujiwara & YONEYA       Expires January 15, 2009                [Page 5]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   fields     =/ known-downgraded-headers ":" unstructued CRLF
   known-downgraded-headers =  "Downgraded-" original-headers
   original-headers = "From" / "To" / "Cc" / "Bcc" /
                      "Sender" / "Reply-To" /
                      "Resent-From" / "Resent-Sender" /
                      "Resent-To" / "Resent-Cc" / "Return-Path"


   Preserving a header field in a downgraded header field is defined as:
   1.  Generate new downgraded header field whose value is the original
       header field value.
   2.  Encode the generated header according to [RFC2047] with
       charset='UTF-8'.

3.3.  Unknown header fields preservation headers

   The unknown header fields preservation headers are defined to
   encapsulate those original header field which contains non-ASCII
   characters and are not otherwise provided for in the this
   specification.  The encapsulation header field name is the
   concatenation of "Downgraded-" and the original name.  The value
   field holds the original header field value.

   Any original header field value is treated as an unstructured value
   and it MUST be encoded according to [RFC2047] with charset='UTF-8'.
   The header field syntax is specified as follows:


  fields     =/ unknown-downgraded-headers ":" unstructued CRLF
  unknown-downgraded-headers =  "Downgraded-" original-header-field-name
  original-header-field-name = field-name

  field-name      =       1*ftext

  ftext           =       %d33-57 /               ; Any character except
                          %d59-126                ;  controls, SP, and
                                                  ;  ":".


   Encapsulating a header field in a "Downgraded-" header field is
   defined as:
   1.  Generate new "Downgraded-" header whose value is the original
       header field value.
   2.  Encode the generated header field value according to [RFC2047]
       with charset='UTF-8'.  To preserve space characters, the whole
       header field value which include space characters SHOULD be
       encoded.




Fujiwara & YONEYA       Expires January 15, 2009                [Page 6]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   3.  Remove the original header field.


4.  SMTP Downgrading

   Target of downgrading elements in SMTP envelope are below:

   o  <reverse-path> of MAIL FROM command
   o  <forward-path> of RCPT TO command
   o  ORCPT parameter of RCPT TO command

4.1.  Path element downgrading

   Downgrading the <path> of MAIL FROM and RCPT TO commands uses ALT-
   ADDRESS parameter defined in [I-D.ietf-eai-smtpext].  A SMTP command
   is downgradable if the <path> contains non-ASCII address and the
   command has an ALT-ADDRESS parameter which specifies an ASCII
   address.  Since only non-ASCII addresses are downgradable, specifying
   an ALT-ADDRESS value for an all-ASCII address is invalid for use with
   this specification, and no interpretation is assigned to it.  This
   restriction allows for future extension of the specification even
   though no such extensions are currently anticipated.

   Note that even if no downgrading is performed on the envelope,
   message header fields and message body MIME header fields that
   contain non-ASCII characters MUST be downgraded.  This is described
   in Section 5 and Section 6.

   When downgrading, replace each <path> which contains non-ASCII mail
   address with its specified alternative ASCII address and preserve the
   original information using "Downgraded-Mail-From" and "Downgraded-
   Rcpt-To" header fields as defined in Section 3.  Before replacing,
   decode the ALT-ADDRESS parameter value because it is encoded as xtext
   [RFC3461].

   To avoid disclosing recipient addresses, the downgrading process MUST
   NOT add "Downgraded-Rcpt-To:" header if the SMTP downgrading targets
   multiple recipients.  See Section 7 for more detail.

   As a result of the recipient address downgrading, the domain part of
   the recipient address prior to downgrading might be different from
   the domain part of the new recipient address.  If the result of
   address resolution for the domain part of the new recipient address
   contains the server at the connection destination of the SMTP session
   for the recipient address prior to downgrading, the SMTP connection
   is valid for the new recipient address.  Otherwise, the downgrading
   process MUST NOT send the downgraded message to the new recipient
   address via the connection and MUST try to send the downgraded



Fujiwara & YONEYA       Expires January 15, 2009                [Page 7]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   message to the new recipient address.

4.2.  ORCPT downgrading

   The "RCPT TO" command can have an ORCPT parameter if the DSN
   extension [RFC3461] is supported.  If the ORCPT parameter contains an
   "utf-8" address and the address contains non-ASCII characters, the
   ORCPT parameter MUST be converted to utf-8-addr-xtext form or utf-8-
   addr-unitext form which are described in [I-D.ietf-eai-dsn].


5.  Email header fields downgrading

   This section defines the conversion method to ASCII for each header
   field which may contain non-ASCII characters.

   [I-D.ietf-eai-utf8headers] expands Received: header fields, [RFC2822]
   ABNF elements <mailbox>, <word>, <comment>, <unstructured>, [RFC2045]
   ABNF element <value>.

   Header field downgrading is defined below for each ABNF element.
   Downgrading an unknown header field is also defined as ENCAPSULATION
   downgrading.  Converting the header field terminates when no non-
   ASCII characters remain in the header field.

   RECEIVED downgrading:   If the header field name is "Received:" and
      the FOR clause contains a non-ASCII addresses, remove the FOR
      clause from the header field.  The other part does not contain
      non-ASCII values.

   UNSTRUCTURED downgrading:   If the header field has an <unstructured>
      field which contains non-ASCII characters, encode the field
      according to [RFC2047] with charset='UTF-8'.  To preserve space
      characters, the whole header field value which include space
      characters SHOULD be encoded.

   WORD downgrading:   If the header field has any <word> fields which
      contains non-ASCII characters, encode the fields according to
      [RFC2047] with charset='UTF-8'.

   COMMENT downgrading:   If the header field has any <comment> fields
      which contains non-ASCII characters, encode the fields according
      to [RFC2047] with charset='UTF-8'.








Fujiwara & YONEYA       Expires January 15, 2009                [Page 8]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   MIME-VALUE downgrading:   If the header field has any <value>
      elements defined by [RFC2045] and the elements contain non-ASCII
      characters, encode the <value> elements by [RFC2231] with
      charset='UTF-8' and the Language information empty.  If the
      <value> element is <quoted-string> and it contains <CFWS> outside
      the DQUOTE, remove the <CFWS> before this conversion.

   DISPLAY-NAME downgrading:   If the header field has any <mailbox>
      elements and they have <display-name> elements which contain non-
      ASCII characters, encode the <display-name> elements according to
      [RFC2047] with charset='UTF-8'.

   MAILBOX downgrading:   The <mailbox> elements have no equivalent
      format for non-ASCII addresses.  If the header field has any
      <mailbox> elements which contain non-ASCII characters, preserve
      the header field in each Address header field preservation header
      defined in Section 3.2, and rewrite each <mailbox> element to
      ASCII only format.  The <mailbox> element which contains non-ASCII
      characters is one of three formats.

      *  [ Display-name ] "<" Utf8-addr-spec 1*FCS "<" Addr-spec ">>"

         Rewrite it as

         [ Display-name ] "<" Addr-spec ">"

      *  [ Display-name ] "<" Utf8-addr-spec ">"
      *  Utf8-addr-spec

         Rewrite both as
         [ Display-name ] "Internationalized Address " Encoded-word
         " Removed:;"

         where the <Encoded-word> is the original <Utf8-addr-spec>
         encoded according to [RFC2047].

   ENCAPSULATION downgrading:   if the header field contains non-ASCII
      characters and for which no rule is given above, encapsulate it in
      a Downgraded header field described in Section 3.3 as a last
      resort.


5.1.  Downgrading method for each header field

   Header fields are listed in [RFC4021].  This section describes the
   downgrading method for each header field.

   If the whole mail header field does not contain non-ASCII characters,



Fujiwara & YONEYA       Expires January 15, 2009                [Page 9]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   email header field downgrading is not required.  Each header field's
   downgrading method is described below.

   o  Address header fields which contain <mailbox>s

      From:
      Sender:
      Reply-To:
      To:
      Cc:
      Bcc:
      Resent-From:
      Resent-Sender:
      Resent-To:
      Resent-Cc:
      Return-Path:

      If the header field contains <mailbox> elements which contains
      non-ASCII addresses, preserve the header field in a downgraded
      header before the conversion.  Then perform COMMENT downgrading,
      DISPLAY-NAME downgrading and MAILBOX downgrading.

   o  Downgrading Non-ASCII in comments

      Date:
      Message-ID:
      In-Reply-To:
      References:
      Resent-Date:
      Resent-Message-ID:
      MIME-Version:
      Content-ID:

      These header fields do not contain non-ASCII characters except in
      comments.  If the header contains UTF-8 characters in comments,
      perform COMMENT downgrading.

   o  Trace header fields

      Received:

      perform COMMENT downgrading and perform RECEIVED downgrading.

   o  MIME Content header fields







Fujiwara & YONEYA       Expires January 15, 2009               [Page 10]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


      Content-Type:
      Content-Disposition:

      Perform MIME-VALUE downgrading.

   o  Non-ASCII in <unstructured>

      Subject:
      Comments:
      Content-Description:

      Perform UNSTRUCTURED downgrading.

   o  Non-ASCII in <unstructured> or <phrase>

      Keywords:

      Perform WORD downgrading.

   o  Other header fields

      All other header fields which contains non-ASCII characters are
      user-defined, missing from this draft or future defined header
      fields.  Perform ENCAPSULATION downgrading as a last resort.



6.  MIME body part headers downgrading

   MIME body part header fields may contain non-ASCII characters
   [I-D.ietf-eai-utf8headers].  This section defines the conversion
   method to ASCII only header fields for each MIME header field which
   contains non-ASCII characters.  Parse the message body's MIME
   structure for all levels and check each MIME header field whether it
   contains non-ASCII characters.  If the header field contains non-
   ASCII characters in the header value, the header is a target of the
   MIME body part headers downgrading.  Each MIME header field's
   downgrading method is described below.  COMMENT downgrading, MIME-
   VALUE downgrading, UNSTRUCTURED downgrading are described in
   Section 5.

   Content-ID:
      The Content-ID: header does not contain non-ASCII characters
      except in comments.  If the header contains UTF-8 characters in
      comments, perform COMMENT downgrading.






Fujiwara & YONEYA       Expires January 15, 2009               [Page 11]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   Content-Type:
   Content-Disposition:
      Perform MIME-VALUE downgrading.

   Content-Description:
      Perform UNSTRUCTURED downgrading.



7.  Security considerations

   o  A Downgraded message's header fields contain ASCII characters
      only.  But they still contain MIME encapsulated header fields
      which contains non-ASCII UTF-8 characters.  Furthermore, the body
      part may contain UTF-8 characters.  Implementations parsing
      Internet messages need to accept UTF-8 body parts and UTF-8 header
      fields which are MIME encoded.
   o  Rewriting headers increases the opportunities for undetected
      spoofing.

   o  Addresses that do not appear in the message headers may appear in
      the RCPT commands to an SMTP server for a number of reasons.
      Copying information from the Envelope into headers risks
      inadvertent information disclosure (see [RFC2821] and Section 4).

   o  The techniques described here invalidates methods that depend on
      digital signatures over the envelope or any part of the message
      which includes the top-level header or body part headers.
      Depending on the specific message being downgraded, DKIM
      especially, but also possibly S/MIME, PGP, and similar techniques
      are all likely to break.

   o  Many gateways and servers on the Internet will discard headers
      with which they are not familiar.  To the extent to which the
      downgrade procedures depend on new headers (e.g., "Downgraded-")
      to avoid information loss, the risk of having those headers
      dropped and its implications must be identified.  In particular,
      if the Downgraded headers are dropped, there is no possibility of
      reconstructing the original information at any point (before,
      during, or after delivery).


   See "Security considerations" section in [RFC4952] for more
   discussion.







Fujiwara & YONEYA       Expires January 15, 2009               [Page 12]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


8.  Implementation notes

8.1.  Trivial downgrading

   Downgrading is an alternative to avoid the rejection of messages
   which require UTF8SMTP support by a server which does not provide
   this.  Implementing the full specification of this document is
   desirable, but a partial implementation is also possible.

   If a partial downgrading implementation confronts an unsupported
   downgrading target, the implementation MUST NOT send the message to a
   server which does not support UTF8SMTP.  Instead, it MUST reject the
   message or generate a notification of non-deliverability.

   A partial downgrading, Trivial downgrading is discussed.  It does not
   support non-ASCII addresses in SMTP envelope and address header
   fields, unknown header fields downgrading, the MIME body part headers
   downgrading.  It supports
   o  some simple header fields downgrading: Subject
   o  comments and display name downgrading: From, To, Cc
   o  trace header field downgrading: Received

   Otherwise, the downgrading fails.

   Trivial downgrading targets mail messages which are generated by
   UTF8SMTP aware MUAs and contain non-ASCII characters in comments,
   display names, unstructured parts without using non-ASCII E-mail
   addresses.  This mail message does not contain non-ASCII E-mail
   addresses in the SMTP Envelope and its header fields.  But it is not
   deliverable via a UTF8SMTP un-aware SMTP server.  Implementing full
   specification downgrading may be hard, but trivial downgrading saves
   mail messages without using non-ASCII addresses.

8.2.  7bit transport consideration

   The SMTP client may encounter a SMTP server which does not support
   the 8BITMIME SMTP extension [RFC1652].  The server does not support
   "8bit" or "binary" data.  Implementers need to consider converting
   "8bit" data to "base64" or "quoted-printable" encoded form and adjust
   the "Content-Transfer-Encoding" header field accordingly.  If the
   body contains multiple MIME parts, this conversion must be performed
   for each MIME part according to [RFC2045].


9.  IANA Considerations

   IANA is requested to register the following header fields in the
   Permanent Message Header Field Repository, in accordance with the



Fujiwara & YONEYA       Expires January 15, 2009               [Page 13]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   procedures set out in [RFC3864].

   Header field name:  Downgraded-Mail-From
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-Rcpt-To
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-From
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-Sender
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-To
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-Cc
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-Reply-To
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)








Fujiwara & YONEYA       Expires January 15, 2009               [Page 14]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   Header field name:  Downgraded-Bcc
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-Resent-From
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-Resent-To
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-Resent-Cc
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-Resent-Sender
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)

   Header field name:  Downgraded-Return-Path
   Applicable protocol:  mail
   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)


   Furthermore, IANA is requested to reserve all the field names that
   start with "Downgraded-" for unknown header fields downgrading
   described in Section 3.3, in accordance with the procedures set out
   in [RFC3864].

   Header field name:  Names which starts by "Downgraded-"
   Applicable protocol:  mail







Fujiwara & YONEYA       Expires January 15, 2009               [Page 15]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   Status:  experimental
   Author/change controller:  IETF
   Specification document(s):  This document (Section 3)


10.  Acknowledgements

   Significant comments and suggestions were received from John Klensin,
   Harald Alvestrand, Chris Newman, Randall Gellens, Charles Lindsey,
   Marcos Sanz, Alexey Melnikov, Frank Ellermann, Edward Lewis, S.
   Moonesamy and JET members.


11.  Change History

   This section is used for tracking the update of this document.  Will
   be removed after finalize.

11.1.  draft-yoneya-ima-downgrade: Version 00

   o  Initial version
   o  Followed draft-yeh-ima-utf8headers-00 and draft-yao-smtpext-00

11.2.  draft-yoneya-ima-downgrade: Version 01

   o  Document structure was changed
   o  Followed draft-yeh-ima-utf8headers-01 and draft-yao-smtpext-02
   o  Downgrading requirements were added
   o  SMTP DATA encapsulation method was proposed
   o  Downgrading examples was provided

11.3.  draft-ietf-eai-downgrade: Version 00

   o  Followed draft-yeh-ima-utf8headers-01 and
      draft-ietf-eai-smtpext-00
   o  No header downgrading method was proposed
   o  Header encapsulation method was proposed

11.4.  draft-ietf-eai-downgrade: Version 01

   o  Followed draft-ietf-eai-utf8headers-00
   o  Header conversion and encapsulation method was merged
   o  Header conversion method was defined in detail

11.5.  draft-ietf-eai-downgrade: Version 02






Fujiwara & YONEYA       Expires January 15, 2009               [Page 16]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   o  Followed draft-ietf-eai-utf8headers-01 and
      draft-ietf-eai-smtpext-01
   o  Specification about algorithmic generated address is removed
   o  No header downgrading method was removed
   o  SMTP DATA encapsulation method was removed

11.6.  draft-ietf-eai-downgrade: Version 03

   o  Followed draft-ietf-eai-utf8headers-03 and
      draft-ietf-eai-smtpext-03
   o  Downgraded: and Envelope-Downgraded: headers definition was added
   o  Mail header fields downgrading method was refined
   o  Examples in Appendix A were refined

11.7.  draft-ietf-eai-downgrade: Version 04

   o  Followed draft-ietf-eai-utf8headers-06, draft-ietf-eai-smtpext-07
      and draft-ietf-eai-dsn-02
   o  Downgrading requirements and conditions were moved to
      Introduction.
   o  Descriptions about upgrading were removed.
   o  SPF and DKIM discussion were removed.
   o  Added many header fields downgrading.
   o  Allow address literal rewriting without alternate ASCII address in
      header fields.
   o  Added MIME body part headers downgrading.
   o  Added ORCPT downgrading.

11.8.  draft-ietf-eai-downgrade: Version 05

   o  fixed examples
      *  ALT-ADDRESS parameter mistake
      *  RFC2047(x) notation was changed to encoded-word format
   o  Added implementation consideration section and trivial downgrading
   o  Downgraded: and Envelope-Downgraded: headers are separated for
      each original headers.
   o  Removed list-* header fields downgrading
   o  Changed the way of writing the header field downgrading section

11.9.  draft-ietf-eai-downgrade: Version 06

   o  Moved decoding downgraded messages as a separate document
   o  Added a text to UNSTRUCTURED downgrading
   o  Added "replacing SMTP connection" if necessary to SMTP
      downgrading.
   o  fixed examples





Fujiwara & YONEYA       Expires January 15, 2009               [Page 17]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


11.10.  draft-ietf-eai-downgrade: Version 07

   o  Fixed some typos
   o  Added a text about 7bit transport

11.11.  draft-ietf-eai-downgrade: Version 08

   o  Comments from the working group last call (wording)


12.  Normative References

   [I-D.ietf-eai-dsn]
              Newman, C. and A. Melnikov, "Internationalized Delivery
              Status and Disposition Notifications",
              draft-ietf-eai-dsn-06 (work in progress), January 2008.

   [I-D.ietf-eai-smtpext]
              Yao, J. and W. MAO, "SMTP extension for internationalized
              email address", draft-ietf-eai-smtpext-13 (work in
              progress), July 2008.

   [I-D.ietf-eai-utf8headers]
              Yang, A., "Internationalized Email Headers",
              draft-ietf-eai-utf8headers-12 (work in progress),
              July 2008.

   [RFC1652]  Klensin, J., Freed, N., Rose, M., Stefferud, E., and D.
              Crocker, "SMTP Service Extension for 8bit-MIMEtransport",
              RFC 1652, July 1994.

   [RFC2045]  Freed, N. and N. Borenstein, "Multipurpose Internet Mail
              Extensions (MIME) Part One: Format of Internet Message
              Bodies", RFC 2045, November 1996.

   [RFC2047]  Moore, K., "MIME (Multipurpose Internet Mail Extensions)
              Part Three: Message Header Extensions for Non-ASCII Text",
              RFC 2047, November 1996.

   [RFC2119]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", BCP 14, RFC 2119, March 1997.

   [RFC2183]  Troost, R., Dorner, S., and K. Moore, "Communicating
              Presentation Information in Internet Messages: The
              Content-Disposition Header Field", RFC 2183, August 1997.

   [RFC2231]  Freed, N. and K. Moore, "MIME Parameter Value and Encoded
              Word Extensions:



Fujiwara & YONEYA       Expires January 15, 2009               [Page 18]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


              Character Sets, Languages, and Continuations", RFC 2231,
              November 1997.

   [RFC2821]  Klensin, J., "Simple Mail Transfer Protocol", RFC 2821,
              April 2001.

   [RFC2822]  Resnick, P., "Internet Message Format", RFC 2822,
              April 2001.

   [RFC3461]  Moore, K., "Simple Mail Transfer Protocol (SMTP) Service
              Extension for Delivery Status Notifications (DSNs)",
              RFC 3461, January 2003.

   [RFC3864]  Klyne, G., Nottingham, M., and J. Mogul, "Registration
              Procedures for Message Header Fields", BCP 90, RFC 3864,
              September 2004.

   [RFC4021]  Klyne, G. and J. Palme, "Registration of Mail and MIME
              Header Fields", RFC 4021, March 2005.

   [RFC4952]  Klensin, J. and Y. Ko, "Overview and Framework for
              Internationalized Email", RFC 4952, July 2007.


Appendix A.  Examples

A.1.  Downgrading example 1

   This section shows an SMTP Downgrading example.  Consider a mail
   message where:
   o  The sender address is "NON-ASCII-local@example.com" which is a
      non-ASCII address.  Its ASCII alternative is
      "ASCII-local@example.com" and its display-name is "DISPLAY-local".
   o  The "To:" address is "NON-ASCII-remote1@example.net" which is a
      non-ASCII address.  Its ASCII alternative is
      "ASCII-remote1@example.net" and its display-name is "DISPLAY-
      remote1".
   o  The "Cc:" address is a non-ASCII address
      "NON-ASCII-remote2@example.org" without alternative ASCII address.
      Its display-name is "DISPLAY-remote2".
   o  Three display-names contain non-ASCII characters.
   o  The Subject header is "NON-ASCII-SUBJECT" which contains non-ASCII
      characters.
   o  Assuming the "To:" recipient's MTA (example.net) does not support
      UTF8SMTP.
   o  assuming the "Cc:" recipient's MTA (example.org) supports
      UTF8SMTP.
   The example SMTP envelope/message is shown in Figure 1.  In this



Fujiwara & YONEYA       Expires January 15, 2009               [Page 19]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   example, the "To:" recipient's session is the focus.



   MAIL FROM: <NON-ASCII-local@example.com>
               ALT-ADDRESS=ASCII-local@example.com
   RCPT TO: <NON-ASCII-remote1@example.net>
             ALT-ADDRESS=ASCII-remote1@example.net
   RCPT TO: <NON-ASCII-remote2@example.org>
   -------------------------------------------------------------
   Message-Id: MESSAGE_ID
   Mime-Version: 1.0
   Content-Type: text/plain; charset="UTF-8"
   Content-Transfer-Encoding: 8bit
   Subject: NON-ASCII-SUBJECT
   From: DISPLAY-local <NON-ASCII-local@example.com
    <ASCII-local@example.com>>
   To: DISPLAY-remote1 <NON-ASCII-remote1@example.net
    <ASCII-remote1@example.net>>
   Cc: DISPLAY-remote2 <NON-ASCII-remote2@example.org>
   Date: DATE

   MAIL_BODY


              Figure 1: Original envelope/message (example 1)

   In this example, there are two SMTP recipients, one is "To:", the
   other is "Cc:".  The SMTP downgrading treats To: session downgrading.
   Figure 2 shows SMTP downgraded example.





















Fujiwara & YONEYA       Expires January 15, 2009               [Page 20]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   MAIL FROM: <ASCII-local@example.com>
   RCPT TO: <ASCII-remote1@example.net>
   -------------------------------------------------------------
   Downgraded-Mail-From: =?UTF-8?Q?<NON-ASCII-local@example.com>_?=
    =?UTF-8?Q?<ASCII-local@example.com>?=
   Downgraded-Rcpt-To: =?UTF-8?Q?<NON-ASCII-remote1@example.net>_?=
    =?UTF-8?Q?<ASCII-remote1@example.net>?=
   Message-Id: MESSAGE_ID
   Mime-Version: 1.0
   Content-Type: text/plain; charset="UTF-8"
   Content-Transfer-Encoding: 8bit
   Subject: NON-ASCII-SUBJECT
   From: DISPLAY-local <NON-ASCII-local@example.com
    <ASCII-local@example.com>>
   To: DISPLAY-remote1 <NON-ASCII-remote1@example.net
    <ASCII-remote1@example.net>>
   Cc: DISPLAY-remote2 <NON-ASCII-remote2@example.org>
   Date: DATE

   MAIL_BODY


          Figure 2: SMTP Downgraded envelope/message (example 1)

   After SMTP downgrading, header fields downgrading is performed.
   Final downgraded message is shown in Figure 3.  Return-Path header
   will be added by the final destination MTA.
























Fujiwara & YONEYA       Expires January 15, 2009               [Page 21]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


Return-Path: <ASCII-local@example.com>
Downgraded-Mail-From: =?UTF-8?Q?<NON-ASCII-local@example.com>_?=
 =?UTF-8?Q?<ASCII-local@example.com>?=
Downgraded-Rcpt-To: =?UTF-8?Q?<NON-ASCII-remote1@example.net>_?=
 =?UTF-8?Q?<ASCII-remote1@example.net>?=
Message-Id: MESSAGE_ID
Mime-Version: 1.0
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 8bit
Subject: =?UTF-8?Q?NON-ASCII-SUBJECT?=
From: =?UTF-8?Q?DISPLAY-local?= <ASCII-local@example.com>
Downgraded-From: =?UTF-8?Q?DISPLAY-local_<NON-ASCII-local@example.com_?=
 =?UTF-8?Q?<ASCII-local@example.com>>?=
To: =?UTF-8?Q?DISPLAY-remote1?= <ASCII-remote1@example.net>
Downgraded-To: =?UTF-8?Q?DISPLAY-remote1_?=
 =?UTF-8?Q?<NON-ASCII-remote1@example.net_<ASCII-remote1@example.net>>?=
Cc: =?UTF-8?Q?DISPLAY-remote2?= Internationalized address
 =?UTF-8?Q?NON-ASCII-remote2@example.org?= removed:;
Downgraded-Cc: =?UTF-8?Q?DISPLAY-remote2_?=
 =?UTF-8?Q?<NON-ASCII-remote2@example.org>?=
Date: DATE

MAIL_BODY


                 Figure 3: Downgraded message (example 1)

A.2.  Downgrading example 2

   In many cases, the sender wants to use non-ASCII address and the
   recipient is a traditional mail user.  The SMTP server handing mail
   for the recipient and/or the recipient's MUA does not support
   UTF8SMTP extension.  Consider a mail message where:
   o  The sender address is "NON-ASCII-local@example.com" which is a
      non-ASCII address.  Its ASCII alternative is
      "ASCII-local@example.com".  It has a display-name "DISPLAY-local"
      which contains non-ASCII characters.
   o  The "To:" address is "ASCII-remote1@example.net" which is ASCII
      only.  It has a display-name "DISPLAY-remote1" which contains non-
      ASCII characters.
   o  The "Subject:" header is "NON-ASCII-SUBJECT" which contains non-
      ASCII characters.
   The second example envelope/message is shown in Figure 4.








Fujiwara & YONEYA       Expires January 15, 2009               [Page 22]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


   MAIL From: <NON-ASCII-local@example.com>
               ALT-ADDRESS=ASCII-local@example.com
   RCPT TO: <ASCII-remote1@example.net>
   -------------------------------------------------------------
   Message-Id: MESSAGE_ID
   Mime-Version: 1.0
   Content-Type: text/plain; charset="UTF-8"
   Content-Transfer-Encoding: 8bit
   Subject: NON-ASCII-SUBJECT
   From: DISPLAY-local <NON-ASCII-local@example.com
    <ASCII-local@example.com>>
   To: DISPLAY-remote1 <ASCII-remote1@example.net>
   Date: DATE

   MAIL_BODY


                  Figure 4: Original message (example 2)

   In this example, SMTP session is downgradable.  Figure 5 shows SMTP
   downgraded envelope/message.



   MAIL From: <ASCII-local@example.com>
   RCPT TO: <ASCII-remote1@example.net>
   -------------------------------------------------------------
   Downgraded-Mail-From: =?UTF-8?Q?<NON-ASCII-local@example.com>_?=
    ?=UTF8?Q?<ASCII-local@example.com>?=
   Message-Id: MESSAGE_ID
   Mime-Version: 1.0
   Content-Type: text/plain; charset="UTF-8"
   Content-Transfer-Encoding: 8bit
   Subject: NON-ASCII-SUBJECT
   From: DISPLAY-local <NON-ASCII-local@example.com
    <ASCII-local@example.com>>
   To: DISPLAY-remote1 <ASCII-remote1@example.net>
   Date: DATE

   MAIL_BODY


          Figure 5: SMTP Downgraded envelope/message (example 2)

   After SMTP downgrading, header fields downgrading is performed.  The
   downgraded example is shown in Figure 6.





Fujiwara & YONEYA       Expires January 15, 2009               [Page 23]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


Return-Path: <ASCII-local@example.com>
Downgraded-Mail-From: =?UTF-8?Q?<NON-ASCII-local@example.com>_?=
 =?UTF8?Q?<ASCII-local@example.com>?=
Message-Id: MESSAGE_ID
Mime-Version: 1.0
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 8bit
Subject: =?UTF-8?Q?NON-ASCII-SUBJECT?=
Downgraded-From: =?UTF-8?Q?DISPLAY-local_<NON-ASCII-local@example.com_?=
 =?UTF-8?Q?<ASCII-local@example.com>>?=
From: =?UTF-8?Q?DISPLAY-local?= <ASCII-local@example.com>
To: =?UTF-8?Q?DISPLAY-remote1?= <ASCII-remote1@example.net>
Date: DATE

MAIL_BODY


                 Figure 6: Downgraded message (example 2)


Authors' Addresses

   Kazunori Fujiwara (editor)
   JPRS
   Chiyoda First Bldg. East 13F, 3-8-1 Nishi-Kanda
   Chiyoda-ku, Tokyo  101-0065
   Japan

   Phone: +81 3 5215 8451
   Email: fujiwara@jprs.co.jp


   Yoshiro YONEYA (editor)
   JPRS
   Chiyoda First Bldg. East 13F, 3-8-1 Nishi-Kanda
   Chiyoda-ku, Tokyo  101-0065
   Japan

   Phone: +81 3 5215 8451
   Email: yone@jprs.co.jp











Fujiwara & YONEYA       Expires January 15, 2009               [Page 24]

Internet-Draft             UTF8SMTP Downgrade                  July 2008


Full Copyright Statement

   Copyright (C) The IETF Trust (2008).

   This document is subject to the rights, licenses and restrictions
   contained in BCP 78, and except as set forth therein, the authors
   retain all their rights.

   This document and the information contained herein are provided on an
   "AS IS" basis and THE CONTRIBUTOR, THE ORGANIZATION HE/SHE REPRESENTS
   OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST AND
   THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES, EXPRESS
   OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF
   THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED
   WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.


Intellectual Property

   The IETF takes no position regarding the validity or scope of any
   Intellectual Property Rights or other rights that might be claimed to
   pertain to the implementation or use of the technology described in
   this document or the extent to which any license under such rights
   might or might not be available; nor does it represent that it has
   made any independent effort to identify any such rights.  Information
   on the procedures with respect to rights in RFC documents can be
   found in BCP 78 and BCP 79.

   Copies of IPR disclosures made to the IETF Secretariat and any
   assurances of licenses to be made available, or the result of an
   attempt made to obtain a general license or permission for the use of
   such proprietary rights by implementers or users of this
   specification can be obtained from the IETF on-line IPR repository at
   http://www.ietf.org/ipr.

   The IETF invites any interested party to bring to its attention any
   copyrights, patents or patent applications, or other proprietary
   rights that may cover technology that may be required to implement
   this standard.  Please address the information to the IETF at
   ietf-ipr@ietf.org.











Fujiwara & YONEYA       Expires January 15, 2009               [Page 25]


<?xml version="1.0"?><!DOCTYPE rfc SYSTEM "rfc2629.dtd"><?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?><?rfc toc="yes"?><?rfc compact="yes"?><?rfc subcompact="no"?><?rfc strict="yes"?><?rfc symrefs="yes"?><?rfc linkmailto="no"?><rfc ipr="full3978" docName="draft-ietf-eai-imap-utf8-02" updates="3501"><front><title>IMAP Support for UTF-8</title><author initials="P." surname="Resnick" fullname="Pete Resnick"> <organization>Qualcomm Incorporated</organization> <address>  <postal>   <street>5775 Morehouse Drive</street>   <city>San Diego</city>   <region>CA</region>   <code>92121-1714</code>   <country>US</country>  </postal>  <phone>+1 858 651 4478</phone>  <email>presnick@qualcomm.com</email>  <uri>http://www.qualcomm.com/~presnick/</uri> </address></author><author initials="C." surname="Newman" fullname="Chris Newman"> <organization>Sun Microsystems</organization> <address>  <postal>   <street>3401 Centrelake Dr., Suite 410</street>   <city>Ontario</city>   <region>CA</region>   <code>91761</code>   <country>US</country>  </postal>  <email>chris.newman@sun.com</email> </address></author><date month="November" year="2007" /><area>Applications</area><keyword>I-D</keyword><keyword>Internet-Draft</keyword><abstract><t>This specification extends the Internet Message Access Protocol version 4rev1 (IMAP4rev1) to support unencoded international characters in user names, mail addresses and message headers.  This is an early draft and intended as a framework for discussion.  Please do not deploy implementations of this draft.</t></abstract></front><middle><section title="Conventions Used in this Document"><t>The key words "MUST", "MUST NOT", "SHOULD", "SHOULD NOT", and "MAY"in this document are to be interpreted as defined in<xref target="RFC2119">"Key words for use in RFCs to IndicateRequirement Levels"</xref>.</t><t>The formal syntax use the <xref target="I-D.crocker-rfc4234bis">AugmentedBackus-Naur Form (ABNF)</xref> notation including the core rulesdefined in Appendix B of RFC 4234.  In addition, rules from <xref target="RFC3501">IMAP4rev1</xref>, <xref target="RFC3629">UTF-8</xref>, <xref target="I-D.ietf-imapext-list-extensions">Collected extensions to IMAP4 ABNF</xref>, and <xref target="I-D.ietf-imapext-list-extensions">IMAP4 LIST Command Extensions</xref> are also referenced.</t><t>In examples, "C:" and "S:" indicate lines sent by the client andserver respectively.  If a single "C:" or "S:" label applies to multiplelines, then the line breaks between those lines are for editorialclarity only and are not part of the actual protocol exchange.</t></section><section title="Introduction"><t>This specification extends <xref target="RFC3501">IMAP4rev1</xref> topermit unencoded <xref target="RFC3629">UTF-8</xref> in headers as described in <xref target="I-D.ietf-eai-utf8headers">Transmission of Email Headers in UTF-8 Encoding</xref>.  It also adds a mechanism to support mailbox names, login names and passwords using the UTF-8 charset.</t></section><section title="Enabling UTF-8"><t>A client may use the ENABLE command (defined in <xref target="I-D.gulbrandsen-imap-enable" />) to inform the server to enable any or all of the UTF-8 extension defined herein. The argument to ENABLE in order to use this extension is the "UTF8" IMAP Capability defined in section <xref target="utf8capa" format="counter" />. The "ENABLE UTF8" command MUST only be used in the not authenticated state. After the client issues the "ENABLE UTF8" command, a subsequent "CAPABILITY" command may return one or more of the capabilities defined in this document.</t></section><section anchor="utf8capa" title="UTF8 IMAP Capability"><t>The basic "UTF8" capability indicates the server supports UTF-8 quoted strings and the UTF8 parameter to SELECT and EXAMINE.</t><section title="IMAP UTF-8 Quoted Strings"><t>The <xref target="RFC3501">IMAP4rev1</xref> base specification forbids the use of 8-bit characters in atoms or quoted strings.  Thus a UTF-8 string can only be sent as a literal.  This can be inconvenient from a coding standpoint, and unless the server offers <xref target="RFC2088">IMAP4 non-synchronizing literals</xref>, this requires an extra round trip for each UTF-8 string sent by the client.  When the IMAP server advertises the "UTF8" capability, it informs the client that it supports native UTF-8 quoted-strings with the following syntax:</t><?rfc needLines="7"?><figure><artwork type="abnf">  string        =/ utf8-quoted  utf8-quoted   = "*" DQUOTE *UQUOTED-CHAR DQUOTE  UQUOTED-CHAR  = QUOTED-CHAR / UTF8-2 / UTF8-3 / UTF8-4             ; UTF8-2, UTF8-3, and UTF8-4 are as defined in RFC 3629</artwork></figure><t>When this quoting mechanism is used by the client (specifically anoctet sequence beginning with *" and ending with "), then the serverMUST reject octet sequences with the high bit set which fail to complywith the formal syntax in <xref target="RFC3629"  /> with aBAD response.</t><t>The IMAP server MUST NOT send utf8-quoted syntax to the client unlessthe client has indicated support for that syntax by using the "ENABLE UTF8" command.</t><t>If the UTF8 capability is advertised, then utf8-quoted syntax MAY be used with any IMAP argument that permits a string or an astring.  However, if characters outside the US-ASCII repertoire are used in an inappropriate place, the results would be the same as if other syntacticly valid but semantically invalid characters were used.  For example, if  the client includes UTF-8 characters in the user or password arguments (and the server has not advertised UTF8-USER), the LOGIN command will fail as it would with any other invalid user name or password.  Specific cases where UTF-8 characters are permitted or not permitted are described in the following paragraphs.</t><t>All IMAP servers SHOULD accept UTF-8 in mailbox names and IMAP servers which support the "Mailbox International Naming Convention" described in RFC 3501 section 5.1.3 MUST accept utf8-quoted mailbox names and convert them to the appropriate internal format.  [TBD stringprep for mailbox names?  Can we reuse SASLprep?].</t><t>IMAP servers MUST NOT accept UTF-8 characters when storing a new message keyword, unless the mailbox is UTF-8 only, in which case IMAP servers SHOULD accept UTF-8 in message keywords.  [TBD stringprep for message keywords?  Can we reuse SASLprep?]</t><t>If an IMAP client issues a SEARCH command which uses a mixture of utf8-quoted syntax and a SEARCH CHARSET other than UTF-8, then the IMAP server SHOULD reject the command with a BAD response (due to the conflicting charset labels).</t></section><section anchor="utf8-parameter" title="UTF8 Parameter to SELECT and EXAMINE"><t>The "UTF8" capability also indicates the server supports the UTF8 parameter to SELECT and EXAMINE.  When a mailbox is selected with the UTF8 parameter, it alters the behavior of all IMAP commands related to message sizes, message headers and MIME body headers so they refer to the message with UTF-8 headers.  If the mailstore is not UTF-8 header native and the SELECT or EXAMINE command with UTF-8 header modifier succeeds, then the server MUST return results as if the mailstore was UTF-8 header native with upconversion requirements as described in <xref target="upconvert" />.  The server MAY reject the SELECT or EXAMINE command with the [NOT-UTF-8] response code, unless the UTF8=ALL or UTF8=ONLY capability is advertised.</t><t>Servers MAY include mailboxes which can only be selected or examined if the UTF8 parameter is provided.  However, such mailboxes MUST NOT be included in the output of an unextended LIST, LSUB or equivalent command.  If a client attempts to SELECT or EXAMINE such mailboxes without the UTF8 parameter, the server MUST reject the command with a [UTF-8-ONLY] response code.  As a result, such mailboxes will not accessible by IMAP clients written prior to this specification and are discouraged unless the server advertises UTF8=ONLY or the server implements <xref target="I-D.ietf-imapext-list-extensions">IMAP4 LIST Command Extensions</xref>.</t><t>TBD: describe syntax based on draft-melnikov-imap-ext-abnf-05.</t><figure><artwork type="example">  C: a SELECT newmailbox (UTF8)  S: ...  S: a OK SELECT completed  C: b FETCH 1 (SIZE ENVELOPE BODY)  S: ... &lt; UTF-8 header native results &gt;  S: b OK FETCH completed    C: c EXAMINE legacymailbox (UTF8)  S: c NO [NOT-UTF-8] Mailbox does not support UTF-8 access    C: d SELECT funky-new-mailbox  S: d NO [UTF-8-ONLY] Mailbox requires UTF-8 client</artwork></figure></section><section anchor="list-response" title="UTF-8 LIST and LSUB Responses"><t>If an IMAP client has used utf8-quoted syntax prior to the server's production of LIST results, then the server MUST NOT return any mailbox names to the client following the IMAP4 Mailbox International Naming Convention.  Instead, the server MUST return any mailbox names with characters outside the US-ASCII repertorie using utf8-quoted syntax.  An IMAP client can force this behavior by issuing the LIST or LSUB command as follows:</t><figure><artwork type="example">  C: a LIST *"" %  S: &lt;responses with UTF-8 mailbox names&gt;  S: a OK LIST completed  C: a LSUB *"*"  S: &lt;responses with UTF-8 mailbox names&gt;  S: a OK LSUB completed</artwork></figure><t>The IMAP4 Mailbox International Naming Convention has proved problematic in the past, so the desire is to make this syntax obsolete as quickly as possible.</t></section><section title="UTF-8 Interaction with IMAP4 LIST Command Extensions"><t>When an IMAP server advertises both the "UTF8" capability and the <xref target="I-D.ietf-imapext-list-extensions">"LIST-EXTENEDED"</xref> capability, the server MUST support the LIST extensions described in this section.  When an IMAP server advertises the UTF8=ONLY capability and the LIST-EXTENDED capability, the server MUST reject these LIST extensions with a BAD response.</t><section anchor="list-select" title="UTF8 and UTF8ONLY LIST Selection Options"><t>The UTF8 LIST selection option tells the server to include mailboxes that only support UTF-8 headers in the output of the list command.  The UTF8ONLY LIST selection option tells the server to include all mailboxes that support UTF-8 headers and to exclude mailboxes that don't support UTF-8 headers.  Note that UTF8ONLY implies UTF8 so it is not necessary for the client to request both.Use of either selection option will also result in UTF-8 mailbox names in the result as described in <xref target="list-response" />.</t></section><section anchor="list-return" title="UTF8 LIST Return Option"><t>If the client supplies the UTF8 LIST return option, then the server MUST include either the \NoUTF8 or the \UTF8Only mailbox attribute as appropriate.  The \NoUTF8 mailbox attribute indicates an attempt to SELECT or EXAMINE that mailbox with the UTF8 parameter will fail with a [NOT-UTF-8] response code.  The \UTF8Only mailbox attribute indicates an attempt to SELECT or EXAMINE that mailbox without the UTF8 parameter will fail with a [UTF-8-ONLY] response code.  Note that computing this information may be expensive on some server implementations so this return option should not be used unless necessary.</t></section><?rfc needLines="7"?><t>The <xref target="I-D.crocker-rfc4234bis">ABNF</xref> for these LIST extensions follows:</t><figure><artwork type="abnf">  list-select-independent-opt =/ "UTF8" / "UTF8ONLY"  mbox-list-oflag             =/ "\NoUTF8" / "\UTF8Only"    return-option               =/ "UTF8"</artwork></figure></section></section><section title="UTF8=APPEND Capability"><t>If the UTF8=APPEND capability is advertised, then the server accepts UTF-8 headers in the APPEND command message argument.  A client which sends a message with UTF-8 headers to the server MUST include the UTF8 APPEND parameter.  The ABNF for this APPEND parameter follows:</t><figure><artwork type="abnf">  append-ext    =/ "UTF8"</artwork></figure><t>A server which advertises UTF8=APPEND has to comply with the requirements of the IMAP base specification and RFC 2822 for message fetching.  Mechanisms for 7-bit downgrading to help comply with the standards are discussed in <xref target="I-D.ietf-eai-downgrade">Downgrading mechanism for Internationalized eMail Address (IMA)</xref>.</t><t>IMAP servers which do not advertise the UTF8=APPEND or UTF8=ONLY capability SHOULD reject an APPEND command which includes any 8-bit in the message headers with a "NO" response.</t></section><section title="UTF8=USER Capability"><t>If the UTF8=USER capability is advertised, that indicates the serveraccepts UTF-8 user names and passwords and applies <xreftarget="RFC4013">SASLprep</xref> to both arguments of the LOGINcommand.  The server MUST reject UTF-8 which fails to comply with the formal syntax in <xref target="RFC3629">RFC 3629</xref>.</t></section><section title="UTF8=ALL Capability"><t>This capability indicates all server mailboxes support UTF-8 headers.  Specifically, SELECT and EXAMINE with the UTF8 parameter will never fail with a [NOT-UTF-8] response token.</t></section><section title="UTF8=ONLY Capability"><t>This capability permits an IMAP server to advertise that it does not support the international mailbox name convention (modified UTF-7), and does not permit selection or examination of any mailbox unless the UTF8 parameter is provided.  As this is an incompatible change to IMAP, a clear warning is necessary.  IMAP clients which find implementation of the UTF8 capability problematic are encouraged to at least detect the UTF8=ONLY capability and provide an informative error message to the end-user.</t><t>When an IMAP mailbox internally uses UTF-8 header native storage, the down-conversion step necessary to permit selection or examination of the mailbox in a backwards compatible fashion will become more difficult to support.  Although it is hoped deployed IMAP servers do not advertise UTF8=ONLY for some years, this capability is intended to minimize the disruption when legacy support finally goes away.</t><t>The UTF8=ONLY capability implies the UTF8 base capability, the UTF8=ALL capability and the UTF8=APPEND capability.  A server which advertises UTF8=ONLY need not advertise the three implicit capabilities.</t></section><section anchor="upconvert" title="Up-Conversion Server Requirements"><t>When an IMAP4 server uses a traditional mailbox format that includes7-bit headers and it chooses to permit access to that mailbox withthe UTF8 parameter, it MUST support minimal up-conversion as described inthis section.  Minimal up-conversion is described in this section.</t><t>The server MUST support up-conversion of the following address header-fields in the message header: From, Sender, To, CC, Bcc, Resent-From, Resent-Sender, Resent-To, Resent-CC, Resent-Bcc, and Reply-To.  This up-conversion MUST include address local-parts encoded according to [TBD], address domains encoded according to <xref target="RFC3490">IDNA</xref>, and <xref target="RFC2047">MIME header encoding</xref> of display-names and any RFC 2822 comments.</t><t>The following charsets MUST be supported for up-conversion of <xref target="RFC2047">MIME header encoding</xref>: UTF-8, US-ASCII, ISO-8859-1, ISO-8859-2, ISO-8859-3, ISO-8859-4, ISO-8859-5, ISO-8859-6, ISO-8859-7, ISO-8859-8, ISO-8859-9, ISO-8859-10, ISO-8859-14, and ISO-8859-15.Other widely deployed MIME charsets SHOULD be supported.</t><t>Up-conversion of MIME header encoding of the following headers MUST also be implemented: Subject, Date (RFC 2822 comments only), Comments, Keywords, Content-Description.</t><t>Server implementations also SHOULD up-convert all MIME body headers, SHOULD up-convert or remove the deprecated (and misused) <xref target="RFC1341">name parameter</xref> on Content-Type and MUST up-convert the Content-Disposition filename parameter.  These parameters can be encoded using the standard <xref target="RFC2231">MIME parameter encoding</xref> mechanism, or via non-standard use of <xref target="RFC2047">MIME header encoding</xref> in quoted strings.</t><t>The IMAP server MUST NOT perform up-conversion of headers and content of multipart/signed, as well as Original-Recipient and Return-Path.</t></section><section title="Issues with UTF-8 Header Mailstore"><t>When an IMAP server uses a mailbox format that supports UTF-8 headersand it permits selection or examination of that mailbox without the UTF8parameter, it is the responsibility of the server to comply with the<xref target="RFC3501">IMAP4rev1</xref> base specification and <xreftarget="I-D.resnick-2822upd">RFC 2822</xref> with respect to all header informationtransmitted over the wire.  Mechanisms for 7-bit downgrading to helpcomply with the standards are discussed in <xreftarget="I-D.ietf-eai-downgrade">Downgrading mechanism forInternationalized eMail Address (IMA)</xref>.</t><t>An IMAP server with a mailbox that supports UTF-8 headers MUSTcomply with the protocol requirements implicit from <xreftarget="upconvert" />.  However, the code necessary for such complianceneed not be part of the IMAP server itself in this case.  For example,the minimal required up-conversion could be performed when a message isinserted into the IMAP-accessible mailbox.</t></section><?rfc needLines="4"?><section title="IANA Considerations"><t>This adds five new capabilities ("UTF8", "UTF8=USER", "UTF8=APPEND", "UTF8=ALL", "UTF8=ONLY") to the <xref target="RFC3501">IMAP4rev1 capability registry</xref>.</t><t>This adds two new IMAP4 list selection options and one new IMAP4 list return option.<list style="numbers"><t>LIST-EXTENDED option name: UTF8<vspace blankLines="1"/>LIST-EXTENDED option type: SELECTION<vspace blankLines="1"/>Implied return options(s): none<vspace blankLines="1"/>LIST-EXTENDED option description: Causes the LIST response to include mailboxes which mandate the UTF8 SELECT/EXAMINE parameter.<vspace blankLines="1"/>Published specification: RFC &rfc.number;, <xref target="list-select" /><vspace blankLines="1"/>Security considerations: RFC &rfc.number;, <xref target="security" /><vspace blankLines="1"/>Intended usage: COMMON<vspace blankLines="1"/>Person an email address to contact for further information:see Authors' Addresses at the end of this specification<vspace blankLines="1"/>Owner/Change controller: iesg@ietf.org</t><t>LIST-EXTENDED option name: UTF8ONLY<vspace blankLines="1"/>LIST-EXTENDED option type: SELECTION<vspace blankLines="1"/>Implied return options(s): none<vspace blankLines="1"/>LIST-EXTENDED option description: Causes the LIST response to include mailboxes which mandate the UTF8 SELECT/EXAMINE parameter and exclude mailboxes which do not support the UTF8 SELECT/EXAMINE parameter.<vspace blankLines="1"/>Published specification: RFC &rfc.number;, <xref target="list-select" /><vspace blankLines="1"/>Security considerations: RFC &rfc.number;, <xref target="security" /><vspace blankLines="1"/>Intended usage: COMMON<vspace blankLines="1"/>Person an email address to contact for further information:see Authors' Addresses at the end of this specification<vspace blankLines="1"/>Owner/Change controller: iesg@ietf.org</t><t>LIST-EXTENDED option name: UTF8<vspace blankLines="1"/>LIST-EXTENDED option type: RETURN<vspace blankLines="1"/>Implied return options(s): none<vspace blankLines="1"/>LIST-EXTENDED option description: Causes the LIST response to include \NoUTF8 and \UTF8Only mailbox attributes.<vspace blankLines="1"/>Published specification: RFC &rfc.number;, <xref target="list-select" /><vspace blankLines="1"/>Security considerations: RFC &rfc.number;, <xref target="security" /><vspace blankLines="1"/>Intended usage: COMMON<vspace blankLines="1"/>Person an email address to contact for further information:see Authors' Addresses at the end of this specification<vspace blankLines="1"/>Owner/Change controller: iesg@ietf.org</t></list></t></section><section anchor="security" title="Security Considerations"><t>The security considerations of <xref target="RFC3629">UTF-8</xref>and <xref target="RFC4013">SASLprep</xref> apply to this specification,particularly with respect to use of UTF-8 in user names and passwords. Otherwise, this is not believed to alter the security considerations ofIMAP4rev1.</t></section></middle><back><references title="Normative References"><?rfc include="reference.RFC.1341"?> <!-- Legacy MIME --><?rfc include="reference.RFC.1847"?> <!-- multipart/signed --><?rfc include="reference.RFC.2045"?> <!-- MIME Bodies --><?rfc include="reference.RFC.2047"?> <!-- MIME Headers --><?rfc include="reference.RFC.2119"?> <!-- Keywords --><?rfc include="reference.RFC.2183"?> <!-- Content-Disposition --><?rfc include="reference.RFC.2231"?> <!-- MIME i18n params --><?rfc include="reference.RFC.3490"?> <!-- IDNA --><?rfc include="reference.RFC.3501"?> <!-- IMAP4 --><?rfc include="reference.RFC.3629"?> <!-- UTF-8 --><?rfc include="reference.RFC.4013"?> <!-- SASLprep --><?rfc include="reference.I-D.crocker-rfc4234bis"?> <!-- ABNF --><?rfc include="reference.I-D.ietf-eai-utf8headers.xml"?><?rfc include="reference.I-D.ietf-imapext-list-extensions.xml"?><?rfc include="reference.I-D.gulbrandsen-imap-enable.xml"?> <!-- IMAP ENABLE --><?rfc include="reference.I-D.resnick-2822upd"?> <!-- Message Format --></references><references title="Informative References"><?rfc include="reference.RFC.2049"?> <!-- MIME Requirements --><?rfc include="reference.RFC.2088"?> <!-- IMAP non-synchronizing literals --><?rfc include="reference.RFC.2277"?> <!-- charset policy --><?rfc include="reference.I-D.newman-ima-pop.xml"?><?rfc include="reference.I-D.ietf-eai-downgrade.xml"?></references><section title="Design Rationale"><t>This non-normative section discusses the reasons behind some of the design choices in the above specification.</t><t>The basic approach of advertising the ability to access a mailbox in UTF-8 mode is intended to permit graceful upgrade, including servers which support multiple mailbox formats.  In particular, it would be undesirable to force conversion of an entire server mailstore to UTF-8 headers, so being able to phase-in support for new mailboxes and gradually migrate old mailboxes is permitted by this design.</t><t>UTF8=USER is optional because many identity systems are US-ASCII only, so it's helpful to inform the client up-front that UTF-8 won't work.</t><t>UTF8=APPEND is optional because it effectively requires IMAP server support for down-conversion which is a much more complex operation than up-conversion.</t><t>The UTF8=ONLY mechanism simplifies diagnosis of interoperability problems when legacy support goes away.  In the situation where backwards compatibility is broken anyway, just-send-UTF-8 IMAP has the advantage that it might work with some legacy clients.  However, the difficulty of diagnosing interoperability problems caused by a just-send-UTF-8 IMAP mechanism is the reason the UTF8=ONLY capability mechanism was chosen.</t><t>The up-conversion requirements are designed to balance the desire to deprecate and eventually eliminate complicated encodings (like MIME header encodings) without creating a significant deployment burden for servers.  AsIMAP4 servers already require a MIME parser, this includes additional server up-conversion requirements not present in <xref target='I-D.newman-ima-pop'>POP3 Support for UTF-8</xref>.</t><t>The set of mandatory charsets comes from two sources: <xref target="RFC2049">MIME requirements</xref> and <xref target="RFC2277">IETF Policy on Character Sets</xref>.  Including a requirement to up-convert widely deployed encoded ideographic charsets to UTF-8 would be reasonable for most scenarios, but may require unacceptable table sizes for some embedded devices.  The open-ended recommendation to support widely deployed charsets avoids the political ramifications of attempting to list such charsets.  The authors believe market forces, existing open-source software, and public conversion tables are sufficient to deploy the appropriate charsets.</t></section><section title="Acknowledgments"><t>TBD.</t></section></back></rfc>
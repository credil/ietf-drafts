


Network Working Group                                      O. Troan, Ed.
Internet-Draft                                                     cisco
Intended status: Standards Track                        October 24, 2011
Expires: April 26, 2012


                   Mapping of Address and Port (MAP)
             draft-mdt-softwire-mapping-address-and-port-00

Abstract

   This document describes a generic mechanism for mapping between an
   IPv4 prefix, address or parts thereof, and transport layer ports and
   an IPv6 prefix or address.

Status of this Memo

   This Internet-Draft is submitted in full conformance with the
   provisions of BCP 78 and BCP 79.

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF).  Note that other groups may also distribute
   working documents as Internet-Drafts.  The list of current Internet-
   Drafts is at http://datatracker.ietf.org/drafts/current/.

   Internet-Drafts are draft documents valid for a maximum of six months
   and may be updated, replaced, or obsoleted by other documents at any
   time.  It is inappropriate to use Internet-Drafts as reference
   material or to cite them other than as "work in progress."

   This Internet-Draft will expire on April 26, 2012.

Copyright Notice

   Copyright (c) 2011 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to BCP 78 and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (http://trustee.ietf.org/license-info) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.





Troan                    Expires April 26, 2012                 [Page 1]

Internet-Draft                     MAP                      October 2011


Table of Contents

   1.  Introduction . . . . . . . . . . . . . . . . . . . . . . . . .  3
   2.  Conventions  . . . . . . . . . . . . . . . . . . . . . . . . .  5
   3.  Terminology  . . . . . . . . . . . . . . . . . . . . . . . . .  5
   4.  Mapping Rules  . . . . . . . . . . . . . . . . . . . . . . . .  6
     4.1.  Port mapping algorithm . . . . . . . . . . . . . . . . . .  6
     4.2.  Basic mapping rule - IPv4 address and port assignment  . .  7
     4.3.  Forwarding mapping rule - from address and port to
           IPv6 address . . . . . . . . . . . . . . . . . . . . . . .  8
     4.4.  Default mapping rule - from address and port to BR . . . .  8
   5.  Use of the IPv6 Interface identifier . . . . . . . . . . . . .  8
   6.  IANA Considerations  . . . . . . . . . . . . . . . . . . . . .  9
   7.  Security Considerations  . . . . . . . . . . . . . . . . . . . 10
   8.  Contributors . . . . . . . . . . . . . . . . . . . . . . . . . 10
   9.  Acknowledgements . . . . . . . . . . . . . . . . . . . . . . . 10
   10. References . . . . . . . . . . . . . . . . . . . . . . . . . . 10
     10.1. Normative References . . . . . . . . . . . . . . . . . . . 10
     10.2. Informative References . . . . . . . . . . . . . . . . . . 10
   Appendix A.  Requirements  . . . . . . . . . . . . . . . . . . . . 13
   Appendix B.  Deployment considerations . . . . . . . . . . . . . . 15
     B.1.  Flexible Assigment of Port Range . . . . . . . . . . . . . 15
     B.2.  Traffic Classification . . . . . . . . . . . . . . . . . . 15
     B.3.  Prefix Delegation Deployment . . . . . . . . . . . . . . . 15
     B.4.  Coexisting Deployment  . . . . . . . . . . . . . . . . . . 15
     B.5.  Friendly to Network Provisioning . . . . . . . . . . . . . 16
     B.6.  Enable privacy addresses . . . . . . . . . . . . . . . . . 16
     B.7.  Facilitating 4v6 Service . . . . . . . . . . . . . . . . . 16
     B.8.  Independency with IPv6 Routing Planning  . . . . . . . . . 16
     B.9.  Optimized Routing Path . . . . . . . . . . . . . . . . . . 17
   Appendix C.  Guidelines for Operators  . . . . . . . . . . . . . . 17
     C.1.  Terms  . . . . . . . . . . . . . . . . . . . . . . . . . . 17
     C.2.  Understanding address formats: their difference and
           relevance  . . . . . . . . . . . . . . . . . . . . . . . . 17
     C.3.  A generic logic of working with MAP  . . . . . . . . . . . 20
   Author's Address . . . . . . . . . . . . . . . . . . . . . . . . . 21















Troan                    Expires April 26, 2012                 [Page 2]

Internet-Draft                     MAP                      October 2011


1.  Introduction

   The mechanism of mapping IPv4 addresses in IPv6 address has been
   described in numerous mechanisms dating back to [RFC1933] from 1996.
   The Automatic tunneling mechanism described in RFC1933, assigned a
   globally unique IPv6 address to a host by combining the hosts IPv4
   address with a well known IPv6 prefix.  Given an IPv6 packet with an
   destination address with an embedded IPv4 address, a node could
   automatically tunnel this packet by extracting the IPv4 tunnel end-
   point address from the IPv6 destination address.

   There are numerous variations of this idea, described in 6over4
   [RFC2529], ISATAP [RFC5214] and 6rd [RFC5969].  The differences are
   the use of well known IPv6 prefixes, or Service Provider assigned
   IPv6 prefixes, and the exact position of the IPv4 bits embedded in
   the IPv6 address.  Teredo [RFC4380] added a twist to this to achieve
   NAT traversal by also encoding transport layer ports into the IPv6
   address. 6rd to achieve more efficient encoding, allowed for only an
   IPv4 address suffix to be embedded, with the IPv4 prefix being
   deducted from other provisioning mechanisms.

   NAT-PT [RFC2766](deprecated) combined with a DNS ALG used address
   mapping to put NAT state, namely the IPv6 to IPv4 binding encoded in
   an IPv6 address.  This characteristic has been inherited by NAT64
   [RFC6146] and DNS64 [RFC6147] which rely on an address format defined
   in [RFC6052].  [RFC6052] specifies the algorithmic translation of an
   IPv6 address to IPv4 address suffix to be embedded, with the deducted
   from other provisioning mechanisms.  DNS ALG used address IPv4
   binding encoded in it a corresponding IPv4 address, and vice versa.
   In particular, [RFC6052] specifies the address format to build IPv4-
   converted and IPv4-translatable IPv6 addresses.  RFC6052 discusses
   the transport of the port range information in an IPv4-embedded IPv6
   address but the conclusion was the following (excerpt from
   [RFC6052]):

   "There have been proposals to complement stateless translation with a
   port-range feature.  Instead of mapping an IPv4 address to exactly
   one IPv6 prefix, the options would allow several IPv6 nodes to share
   an IPv4 address, with each node managing a different range of ports.
   If a port range extension is needed, could be defined later, using
   bits currently reserved as null in the suffix."

   The commonalities of all these mechanisms are:
   o  Provisions an IPv6 address for a host or an IPv6 prefix for a site
   o  Algorithmic or implicit address resolution for tunneling or
      encapsulation.  Given an IPv6 destination address, an IPv4 tunnel
      endpoint address can be calculated.  Likewise for translation, an
      IPv4 address can be calculated from an IPv6 destination address



Troan                    Expires April 26, 2012                 [Page 3]

Internet-Draft                     MAP                      October 2011


      and vice versa.
   o  Embedding of an IPv4 address or part thereof and optionally
      transport layer ports into an IPv6 address.

   In the later phases of IPv4 to IPv6 migration, IPv6 only networks
   will be common, while there will still be a need for residual IPv4
   deployment.  This document describes a more generic mapping of IPv4
   to IPv6 that can be used both for encapsulation (IPv4 over IPv6) and
   for translation between the two protocols.

   Just as the IPv6 over IPv4 mechanisms refereed to above, the residual
   IPv4 over IPv6 mechanisms must be capable of:

   o  Provisioning an IPv4 prefix, an IPv4 address or a shared IPv4
      address.
   o  Algorithmically map between an IPv4 prefix, IPv4 address or a
      shared IPv4 address and an IPv6 address.

   This document describes delivery of IPv4 unicast service across an
   IPv6 infrastructure.  IPv4 multicast is not considered further in
   this document.

   The unified mapping scheme described here supports translation mode,
   encapsulation mode, in both mesh and hub and spoke topologies.

   Other work that has motivated the work on a unified mapping mechanism
   for translation and encapsulation are:
   [I-D.sun-softwire-stateless-4over6]
   [I-D.murakami-softwire-4v6-translation]
   [I-D.despres-softwire-4rd-addmapping]
   [I-D.chen-softwire-4v6-add-format] [I-D.bcx-address-fmt-extension]
   [I-D.mrugalski-dhc-dhcpv6-4rd]
   [I-D.boucadair-dhcpv6-shared-address-option]
   [I-D.despres-softwire-sam] [I-D.chen-softwire-4v6-pd]
   [I-D.boucadair-softwire-stateless-requirements]
   [I-D.dec-stateless-4v6] [I-D.boucadair-behave-ipv6-portrange]
   [I-D.bsd-softwire-stateless-port-index-analysis]
   [I-D.despres-softwire-stateless-analysis-tool]
   [I-D.mrugalski-dhc-dhcpv6-4rd] [I-D.xli-behave-divi-pd]
   [I-D.murakami-softwire-4rd] [I-D.mrugalski-dhc-dhcpv6-4rd].

   In particular the architecture of shared IPv4 address by distributing
   the port space is described in [RFC6346].  The corresponding stateful
   solution DS-lite is described in [RFC6333]

   Requirements and deployment considerations are documented in appendix
   A to C. These are kept in the document for informational purposes for
   now, but are in no way to be considered normative.



Troan                    Expires April 26, 2012                 [Page 4]

Internet-Draft                     MAP                      October 2011


2.  Conventions

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in RFC 2119 [RFC2119].


3.  Terminology

   MAP domain:           A set of MAP CEs and BRs connected to the same
                         virtual link.  A service provider may deploy a
                         single MAP domain, or may utilize multiple MAP
                         domains.
   MAP Rule              A set of parameters describing the mapping
                         between an IPv4 prefix, IPv4 address or shared
                         IPv4 address and an IPv6 prefix or address.
                         Each MAP node in the domain has the same set of
                         rules.
   MAP Border Relay (BR):  A MAP enabled router managed by the service
                         provider at the edge of a MAP domain.  A Border
                         Relay router has at least an IPv6-enabled
                         interface and an IPv4 interface connected to
                         the native IPv4 network.  A MAP BR may also be
                         referred to simply as a "BR" within the context
                         of MAP.
   MAP Customer Edge (CE):  A device functioning as a Customer Edge
                         router in a MAP deployment.  In a residential
                         broadband deployment, this type of device is
                         sometimes referred to as a "Residential
                         Gateway" (RG) or "Customer Premises Equipment"
                         (CPE).  A typical MAP CE adopting MAP rules
                         will serve a residential site with one WAN side
                         interface, one or more LAN side interfaces.  A
                         MAP CE may also be referred to simply as a "CE"
                         within the context of MAP.
   Shared IPv4 address:  An IPv4 address that is shared among multiple
                         CEs.  Each node has a separate part of the
                         transport layer port space; denoted as a port
                         set.  Only ports that belong to the assigned
                         range can be used for communication.
   End user IPv6 prefix: The IPv6 prefix assigned to an End user CE by
                         other means than MAP itself.
   MAP IPv6 address:     The IPv6 address used to reach the MAP function
                         of a CE from other CE's and from BR's.







Troan                    Expires April 26, 2012                 [Page 5]

Internet-Draft                     MAP                      October 2011


   Port-set ID (PSID):   Algorithmically identifies a set of ports
                         exclusively assigned to the CE.
   Rule IPv6 prefix:     An IPv6 prefix assigned by a Service Provider
                         for a mapping rule.
   Rule IPv4 prefix:     An IPv4 prefix assigned by a Service Provider
                         for a mapping rule.
   IPv4 Embedded Address (EA) bits:  The IPv4 EA-bits in the IPv6
                         address identify an IPv4 prefix/address (or
                         part thereof) or a shared IPv4 address (or part
                         thereof and a port set identifier.


4.  Mapping Rules

   A MAP node is provisioned with one or more mapping rules.

   Mapping Rules consists of the following items:
   o  Rule IPv6 prefix
   o  Rule IPv4 prefix
   o  Port set parameters

   Mapping rules are used somewhat differently depending on its
   function.  Every MAP node must be provisioned with a Basic mapping
   rule.  This is used by the node to map from an end-user IPv6 prefix
   to an IPv4 prefix, address or shared IPv4 address.  This same basic
   rule can also be used for forwarding (either encapsulation or
   translation), where an IPv4 destination address and optionally a
   destination port is mapped into an IPv6 address or prefix.
   Additional mapping rules can be specified to allow for e.g. multiple
   different IPv4 subnets to exist within the domain.  Additional
   mapping rules are recognized by having a Rule IPv6 prefix different
   from the base End user IPv6 prefix.

   Traffic outside of the domain (IPv4 address not matching (using
   longest matching prefix) any Rule IPv4 prefix in the Rules database)
   will be forward using the Default Rule.  The Default Rule maps
   outside destinations to the BR's IPv6 address or prefix.

4.1.  Port mapping algorithm

   Note that various algorithms have been proposed to encode the port
   set.  The effort to reach consensus on a port indexing algorithm
   meeting the requirements listed in the Requirements section is
   ongoing.

   The simplest port mapping algorithm one could imagine would be a
   simple CIDR style prefix.  E.g. define a /6 worth of port space (out
   of the total 16 bits), giving the user 1024 ports.  The issue with



Troan                    Expires April 26, 2012                 [Page 6]

Internet-Draft                     MAP                      October 2011


   that scheme is that it does not exclude the well known ports
   (0-1023).  In a deployment where IPv6 address planning is independent
   of IPv4 address planning, that would result in some users being
   assigned that port space.  To avoid that, Remi Despres invented a
   clever algorithm shown below.  This algorithm uses an "infix" instead
   of a "prefix.  By requiring that the 'Y' field (the first 6 bits) are
   larger then 0, results in all well known ports being excluded, while
   still sharing the ports fairly among all users.



                        |  Port range (16 bits)   |
                        +-------------------------+
                        | YYYY YY | P S I D  | XX |
                        +-------------------------+
                        |  Y > 0  |

                                 Figure 1

4.2.  Basic mapping rule - IPv4 address and port assignment



    |     n bits         | o bits  |  m bits   |   128-n-o-m bits      |
    +--------------------+---------+-----------+------------+----------+
    | Domain IPv6 prefix | EA bits | subnet ID |     interface ID      |
    +--------------------+---------+-----------+-----------------------+
    |<---IPv6 delegated prefix --->|


                                 Figure 2

   The first half of the EA bits contain the IPv4 address, prefix or
   IPv4 suffix.  The second half of the EA bits, in the case of a shared
   IPv4 address contains the PSID.



        |   r bits    |        p bits       |         |   q bits   |
        +-------------+---------------------+         +------------+
        | IPv4 prefix | IPv4 Address suffix |         |Port Set ID |
        +-------------+---------------------+         +------------+


                                 Figure 3

   To create a complete IPv4 address, the IPv4 address suffix from the
   EA bits, are concatenated with a provisioned IPv4 prefix.



Troan                    Expires April 26, 2012                 [Page 7]

Internet-Draft                     MAP                      October 2011


   The PSID bits are not a prefix, but an infix.  And is used to create
   a port range.



                        |  Port range (16 bits)   |
                        +-------------------------+
                        | YYYY YY | P S I D  | XX |
                        +-------------------------+
                        |  Y > 0  |


                                 Figure 4

4.3.  Forwarding mapping rule - from address and port to IPv6 address



    |        32 bits           |         |    16 bits        |
    +--------------------------+         +-------------------+
    | IPv4 destination address |         |  IPv4 dest port   |
    +--------------------------+         +-------------------+

    |       p bits     |                 |   q bits   |
    +------------------+                 +------------+
    | IPv4 addr suffix |                 |Port Set ID |
    +------------------+                 +------------+


    |     n bits         | o bits  |  m bits   |   128-n-o-m bits      |
    +--------------------+---------+-----------+------------+----------+
    | Domain IPv6 prefix | EA bits | subnet ID |     interface ID      |
    +--------------------+---------+-----------+-----------------------+
    |<---IPv6 delegated prefix --->|


                                 Figure 5

4.4.  Default mapping rule - from address and port to BR

   TBD


5.  Use of the IPv6 Interface identifier

   In an encapsulation solution, an IPv4 address and port is mapped to
   an IPv6 address.  This is the address of the tunnel end point of the
   receiving MAP CE.  For traffic outside the MAP domain, the IPv6



Troan                    Expires April 26, 2012                 [Page 8]

Internet-Draft                     MAP                      October 2011


   tunnel end point address is the IPv6 address of the BR.  As long as
   the interface-id is well known or provisioned and the same for all
   MAP nodes, it can be any interface identifier.  E.g. ::1.

   When translating the destination IPv4 address is translated into a
   corresponding IPv6 address.  In the case of traffic outside of the
   MAP domain, it is translated to the BR's IPv6 prefix.  For the BR to
   be able to reverse the translation, the full destination IPv4 address
   must be encoded in the IPv6 address.  There are multiple proposals
   for how to encode the IPv4 address, and if also the destinatino port
   or PSID should also be included.  A couple of the proposals are shown
   in the figure below.

   Note: The encoding of the full IPv4 address into the interface
   identifier, both for the source and destination IPv6 addresses have
   been shown to be useful for troubleshooting.  The format finally
   agreed upon here, will apply for both encapsulation and translation.

   Simple format similar to ISATAP:



                  |   32 bits        |    32 bits       |
                  +------------------+------------------+
                  | 02-00-5E-FE      |  IPv4 address    |
                  +------------------+------------------+


                                 Figure 6

   Parsable format including address length and PSID:



                  <-8-><-------- L>=32 -------><48-L><8->
                  +---+----------------+------+-----+---+
                  | u |  IPv4 address  | PSID |  0  | L |
                  +---+----------------+------+-----+---+


                                 Figure 7


6.  IANA Considerations

   This specification does not require any IANA actions.





Troan                    Expires April 26, 2012                 [Page 9]

Internet-Draft                     MAP                      October 2011


7.  Security Considerations

   There are no new security considerations pertaining to this document.


8.  Contributors

   The members of the MAP design team are:
      Mohamed Boucadair, Gang Chen, Wojciech Dec, Congxiao Bao, Xiaohong
      Deng, Jouni Korhonen, Xing Li, Maoke, Satoru Matsushima, Tomasz
      Mrugalski, Jacni Qin, Qiong Sun, Tina Tsou, Dan Wing, Leaf Yeh and
      Jan Zorz


9.  Acknowledgements


10.  References

10.1.  Normative References

   [RFC2119]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", BCP 14, RFC 2119, March 1997.

   [RFC6346]  Bush, R., "The Address plus Port (A+P) Approach to the
              IPv4 Address Shortage", RFC 6346, August 2011.

10.2.  Informative References

   [I-D.bcx-address-fmt-extension]
              Bao, C. and X. Li, "Extended IPv6 Addressing for Encoding
              Port Range", draft-bcx-address-fmt-extension-02 (work in
              progress), October 2011.

   [I-D.boucadair-behave-ipv6-portrange]
              Boucadair, M., Levis, P., Grimault, J., Villefranque, A.,
              Kassi-Lahlou, M., Bajko, G., Lee, Y., Melia, T., and O.
              Vautrin, "Flexible IPv6 Migration Scenarios in the Context
              of IPv4 Address Shortage",
              draft-boucadair-behave-ipv6-portrange-04 (work in
              progress), October 2009.

   [I-D.boucadair-dhcpv6-shared-address-option]
              Boucadair, M., Levis, P., Grimault, J., Savolainen, T.,
              and G. Bajko, "Dynamic Host Configuration Protocol
              (DHCPv6) Options for Shared IP Addresses Solutions",
              draft-boucadair-dhcpv6-shared-address-option-01 (work in
              progress), December 2009.



Troan                    Expires April 26, 2012                [Page 10]

Internet-Draft                     MAP                      October 2011


   [I-D.boucadair-softwire-stateless-requirements]
              Boucadair, M., Bao, C., Skoberne, N., and X. Li,
              "Requirements for Extending IPv6 Addressing with Port
              Sets", draft-boucadair-softwire-stateless-requirements-00
              (work in progress), September 2011.

   [I-D.bsd-softwire-stateless-port-index-analysis]
              Boucadair, M., Skoberne, N., and W. Dec, "Analysis of Port
              Indexing Algorithms",
              draft-bsd-softwire-stateless-port-index-analysis-00 (work
              in progress), September 2011.

   [I-D.chen-softwire-4v6-add-format]
              Chen, G. and Z. Cao, "Design Principles of a Unified
              Address Format for 4v6",
              draft-chen-softwire-4v6-add-format-00 (work in progress),
              October 2011.

   [I-D.chen-softwire-4v6-pd]
              Chen, G., Sun, T., and H. Deng, "Prefix Delegation in
              4V6", draft-chen-softwire-4v6-pd-00 (work in progress),
              August 2011.

   [I-D.dec-stateless-4v6]
              Dec, W., Asati, R., Bao, C., Deng, H., and M. Boucadair,
              "Stateless 4Via6 Address Sharing",
              draft-dec-stateless-4v6-04 (work in progress),
              October 2011.

   [I-D.despres-softwire-4rd-addmapping]
              Despres, R., Qin, J., Perreault, S., and X. Deng,
              "Stateless Address Mapping for IPv4 Residual Deployment
              (4rd)", draft-despres-softwire-4rd-addmapping-01 (work in
              progress), September 2011.

   [I-D.despres-softwire-sam]
              Despres, R., "Stateless Address Mapping (SAM) - a
              Simplified Mesh-Softwire Model",
              draft-despres-softwire-sam-01 (work in progress),
              July 2010.

   [I-D.despres-softwire-stateless-analysis-tool]
              Despres, R., "Analysis of Stateless Solutions for IPv4
              Service across IPv6 Networks - A synthetic Analysis Tool",
              draft-despres-softwire-stateless-analysis-tool-00 (work in
              progress), September 2011.

   [I-D.mrugalski-dhc-dhcpv6-4rd]



Troan                    Expires April 26, 2012                [Page 11]

Internet-Draft                     MAP                      October 2011


              Mrugalski, T., "DHCPv6 Options for IPv4 Residual
              Deployment (4rd)", draft-mrugalski-dhc-dhcpv6-4rd-00 (work
              in progress), July 2011.

   [I-D.murakami-softwire-4rd]
              Murakami, T., Troan, O., and S. Matsushima, "IPv4 Residual
              Deployment on IPv6 infrastructure - protocol
              specification", draft-murakami-softwire-4rd-01 (work in
              progress), September 2011.

   [I-D.murakami-softwire-4v6-translation]
              Murakami, T., Chen, G., Deng, H., Dec, W., and S.
              Matsushima, "4via6 Stateless Translation",
              draft-murakami-softwire-4v6-translation-00 (work in
              progress), July 2011.

   [I-D.sun-softwire-stateless-4over6]
              Sun, Q., Xie, C., Cui, Y., Wu, J., Wu, P., Zhou, C., and
              Y. Lee, "Stateless 4over6 in access network",
              draft-sun-softwire-stateless-4over6-00 (work in progress),
              September 2011.

   [I-D.xli-behave-divi]
              Bao, C., Li, X., Zhai, Y., and W. Shang, "dIVI: Dual-
              Stateless IPv4/IPv6 Translation", draft-xli-behave-divi-03
              (work in progress), July 2011.

   [I-D.xli-behave-divi-pd]
              Li, X., Bao, C., Dec, W., Asati, R., Xie, C., and Q. Sun,
              "dIVI-pd: Dual-Stateless IPv4/IPv6 Translation with Prefix
              Delegation", draft-xli-behave-divi-pd-01 (work in
              progress), September 2011.

   [RFC1933]  Gilligan, R. and E. Nordmark, "Transition Mechanisms for
              IPv6 Hosts and Routers", RFC 1933, April 1996.

   [RFC2529]  Carpenter, B. and C. Jung, "Transmission of IPv6 over IPv4
              Domains without Explicit Tunnels", RFC 2529, March 1999.

   [RFC2766]  Tsirtsis, G. and P. Srisuresh, "Network Address
              Translation - Protocol Translation (NAT-PT)", RFC 2766,
              February 2000.

   [RFC3194]  Durand, A. and C. Huitema, "The H-Density Ratio for
              Address Assignment Efficiency An Update on the H ratio",
              RFC 3194, November 2001.

   [RFC4380]  Huitema, C., "Teredo: Tunneling IPv6 over UDP through



Troan                    Expires April 26, 2012                [Page 12]

Internet-Draft                     MAP                      October 2011


              Network Address Translations (NATs)", RFC 4380,
              February 2006.

   [RFC5214]  Templin, F., Gleeson, T., and D. Thaler, "Intra-Site
              Automatic Tunnel Addressing Protocol (ISATAP)", RFC 5214,
              March 2008.

   [RFC5969]  Townsley, W. and O. Troan, "IPv6 Rapid Deployment on IPv4
              Infrastructures (6rd) -- Protocol Specification",
              RFC 5969, August 2010.

   [RFC6052]  Bao, C., Huitema, C., Bagnulo, M., Boucadair, M., and X.
              Li, "IPv6 Addressing of IPv4/IPv6 Translators", RFC 6052,
              October 2010.

   [RFC6146]  Bagnulo, M., Matthews, P., and I. van Beijnum, "Stateful
              NAT64: Network Address and Protocol Translation from IPv6
              Clients to IPv4 Servers", RFC 6146, April 2011.

   [RFC6147]  Bagnulo, M., Sullivan, A., Matthews, P., and I. van
              Beijnum, "DNS64: DNS Extensions for Network Address
              Translation from IPv6 Clients to IPv4 Servers", RFC 6147,
              April 2011.

   [RFC6333]  Durand, A., Droms, R., Woodyatt, J., and Y. Lee, "Dual-
              Stack Lite Broadband Deployments Following IPv4
              Exhaustion", RFC 6333, August 2011.


Appendix A.  Requirements

   This list of requirements for a stateless mapping of address and
   ports solution may not be complete.  The requirements are listed in
   no particular order, and they may be conflicting.

   R-1:   To allow for a single user delegated IPv6 prefix to be used
          for native IPv6 service and for MAP, the representation of an
          IPv4 prefix, address or shared IPv4 address and PSID must be
          efficient.  As an example it must be possible to represent a
          shared IPv4 address and PSID in 24 bits or less.  (Given a
          typical prefix assignment of /56 to the end-user and a MAP
          IPv6 prefix of /32.)
   R-2:   The IPv6 address format and mapping must be flexible, and
          support any placement of the embedded bits from IPv4 prefix/
          address and port set in the IPv6 address.






Troan                    Expires April 26, 2012                [Page 13]

Internet-Draft                     MAP                      October 2011


   R-3:   Algorithm complexity.  The mapping from an IPv4 address and
          port to an IPv6 address is done in the forwarding plane on MAP
          nodes.  It is important that the algorithm is bounded and as
          efficient as possible.
   R-4:   MAP must allow service providers to define their own address
          sharing ratio.  MAP MUST NOT in particular restrict by design
          the possible address sharing ratio; ideally 1:1 and 1:65536
          should be supported.  The mapping must at least support a
          sharing ratio of 64, 1024 ports per end-user.
   R-5:   The mapping may support deployments using differentiated port-
          ranges.  That is, end-users are assigned different sized port-
          ranges and direct communication between MAP CEs are permitted.
   R-6:   The mapping should support differentiated port ranges within a
          single shared IPv4 address. (i.e., be able to assign port
          ranges of different sizes to customers without requiring any
          per customer state to be instantiated in network elements
          involved in data transfer).
   R-7:   The MAP solution should support excluding the well known ports
          0-1023.
   R-8:   It MUST be possible to assign well known ports to a CE.
   R-9:   There must not be any dependency between IPv6 addressing and
          IPv4 addressing.  With the exception where full IPv4 addresses
          or prefixes are encoded.  Then IPv6 prefix assignment must be
          done so that martian IPv4 addresses are not assigned.
   R-10:  The mapping must not require IPv4 routing to be imported in
          IPv6 routing.
   R-11:  The mapping should support legacy RTP/RTCP compatibility.
          (Allocating two consecutive ports).
   R-12:  The mapping may be UPnP 1.0 friendly.  A UPnP client will keep
          asking for the next port (as in current port + 1) a scattered
          port allocation will be more UPnP friendly.
   R-13:  For out of domain traffic the mapping must support embedding a
          full IPv4 address in the IPv6 interface identifier.  This is
          required in the translation case.  It also simplifies pretty
          printing and other operational tools.
   R-14:  For Service Providers requiring to apply specific policies on
          per Address-Family (e.g., IPv4, IPv6), some provisioning tools
          (e.g., DHCPv6 option) may be required to derive in a
          deterministic way the IPv6 address to be used for the IPv4
          traffic based on the IPv6 prefix delegated to the home
          network.
   R-15:  It should/must/may be possible to use the same IPv6 prefix
          (/64) for native IPv6 traffic and MAPed traffic.
   R-16:  When only one single IPv6 prefix is assigned for both native
          IPv6 communications and the transport of IPv4 packets, the
          IPv4-translatable IPv6 prefix MUST have a length less than
          /64.  When distinct prefixes are used, this requirement is
          relaxed.



Troan                    Expires April 26, 2012                [Page 14]

Internet-Draft                     MAP                      October 2011


   R-17:  The same mapping must support both translation and
          encapsulation solutions.


Appendix B.  Deployment considerations

   Regarding MAP solutions, the community has granted to investigate
   encap/decap and translation for different deployment cases.  A new
   designed solutions should not impact customary behavior on existing
   network nodes. below has listed some deployment considerations.

B.1.  Flexible Assigment of Port Range

   Different classes of customers would require port sets of different
   sizes.  In the context of shared IPv4 addresses, some customers would
   be satisfied with an shared IPv4 addresses, while others may need to
   be assigned with a single IPv4 address or delegated with IPv4
   prefixes shorter than 32 bits due to increasing traffic demands.  MAP
   would allow such flexibilities to allocate different port- set sizes
   for satisfy different demands.

B.2.  Traffic Classification

   Usually, ISPs adopt traffic classification to ensure service quality
   for different classes of customers.  This feature is also helpful for
   customer behavior monitoring and security protection. for example,
   DIA (Dedicated Internet Access) has been provided by operators for
   corporations to cater for their Internet communications needs.
   Service is made by means of the edge router features and key systems,
   like ACL(Access List Control) to classify different traffic.  Five
   tuples would be identified from IP header and UDP/TCP header.
   Currently, it is very well supported in IPv4.  Vendors are delivering
   or committed to support that feature for IPv6.  In order to
   facilitating IPv6 deployment, 4v6 solution would support this feature
   on IPv6 plane.

B.3.  Prefix Delegation Deployment

   Prefix delegation is an important feature both for broadband and
   mobile network.  In mobile network, prefix delegation is introduced
   in 3GPP network in Release 10.  The deployment of PD would be
   supported in 4v6 case.  Variable length of IPv6 prefix is assigned to
   CPE for deriving IPv4 information.

B.4.  Coexisting Deployment

   4v6 solutions(i.e. encapsulation and translation) would not only
   coexist with each other, but also can harmonize with other deployment



Troan                    Expires April 26, 2012                [Page 15]

Internet-Draft                     MAP                      October 2011


   cases.  Here lists some coexisting cases.  (Note: more coexisting
   cases are expected to be investigated in future.)

   o Case 1: Coexisting between 4v6 encapsulation and 4v6 translation

   o Case 2: Coexisting between 4v6 translation and NAT64 (Single
   Translation)

   o Case 3: Coexisting between 4v6 solutions and SLAAC

B.5.  Friendly to Network Provisioning

   Network management plane normally has an ability to to identify
   different users and the compatible with the address assignment
   techniques in the domain. 4v6 would conform to current practices on
   management plane.  In 3GPP network, for example, only the IPv6 prefix
   is assigned to the devices, used to identify different users.  And
   management plane for one family address is better than two, namely
   the operating platform does not need to manage both IPv4 and IPv6.
   Since only IPv6 prefix is assigned, 4v6 on the management plane is
   naturally conducted only via IPv6.

B.6.  Enable privacy addresses

   User privacy should be taken into account when 4v6 solution is
   deployed.  Some security concern associated with non-changing IPv6
   interface identifiers has been expressed in RFC4941[RFC4941].
   Ability to change the interface identifier over time makes it more
   difficult for eavesdroppers and other information collectors to
   identify when different addresses used in different sessions actually
   correspond to the same node.

B.7.  Facilitating 4v6 Service

   Some ISPs may need to offer services in a 4v6 domain with a shared
   address, e.g. 4v6 node hosts FTP server.  The service provisioning
   may require well-know port range(i.e. port range belong to 0-1023).
   MAP would provide operators with possibilities to generate a port
   range including the 0-1023.  Afterwards, operators could decide to
   assign it to any requesting user.

B.8.  Independency with IPv6 Routing Planning

   The IPv6 routing is easier to plan if it's not impacted by the
   encoded IPv4 or port ID information.  MAP would prohibit IPv4 routing
   imported in IPv6.





Troan                    Expires April 26, 2012                [Page 16]

Internet-Draft                     MAP                      October 2011


B.9.  Optimized Routing Path

   MAP could achieve optimized routing path both for hub case and mesh
   case.  Traffic in hub and spoke case could follow asymmetric routing,
   in which incoming routes would not be binded to a given border point
   but others geographically closed to traffic initiators.  In mesh
   cases, traffic between CPEs could directly communicate without going
   through remote border point.


Appendix C.  Guidelines for Operators

C.1.  Terms

   4pfx                  the index for an IPv4 prefix.
   ug-octet              the octet consisting of 64-71 bits in the IPv6
                         address, containing the bits u and g defined by
                         EUI-64 standard.
   Common prefix         an aggregate decided by a domain for the MAP
                         deployment.  It is a subset of the operator's
                         aggregates by its RIR or provider.
   IPv4 suffix           the part of IPv4 address bits used for
                         identifying CEs.
   Host suffix           the IPv6 suffix assigning to an end system.
                         NOTE: it doesn't mean this should be really
                         configured on a certain interface of a host.
   MAP format            the address mapping format defined by this
                         document.
   RFC6052 format        the address mapping format defined by [RFC6052]
                         and its succeeding extensions (or updates) for
                         port-space sharing

C.2.  Understanding address formats: their difference and relevance

   It is important for an operator to understand what the MAP is
   designed for and where it could be applied.

   MAP introduces an address format of embedding IPv4 information to
   IPv6 address.  On the other hand, we also have [RFC6052] defines an
   address format with the similar property.  With extending port-set
   id, it can also support address sharing among different CEs
   [I-D.xli-behave-divi].  What are their differences and relations?

   We present a common abstract format for them both, as is depicted in
   Fig.A-1.  For the easy expression, we exclude the ug-octet, which is
   not concerned in this appendix.





Troan                    Expires April 26, 2012                [Page 17]

Internet-Draft                     MAP                      October 2011


       |<----- 120 bits (IPv6 address excluding ug-octet) --------->|
       +-------------+------+-------------+------+-----------//-----+
       |Common Prefix| 4pfx | IPv4 suffix | PSID | Host Suffix      |
       +-------------+------+-------------+------+-----------//-----+

          Figure C-1. Abstract view of MAP and RFC6052 formats


                                 Figure 8

   Only two parts in Fig.A-1 are different for MAP and RFC6052 formats.
   We compare them in Fig.A-2 and following paragraphs.



           +----------------+--------------+------------+
           |                |  MAP         | RFC6052    |
           +----------------+--------------+------------+
           | from IPv4      | coding with  | same, w/o  |
           | prefix to 4pfx | compression  | change     |
           +----------------+--------------+------------+
           | Host           | full v4.addr | padding to |
           | Suffix         | or 4rd IID   | zero       |
           +----------------+--------------+------------+

           Figure A-2. Difference between MAP and RFC6052 formats

                                 Figure 9

   This comparison clarifies that the major role of full IPv4 address
   embedded in the RFC6052 format is replaced by the MAP's coded IPv4
   prefix index and the uncoded IPv4 suffix.  The following Fig.A-3
   illustrates this relationship.


















Troan                    Expires April 26, 2012                [Page 18]

Internet-Draft                     MAP                      October 2011


          (delegated prefix in RFC6052 format, w/o rule)
          +-------------+-------------+-------------+------+
          |Common Prefix| full IPv4 address (32bit) | PSID |
          +-------------+-------------+-------------+------+
                        :             :             :      :
                        +-------------+-------------+
               32 bits: | 4pfx        | IPv4 suffix |      :
                        +-------------+-------------+      +
                        :           .             .      .
                        :         .             .      .
                        :       .             .      .
                        +-----+-------------+      +
                m bits: |4pfx | IPv4 suffix |      :    (w/ rules)
                        +-----+-------------+
                        :     :             :      :
          +-------------+-----+-------------+------+
          | Rule IPv6 Prefix  |    CE index        |
          +-------------+-----+-------------+------+
          (delegated prefix in MAP format)

          Fig.A-3. Relevance between MAP and RFC6052 formats


                                 Figure 10

   Why is it needed to code the IPv4 prefix?

   Precisely speaking, it is not "to compress the IPv4 prefix" but "to
   establish correspondence between IPv6 delegated prefixes and the
   residual IPv4 prefixes."

   MAP is designed for IPv4 residual deployment, which refers to
   efficiently applying residual (not-yet-assigned) IPv4 addresses in
   response to IPv4 communication demands of the IPv6 network in
   deployment.  Therefore, the delegated CE prefixes are determined
   prior to finding proper IPv4 address blocks in hand to be mapped to
   the CE index and the IPv4 prefix index as well as the Rule IPv6
   prefix, respectively.

   Because the IPv6 delegation planning is independent of the IPv4
   addressing, the /64 prefix is a canonical configuration for all IPv6
   local network.  It is highly impossible to directly match some IPv4
   prefixes to the already-determined IPv6 prefixes, and therefore the
   prefixes have to be coded and typically it is a compression.

   If we have a short-enough Common Prefix, it is also possible to
   deploy a direct matching where 4pfx is equal to IPv4 prefix.  Only in
   this case, the MAP format is as same as the RFC6052 format and the



Troan                    Expires April 26, 2012                [Page 19]

Internet-Draft                     MAP                      October 2011


   rule set could be simplified to a unique rule for 0.0.0.0/0.

   Why does MAP copy IPv4 address in the suffix?

   The full IPv4 address copied in the suffix plays auxiliary roles.

   Although the compression makes full IPv4 address not directly appear
   in the IPv6 address, the delegated prefix is sufficient to extract
   the corresponding IPv4 address for the CE.  However, this relies on
   the distribution of rules.  Embedding the full IPv4 address again in
   the suffix helps simple processing at IPv6-to-IPv4 translator when
   utilizing MAP for double translation.  It also helps in setting
   filters at middle boxes, with exposing the IPv4 full addresses
   dispatched to the CEs.

   Although MAP is designed for the residual deployment, it is also
   suitable for the objective of providing stateless encapsulation or
   double translation for the ever deployed IPv4 networks whose provider
   backbone has upgraded to IPv6.  However, unlike the residual
   deployment, the latter case needs to introduce IPv4 routing entropy
   into the IPv6 routing infrastructure.

C.3.  A generic logic of working with MAP

   This section illustrate how we can use MAP in the operation of
   residual deployment.  It starts from IPv6 address planning.

   (A) IPv6 considerations (A1) Determine the maximum number N of CEs to
   be supported, and, for generality, suppose N = 2^n.  (A2) Choose the
   length x of IPv6 prefixes to be assigned to ordinary customers (e.g.,
   x = 60).  (A3) Multiply N by a margin coefficient K, a power of two
   (K = 2 ^ k), to take into account that: - Some privileged customers
   may be assigned IPv6 prefixes of length x', shorter than x, to have
   larger addressing spaces than ordinary customers, both in IPv6 and
   IPv4. - Due to the hierarchy of routable prefixes, many theoretically
   delegatable prefixes may not be actually delegatable (ref: host
   density ratio of [RFC3194]).  (B) IPv4 considerations (B1) List all
   (non overlapping, not yet assigned to any in-running networks) IPv4
   prefixes Hi that are available for IPv4 residual deployment.  (B2)
   Take enough of them, among the shortest ones, to get a total space
   whose size M is a power of two (M = 2 ^ m), and includes a good
   proportion of the available IPv4 space.  If the M < N, addresses
   should be shared by N CEs and thus each is shared by N/M = 2^(n - m)
   CEs with PSID length of (n - m).  (B3) For each IPv4 prefix Hi of
   length hi, choose a "rule index", i.e., the 4pfx in Fig.C-1 and
   Fig.C-3, say Ri of length ri = m - (32 - hi).  All these indexes must
   be non overlapping prefixes (e.g. 0, 10, 110, 111 for one /10, one
   /11, and two /12).  (C) After (A) and (B), deriving the rule(s) (C1)



Troan                    Expires April 26, 2012                [Page 20]

Internet-Draft                     MAP                      October 2011


   Derive the length c of the "Common prefix" C that will appear at the
   beginning of all delegated prefixes (c = x - (n + k)).  (C2) Take any
   prefix for this C of length c that starts with a RIR-allocated IPv6
   prefix.  (C3) For each IPv4 prefix Hi, make a rule, in which the key
   is Hi, and the value is the Common prefix C followed by the Rule
   index Ri.  Then this i-th rule's Rule IPv6 Prefix will have the
   length of (c + ri).

   If different sharing ratio is expected, we may partition all CEs into
   subsets and do (A) and (B) for each subset, determining the PSID
   length for them separately.

   NOTE: Applying MAP for the operation other than residual deployment
   (e.g., the IPv6 mapping for already-deployed old IPv4 CEs and
   subnets) can reference the above text but please pay attention to the
   differences in prerequisites and demands.  The condition for the
   deployment feasibility is possibly different.


Author's Address

   Ole Troan (editor)
   cisco
   Oslo
   Norway

   Email: ot@cisco.com
























Troan                    Expires April 26, 2012                [Page 21]

